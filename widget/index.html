<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP首页</title>
    <link rel="stylesheet" type="text/css" href="./css/aui.css" />
    <link rel="stylesheet" type="text/css" href="./css/loading.css" />
</head>
<style type="text/css">
    .full{
        background: url('./image/load2.png') no-repeat #e74c3c;
        background-position: center;
        height: 100%;
        width: 100%;
    }
</style>
<body>
    <div id="chartBox" class="aui-col-xs-12 full";>
        <div style="text-align: center;padding-top: 200px;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p style="color:black">系统配置中</p>
            <p style="padding-top:50px; color:black"  id="reLoad"></p>
        </div>
    </div>
</body>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/mis.js"></script>
<script type="text/javascript">
var jumpUrl;
var loadTime = -1;
var addLoadTimeObj,checkLoadTimeObj;
//$api.setStorage('hasLogin', '0');
function addLoadTime(){
    loadTime ++;
    $api.html($api.byId('reLoad'), '用时'+loadTime+'秒');
}
function checkLoadTime(){
    if(loadTime >=5){
        $api.html($api.byId('reLoad'), '<div class="aui-btn aui-btn-dark" onclick="reLoad()">点击重新加载</div>');
        clearInterval(checkLoadTimeObj);
        clearInterval(addLoadTimeObj);
        loadTime = -1;
    }
}
function reLoad(){
     loadTime = 0;
     $api.html($api.byId('reLoad'), '用时'+loadTime+'秒');
    checkLanuch();
}
function ceshi(systemStatus){
    $api.setStorage('missionDay', '2017-10-11');
    if(systemStatus == 0){
        $api.setStorage('hasLogin', 0);
        $api.setStorage('hasSaoma', 0);
        $api.setStorage('lanuchCheckStr', '');
        $api.setStorage('shebeiType', '');
        $api.setStorage('shebeiId', '');
    }else{
        // //alert($api.getStorage('hasLogin'));
        // $api.setStorage('hasSaoma', '1');
        // $api.setStorage('todayNum', 0);
        // $api.setStorage('kaoqinId', 1);

    }
}
function checkLanuch(){
    addLoadTimeObj = setInterval("addLoadTime()",1000);
    checkLoadTimeObj = setInterval("checkLoadTime()",1000);
    var lanuchCheckStr,missionDay;
    if($api.getStorage('lanuchCheckStr')){
        lanuchCheckStr = $api.getStorage('lanuchCheckStr');
    }else{
        lanuchCheckStr = '';
    }
    if($api.getStorage('missionDay')){
        missionDay = $api.getStorage('missionDay');
    }else{
        missionDay = '';
    }
    api.ajax({
        url: appUrl+'Get/checkLanuch',
        method: 'post',
        data: {
            values: {
                name: 'haha'
            }
        }
    },function(ret, err){
        if (ret) {
            var realLanuchStr = ret.lanuch.lanuch_check_str;
            var realMissionDay = ret.mission_day;
            if(missionDay != realMissionDay){
                $api.setStorage('missionDay', realMissionDay);
            }
            if(lanuchCheckStr != realLanuchStr){
                jumpUrl = 'lanuch';
                $api.setStorage('lanuchCheckStr', realLanuchStr);
                jumpTo(jumpUrl);
            }else{
                checkLogin()
            }
        } else {
            api.toast({
                msg: '网络异常！请检查你的网络配置',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
//检测用户是否登录
function checkLogin(){
    if($api.getStorage('hasLogin') == null || $api.getStorage('hasLogin') == 0){
        jumpUrl = 'login';
        jumpTo(jumpUrl);
    }else{
        var shebeiType = parseInt($api.getStorage('shebeiType'));
        if(shebeiType == 9){
            var userType = $api.getStorage('userType');
            var userTel = $api.getStorage('userTel');
            var companyHaoma = $api.getStorage('companyHaoma');
            var ajPushCode = userTel + companyHaoma;
            jumpUrl = $api.getStorage('userTypeUrl');
            jumpTo(jumpUrl);
        }else{
            checkShebei();
        }
    }
}
function checkShebei(){
    //alert($api.getStorage('dataId'))
    var dataId = $api.getStorage('dataId');
    var shebeiId = $api.getStorage('shebeiId');
    api.ajax({
        url: appUrl+'Get/checkShebei',
        method: 'post',
        data: {
            values: {
                data_id: dataId
            }
        }
    },function(ret, err){
        if (ret) {
            //alert(shebeiId + '-' + ret.shebei_id);
            if(ret.shebei.shebei_id == shebeiId){
                jumpUrl = 'houqin';
            }else{
                $api.setStorage('hasLogin', 0);
                $api.setStorage('lanuchCheckStr', '');
                $api.setStorage('shebeiType', '');
                $api.setStorage('shebeiId', '');
                alert('你的设备信息与后台配置不符！');
                jumpUrl = 'login';
            }
            jumpTo(jumpUrl);
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
//根据登录用户的类型，打开相对应的用户主界面
function jumpTo(jumpUrl){
    var openWinName = jumpUrl + '_win';
    var openUrl = './' + jumpUrl + '/index.html';
    //openUrl = './jingli/index.html';
    api.openWin({
        name: openWinName,
        url: openUrl,
        slidBackEnabled:false,
        bounces: false,
        pageParam: {key : 'value'}
    });
}

function checkRun(){
    api.addEventListener({
        name: 'keyback'
    }, function(ret, err){

    });
    api.addEventListener({
        name:'offline'
    }, function(ret, err){
        $api.setStorage('offline', '1');
        api.toast({
            msg: '检测到你的网络异常，请检查',
            duration: 2000,
            location: 'bottom'
        });
    });
    api.addEventListener({
        name:'online'
    }, function(ret, err){
        //alert($api.getStorage('offline'))
        if($api.getStorage('offline') == 1){
            $api.setStorage('offline', '1');
            api.toast({
                msg: '亲！你重新连上网络了',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
    api.addEventListener({
        name:'pause'
    }, function(ret, err){
        var thisDate = new Date();
        var thisTime = thisDate.getTime();
        //alert(myDate);
        $api.setStorage('pauseTime', thisTime);

    });
    api.addEventListener({
        name:'resume'
    }, function(ret, err){
        var pauseTime = $api.getStorage('pauseTime');
        var backTime = new Date().getTime();
        var chaSecond = (backTime - pauseTime)/1000;
        //alert(pauseTime + '-' + backTime);
        //alert(chaTime);
        var setSecond = 60;
        if(chaSecond > setSecond){
            //alert('你离线太久，请重新登陆');
            api.rebootApp();
        }else{

        }
        //alert('应用在后台逗留时间为' + chaTime + '毫秒');
    });
}
function checkCompanySystemIp(){
    //alert($api.getStorage('companySystemIp'))
    if($api.getStorage('companySystemIp')){
      checkLanuch();
    }else{
        jumpTo('login');
    }
}
apiready = function(){
    checkRun();
    checkCompanySystemIp();
    // api.openWin({
    //     name: 'winName',
    //     url: './html/main.html',
    //     pageParam: {
    //         name: 'value'
    //     }
    // });
    //jumpTo('UPLOAD')
}
</script>
</html>
