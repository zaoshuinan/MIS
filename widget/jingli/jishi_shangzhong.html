<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 2px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
</style>
<body>
    <div class="aui-content-padded icons">
        <div class="aui-grid-nine"  id="viewBox">

        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/laytpl.js" ></script>
<script type="text/javascript">
var jishiStatus,jishiJson,dingdanId,jishiIdStr,jishiTichengStr,tichengJson,jishiJson;
var selectJishiId,selectJishiPaihao,selectJishiTicheng,selectJishiImgUrl,selectRoomHaoma,companyId,fuwuName,yingxuanPaihao;
var userId = $api.getStorage('userId');
var banciJson = $api.getStorage('cacheBanci');
function selectJishi(index,jishiId,jishiPaihao,jishiImgUrl){
    selectJishiImgUrl = jishiImgUrl;
    selectJishiId = jishiId;
    selectJishiPaihao = jishiPaihao;
    selectJishiTicheng = tichengJson[jishiId];
    if(index == 0){
        api.actionSheet({
            title: '选择技师',
            buttons: ['确定选择该技师']
        },function(ret,err){
            //alert(selectJishiTicheng +'-'+ selectJishiId + '-'+selectJishiPaihao);
            if(ret.buttonIndex == 1){
                api.sendEvent({
                    name: 'showJishiPaihao',
                    extra: {
                        'jishiId':selectJishiId,
                        'jishiTicheng':selectJishiTicheng,
                        'jishiPaihao':selectJishiPaihao,
                        'jishiImgUrl':selectJishiImgUrl,
                        'dingdanDefault':1,
                        'yingxuanPaihao':yingxuanPaihao
                    }
                });
                api.closeWin();
            }
        });
    }else{
        api.confirm({
            title: '确认信息',
            msg: '你选择的技师不是默认排位选择对象，你的选择将被记录，你确认选择该技师吗？',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1){
                    //alert(yingxuanPaihao);
                    api.actionSheet({
                        title: '选择技师',
                        buttons: ['确定选择该技师']
                    },function(ret,err){
                        //alert(selectJishiTicheng +'-'+ selectJishiId + '-'+selectJishiPaihao);
                        if(ret.buttonIndex == 1){
                            api.sendEvent({
                                name: 'showJishiPaihao',
                                extra: {
                                    'jishiId':selectJishiId,
                                    'jishiTicheng':selectJishiTicheng,
                                    'jishiPaihao':selectJishiPaihao,
                                    'jishiImgUrl':selectJishiImgUrl,
                                    'dingdanDefault':0,
                                    'yingxuanPaihao':yingxuanPaihao
                                }
                            });
                            api.closeWin();
                        }
                    });
                }
            }
        });
    }
    
}
function creatJson(){
    jishiIdArr = jishiIdStr.split(',');
    jishiTichengArr = jishiTichengStr.split(',');
    jsonStr = '{';
    for(var i = 0;i < jishiIdArr.length;i++){
        if(i != 0){
            jsonStr += ',';
        }
        jsonStr += '"'+jishiIdArr[i]+'":"'+jishiTichengArr[i]+'"';
    }
    jsonStr += '}';
    return JSON.parse(jsonStr);
}
function shuaxin(){
    api.setRefreshHeaderInfo({
        visible: true,
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#ccc',
        textColor: '#fff',
        textDown: '下拉刷新...',
        textUp: '松开刷新...',
        showTime: true,
    }, function(ret, err){
        getPageJson();
        //从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        api.refreshHeaderLoadDone();
    });
}
function getPageJson(){
    api.ajax({
        url: appUrl+'Get/jishiJson',
        method: 'post',
        data: {
            values: { 
                jishi_id_str: jishiIdStr
            },
            files: { 
                file: 'fs://a.gif'
            }
        }
    },function(ret, err){
        if (ret) {
            if(ret.has == 1){
                jishiJson = ret.data;
                insertSort(jishiJson)
                buildPage();
            }
        } else {
            //alert( JSON.stringify( err ) );
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
function insertSort(array){
    /*start根据已排列好的项数决定*/
    var start=1;
    /*按顺序，每一项检查已排列好的序列*/
    for(var i=start; i<array.length; start++,i++){
      /*跟已排好序的序列做对比，并插入到合适的位置*/
      for(var j=0; j<start; j++){
        /*小于或者等于时（我们是升序）插入到该项前面*/
        if(array[i].jishi_status<array[j].jishi_status){
          //console.log(array[i]+' '+array[j]);
          if(array[i].jishi_status !=0){
                array.splice(j,0,array[i]);
                /*删除原有项*/
                array.splice(i+1,1);
                break;
          }
        }
      }
    }
  }
function downByStatusAndTimeDesc(x,y){
    var xTemp =  x.jishi_status + x.xiazhong_time;
    var yTemp =  y.jishi_status + y.xiazhong_time;
    return (xTemp < yTemp) ? 1 : -1
}
function buildPage(){
    $api.html($api.byId('viewBox'), '<p style="margin-top:10px;" class="aui-text-center">加载数据中......</p>');
    var innerStr = '';
    var imgArr = new Array();
    for(var i = 0;i < jishiJson.length;i++){

        var thisJishiJson = jishiJson[i];
        var jishiImgUrl;
        if(thisJishiJson.jishi_touxiang_url == ''){
            jishiImgUrl = '../image/jishi.png';
        }else{
            jishiImgUrl = ipUrl + thisJishiJson.jishi_touxiang_url;
        }
        imgArr[i] = jishiImgUrl;
        var bgCss = '';
        var textStyle = '';
        var jishiId = thisJishiJson.id;
        var jishiPaihao = thisJishiJson.jishi_paihao;
        if(i == 0){
            yingxuanPaihao = jishiPaihao;
            bgCss = ' aui-bg-default';
        }
        var jishiStatus = thisJishiJson.jishi_status;
        var jishiDayNum = thisJishiJson.jishi_day_num;
        var kaoqinTime = thisJishiJson.jishi_kaoqin_time;
        var shangzhongTime = thisJishiJson.jishi_start_time;
        var xiazhongTime = thisJishiJson.jishi_end_time;
        var roomName = thisJishiJson.jishi_room_name;
        var statusStr = '<p class="aui-text-info">未知<br>未知</p>';
        var jishiBanciId = thisJishiJson.jishi_banci_id;
        var clickStr = '';
        if(jishiBanciId == 0){
            var banciName = '未设置班次';
            var kaoqinTimeStr = '请钟房进行设置';
            var tempStr = banciName+'<br>';
        }else{
            var banciName = banciJson[jishiBanciId].banci_name;
            var banciBeginHour = banciJson[jishiBanciId].banci_begin_hour;
            var banciBeginMin = banciJson[jishiBanciId].banci_begin_min;
            if(parseInt(banciBeginHour) < 10){
                banciBeginHour = '0' + banciBeginHour;
            }
            if(parseInt(banciBeginMin) < 10){
                banciBeginMin = '0' + banciBeginMin;
            }
            var kaoqinTimeStr = banciBeginHour+'时'+banciBeginMin+'分考勤'
            var tempStr = banciName+':未上班<br>';
        }
        if(jishiStatus == 0){
            statusStr = '<p class="aui-text-info">'+ tempStr +kaoqinTimeStr +'</p>'
        }
        if(jishiStatus == 1){
            if(xiazhongTime == '0000-00-00 00:00:00'){
                var daizhongStr = '考勤时间：' + kaoqinTime.substr(11,5);
            }else{
                var daizhongStr = '下钟时间：' + xiazhongTime.substr(11,5);
            }
            if(i == 0){
                var thisCss = 'aui-text-danger';
            }else{
                var thisCss = 'aui-text-primary';
            }
            statusStr = '<p class="'+thisCss+'"'+textStyle+'>'+banciName+':上班待钟<br>'+daizhongStr+'</p>';
            clickStr = ' tapmode onclick="selectJishi(' + i + ','+jishiId+',\''+jishiPaihao+'\',\''+jishiImgUrl+'\')"';
        }
        if(jishiStatus == 4){
            statusStr = '<p class="aui-text-warning">'+roomName+'房上钟<br>下钟时间：'+xiazhongTime.substr(11,5)+'</p>'
        }
        if(jishiStatus == 3){
            statusStr = '<p class="aui-text-blue">已通知钟房<br>正前往会客</p>'
        }
        var thisStr = '<li class="aui-col-xs-6 aui-text-center'+bgCss+'"'+clickStr+'><img id="img'+i+'" style="width:80px;height:80px;border-radius: 50%;" src="'+jishiImgUrl+'"><p class="aui-text-danger" style="font-size:24px">'+jishiPaihao+'号<span style="font-size:12px">('+jishiDayNum+'单)</span></p>'+statusStr+'</li>';
        if(jishiStatus != 0){
            innerStr += thisStr;
        }
    }
    var viewBox = $api.byId('viewBox');
    $api.html(viewBox, innerStr);
    //闭包处理
    for(var j = 0;j<imgArr.length;j++){
        (function(j) {
            var objIdName = 'img' + j;
            //alert('1-'+objIdName)
            var realImgUrl = imgArr[j];
            api.imageCache({
                url: realImgUrl
            }, function(ret, err){
                if( ret ){
                     var cacheUrl = ret.url;
                     $api.attr($api.byId(objIdName), 'src', cacheUrl);
                }
            });
        })(j);
    }
}
function tichengStrToJson(jishiTichengStr){
    jishiTichengArr = jishiTichengStr.split(',');
    var jishiTichengJson = {};
    for(var i = 0; i < jishiTichengArr.length; i++){
        var thisJishiTichengStr = jishiTichengArr[i];
        var thisJishiTichengArr = thisJishiTichengStr.split(':');
        var thijishiId = thisJishiTichengArr[0];
        var thisJishiTicheng = thisJishiTichengArr[1];
        jishiTichengJson[thijishiId] = thisJishiTicheng;
    }
    //alert(JSON.stringify(jishiTichengJson));
    return jishiTichengJson;
}
apiready = function(){
    api.parseTapmode();
    companyId = $api.getStorage('companyId');
    dingdanId = api.pageParam.dingdanId;
    jishiIdStr = api.pageParam.jishiIdStr;
    fuwuName = api.pageParam.fuwuName;
    jishiTichengStr = api.pageParam.jishiTichengStr;
    selectRoomHaoma = api.pageParam.selectRoomHaoma;
    //alert(jishiTichengStr)
    tichengJson = tichengStrToJson(jishiTichengStr);
    jishiStatus = 2;
    getPageJson();
    shuaxin();
}
        
</script>
</html>