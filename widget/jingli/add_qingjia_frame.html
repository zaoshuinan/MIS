<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content" style="padding: 10px;">   
        <p style="margin:10px 0px;" class="padded"></p>    
        <div class="aui-form" style="padding: 10px;">
            <div class="aui-input-row">
                <span class="aui-input-addon" style="color:red">请假起始日期</span>
                <input type="text" class="aui-input" style="color:blue" tapmode onclick="selectDay()" placeholder="点击选择日期" id="dayBox" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon" style="color:red">选择请假天数</span>
                <div class="aui-pull-left" id="qingjiaDayBox">
                    <input class="aui-radio aui-radio-info" type="radio" onclick="changeDayNum(1)" name="dayNum" value="1"> <span class="aui-radio-name">1天</span>
                    <input class="aui-radio aui-radio-success" type="radio" onclick="changeDayNum(2)" name="dayNum" value="2"> <span class="aui-radio-name">2天</span>
                    <input class="aui-radio aui-radio-warning" type="radio" onclick="changeDayNum(3)" name="dayNum" value="3"> <span class="aui-radio-name">3天</span>
                    <input class="aui-radio aui-radio-danger" type="radio" onclick="changeDayNum(4)" name="dayNum" value="4"> <span class="aui-radio-name">4天</span>
                </div>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon" style="color:red">请假原因/备注</span>
                <input type="text" class="aui-input" style="color:blue" placeholder="例假/轮休/病假/事假等等" id="beizhu" value="" />
            </div>
            <p style="padding-top:6px;color:blue">如请假半天，请使用买钟；如实际请假天数较多，请分多次申请</p>
        </div>
        <div class="aui-card" id="qingjiaShow" style="margin-top:20px;padding: 10px;">
            <p style="color: red;font-size:20px">请假日期为</p>
            <p style="padding: 10px;" id="dayButtonBox">请按要求选择操作</p>
        </div>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="checkQingjia()">提交休假申请</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var companyId = $api.getStorage('companyId');
var missionDay = $api.getStorage('missionDay');
var userType = $api.getStorage('userType');
var userId = $api.getStorage('userId');
var userName = $api.getStorage('userName');
var userTel = $api.getStorage('userTel');
var startDay = '';
var beizhu = '';
var dayNum = 0;
function checkQingjia(){
    beizhu = $api.val($api.byId('beizhu'));
    if(startDay == '' || dayNum == 0 || beizhu == ''){
        alert('请将请假信息填写完整');
    }else{
        api.confirm({
            msg: '确定从'+startDay+'日起请假'+dayNum+'天吗？',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1){
                    sendQingjia();
                }
            }
        });
    }
}
function sendQingjia(){
    var valueJson = { 
        company_id:companyId,
        user_type: userType,
        user_id:userId,
        user_name:userName,
        user_tel:userTel,
        jishi_id:0,
        start_day:startDay,
        shichang:dayNum,
        yuanyin:beizhu
    }
    // alert(JSON.stringify(valueJson));
    // return false;
    api.ajax({
        url: appUrl+'Add/newQingjia',
        method: 'post',
        data: {
            values: valueJson
        }
    }, function(ret, err) {
        if (ret) {
            alert('已提交休假申请，请等待管理人员审核批准');
            api.closeWin({
                name: 'addQingjia'
            });
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function changeDayNum(index){
    if(startDay == ''){
        dayNum = 0;
        setTimeout("removeSelect()",10);
        alert('请先选择起始日期');
        return false;
    }else{
        dayNum = index;
        showQingjia();
    }
}
function showQingjia(){
    var innerStr = '';
    for(var i = 0;i < dayNum;i++){
        if(i == 0){
            var thisQingjiaDay = startDay;
        }else{
            var thisQingjiaDay = addDate(startDay,i);
        }
        var thisButtonStr = '<button class="aui-btn aui-btn-danger">'+thisQingjiaDay+'</button>';
        innerStr += thisButtonStr;
    }
    $api.html($api.byId('dayButtonBox'), innerStr);
}
function addDate(date, days) {
    if (days == undefined || days == '') {
        days = 1;
    }
    var date = new Date(date);
    date.setDate(date.getDate() + days);
    var month = date.getMonth() + 1;
    if(month < 10){
        month = '0' + month;
    }
    var day = date.getDate();
    if(day < 10){
        day = '0' + day;
    }
    return date.getFullYear() + '-' + month + '-' + day;
}
function removeSelect(){
    var buttonStr = '<input class="aui-radio aui-radio-info" type="radio" onclick="changeDayNum(1)" name="dayNum" value="1"> <span class="aui-radio-name">1天</span><input class="aui-radio aui-radio-success" type="radio" onclick="changeDayNum(2)" name="dayNum" value="2"> <span class="aui-radio-name">2天</span><input class="aui-radio aui-radio-warning" type="radio" onclick="changeDayNum(3)" name="dayNum" value="3"> <span class="aui-radio-name">3天</span><input class="aui-radio aui-radio-danger" type="radio" onclick="changeDayNum(4)" name="dayNum" value="4"> <span class="aui-radio-name">4天</span>';
    $api.html($api.byId('qingjiaDayBox'), buttonStr);
}
function selectDay(){
    api.openPicker({
        type: 'date',
        date: missionDay,
        title: '选择起始日期'
    }, function(ret, err) {
        if (ret) {
            var selectYear = parseInt(ret.year);
            var selectMonth = parseInt(ret.month);
            var selectDay = parseInt(ret.day);
            if(selectMonth < 10){
                selectMonth = '0' + selectMonth;
            }
            if(selectDay < 10){
                selectDay = '0' + selectDay;
            }
            var selectDayStr = selectYear + '-' + selectMonth + '-' + selectDay;
            //alert(missionDay + selectDayStr)
            var oDate1 = new Date(selectDayStr);
            var oDate2 = new Date(missionDay);
            if(oDate1.getTime() > oDate2.getTime()){
                startDay = selectDayStr;
                $api.val($api.byId('dayBox'), startDay);
            } else {
                alert('选择的起始日期必须大于今天');
                return false;
            }
        } 
    });
}
apiready = function(){
    api.parseTapmode();
}      
</script>
</html>