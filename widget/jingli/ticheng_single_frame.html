<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<style>
html { background: #f7f9f8;}
</style>
<body>
    <p style="font-size: 16px; margin-top:20px;margin-left:16px;">总提成：<b id="tichengTodayAll" class="aui-text-danger">0</b>元(下拉刷新)</p>
    <div id="chartBox" class="aui-col-xs-12"; style="height:220px;margin-top: 20px;">
            <div style="text-align: center;padding: 50px;">
                <div class="loading-2">
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                </div>
                <p>读取数据中....</p>
            </div>
    </div>
    <div class="aui-content-padded icons" style="padding-top: 20px;">
        <ul class="aui-grid-nine" id="viewBox">
            <li class="aui-col-xs-6 aui-text-center" tapmode onclick="openDetail(0)"><img src="../image/yewu1.png" style="width:60px"><p>业务(<b class="aui-text-danger" id="yewuTicheng">0</b>元)</p></li>
            <li class="aui-col-xs-6 aui-text-center" tapmode onclick="openDetail(1)"><img src="../image/yuyue1.png" style="width:60px"><p>预约(<b class="aui-text-danger" id="yuyueTicheng">0</b>元)</p></li>
            <li class="aui-col-xs-6 aui-text-center" tapmode onclick="openDetail(2)"><img src="../image/chongzhi1.png" style="width:60px"><p>充值(<b class="aui-text-danger" id="chongzhiTicheng">0</b>元)</p></li>
            <li class="aui-col-xs-6 aui-text-center" tapmode onclick="openDetail(3)"><img src="../image/xiaoshou1.png" style="width:60px"><p>销售(<b class="aui-text-danger" id="shoufeiTicheng">0</b>元)</p></li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript">
var tichengJson,isToday,showDate;
var yewuArr,yuyueArr,chongzhiArr,shoufeiArr;
var tichengAll = 0;
var tichengAllStr = '';
var yewuIdStr = yuyueIdStr = chongzhiIdStr = shoufeiIdStr = '';
var yewuTicheng = yuyueTicheng = chongzhiTicheng = shoufeiTicheng = 0;
var yewuNum = yuyueNum = chongzhiNum = shoufeiNum = 0;
var userId = $api.getStorage('userId');
var companyId = $api.getStorage('companyId');
var userName = $api.getStorage('userName');
var userTel = $api.getStorage('userTel');
var missionDay = $api.getStorage('missionDay');
function buildChart(){
    var chartBox = $api.byId('chartBox');
    var tongjiChart = echarts.init(chartBox);
    var option = {
        title : {
            text: showDate+'提成分析',
            subtext: '共收入'+tichengAll+'元',
            x:'center'
        },
        tooltip : {
            trigger: 'item',
            formatter: "{a} <br/>{b} : {c} 元({d}%)"
        },
        series : [
            {
                name: '提成比例',
                type: 'pie',
                radius : '70%',
                center: ['50%', '60%'],
                data:[
                    {value:yewuTicheng, name:'业务提成'},
                    {value:yuyueTicheng, name:'预约提成'},
                    {value:chongzhiTicheng, name:'充值提成'},
                    {value:shoufeiTicheng, name:'销售提成'}
                ],
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
        };
    tongjiChart.setOption(option);
}
function openDetail(index){
    var tichengIdStr = '';
    if(index == 0){
        if(yewuTicheng == 0){
            alert('本项没提成');
            return false;
        }else{
            alert('完成'+yewuNum+'单业务')
        }
    }
    if(index == 1){
        if(yuyueTicheng == 0){
            alert('本项没提成');
            return false;
        }else{
            alert('完成'+yuyueNum+'单预约')
        }
    }
    if(index == 2){
        if(chongzhiTicheng == 0){
            alert('本项没提成');
            return false;
        }else{
            alert('完成'+chongzhiNum+'单充值')
        }
    }
    if(index == 3){
        if(shoufeiTicheng == 0){
            alert('本项没提成');
            return false;
        }else{
            alert('完成'+shoufeiNum+'单产品销售')
        }
    }
}
function shuaxin(){
    api.setRefreshHeaderInfo({
        visible: true,
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#ccc',
        textColor: '#fff',
        textDown: '下拉刷新...',
        textUp: '松开刷新...',
        showTime: true,
    }, function(ret, err){
        buildPageByJson();
        //从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        api.refreshHeaderLoadDone();
    });
}
function buildPageByJson(){
    tichengAll = 0;
    tichengAllStr = '';
    yewuIdStr = yuyueIdStr = chongzhiIdStr = shoufeiIdStr = '';
    yewuTicheng = yuyueTicheng = chongzhiTicheng = shoufeiTicheng = 0;
    api.ajax({
        url: appUrl+'Get/todayJingli',
        method: 'post',
        data: {
            values: { 
                user_id: userId,
                user_tel:userTel,
                user_name:userName,
                company_id:companyId,
                mission_day:showDate
            }
        }
    },function(ret, err){
        if (ret) {
                stepNum = 1;
                tichengJson = ret;
                var yewuHas = ret.jingli_liushui_has;
                yewuArr = ret.jingli_liushui_data;
                var yuyueHas = ret.yuyue_has;
                yuyueArr = ret.yuyue_data;
                var chongzhiHas = ret.chongzhi_has;
                chongzhiArr = ret.chongzhi_data;
                var shoufeiHas = ret.shoufei_has;
                shoufeiArr = ret.shoufei_data;
                if(yewuHas != 0){
                    yewuNum = yewuArr.length;
                    for(var i = 0;i < yewuNum;i++){
                        yewuTicheng += parseFloat(yewuArr[i].ticheng);
                        if(yewuIdStr == ''){
                            yewuIdStr = yewuArr[i].id;
                        }else{
                            yewuIdStr += ',' + yewuArr[i].id;
                        }
                    }
                }
                if(yuyueHas != 0){
                    yuyueNum = yuyueArr.length;
                    //alert(JSON.stringify(yuyueArr))
                    for(var j = 0;j < yuyueNum;j++){
                        yuyueTicheng += parseFloat(yuyueArr[j].ticheng);
                        if(yuyueIdStr == ''){
                            yuyueIdStr = yuyueArr[j].id;
                        }else{
                            yuyueIdStr += ',' + yuyueArr[j].id;
                        }
                    }
                }
                if(chongzhiHas != 0){
                    chongzhiNum = chongzhiArr.length;
                    for(var k = 0;k < chongzhiNum;k++){
                        chongzhiTicheng += parseFloat(chongzhiArr[k].ticheng_money);
                        if(chongzhiIdStr == ''){
                            chongzhiIdStr = chongzhiArr[k].id;
                        }else{
                            chongzhiIdStr += ',' + chongzhiArr[k].id;
                        }
                    }
                }
                if(shoufeiHas != 0){
                    shoufeiNum = shoufeiArr.length;
                    for(var l = 0;l < shoufeiNum;l++){
                        shoufeiTicheng += parseFloat(shoufeiArr[l].chanpin_ticheng);
                        if(shoufeiIdStr == ''){
                            shoufeiIdStr = shoufeiArr[l].id;
                        }else{
                            shoufeiIdStr += ',' + shoufeiArr[l].id;
                        }
                    }
                }
                tichengAll = yewuTicheng + yuyueTicheng + chongzhiTicheng + shoufeiTicheng;
                buildPage();
            } else {
                api.toast({
                    msg: '网络错误',
                    duration: 2000,
                    location: 'bottom'
                });
            }
    });
}
function buildPage(){
    buildChart();
    $api.html($api.byId('tichengTodayAll'), tichengAll);
    $api.html($api.byId('yewuTicheng'), yewuTicheng);
    $api.html($api.byId('yuyueTicheng'), yuyueTicheng);
    $api.html($api.byId('chongzhiTicheng'), chongzhiTicheng);
    $api.html($api.byId('shoufeiTicheng'), shoufeiTicheng);
}
apiready = function() {
    isToday = api.pageParam.isToday;
    showDate = api.pageParam.showDate;
    api.parseTapmode();
    buildPageByJson();
    shuaxin();
}
</script>
</html>