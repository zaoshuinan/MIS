<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
</style>
<body>
    <div class="aui-content-padded icons">
        <ul class="aui-grid-nine" id="viewBox">
            <div style="text-align: center;padding: 50px;">
                <div class="loading-2">
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                </div>
                <p>加载数据中</p>
            </div>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var fanweiId,configId,configHang,configLie,roomBoxClass;
var roomArr = new Array();
var companyId = $api.getStorage('companyId');
var missionDay = $api.getStorage('missionDay');
var userId = $api.getStorage('userId');
var userName = $api.getStorage('userName');
var userTel = $api.getStorage('userTel');
var lieZimuArr = ['A','B','C','D','E','F'];
function shuaxin(){
    api.setRefreshHeaderInfo({
        visible: true,
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#ccc',
        textColor: '#fff',
        textDown: '下拉刷新...',
        textUp: '松开刷新...',
        showTime: true,
    }, function(ret, err){
        getData();
        //从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        api.refreshHeaderLoadDone();
    });
}
function getData(){
    api.ajax({
        url: appUrl+'+'Get/roomStatusByJingli',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                room_config_id:configId
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                reBuildData(ret.data);
            }
        } else {
            api.toast({
                msg: '网络出错'
            });
        }
    });
}
function reBuildData(roomJson){
    for(var i = 0;i < roomJson.length;i++){
        var thisRoomArr = new Array();
        var thisRoom = roomJson[i];
        var thisRoomHaoma = thisRoom.room_haoma;
        var thisRoomName = thisRoom.room_name;
        var thisRoomStatus = thisRoom.room_status;
        var thisRoomYichang = thisRoom.yichang;
        var thisRoomId = thisRoom.id;
        thisRoomArr['id'] = thisRoomId;
        thisRoomArr['name'] = thisRoomName;
        thisRoomArr['status'] = thisRoomStatus;
        thisRoomArr['yichang'] = thisRoomYichang;
        roomArr[thisRoomHaoma] = thisRoomArr;
    }
    buildPage();
}
function buildPage(){
    var innerStr = '';
    for(var i = 1;i <= configHang;i++){
        for(var j = 0;j < configLie;j++){
            var thisHaoma = lieZimuArr[j]+i;
            var thisRoomId = roomArr[thisHaoma]['id'];
            var thisRoomName = roomArr[thisHaoma]['name'];
            var thisRoomStatus = roomArr[thisHaoma]['status'];
            var thisRoomYichang = roomArr[thisHaoma]['yichang'];
            var bgClass,statusStr,fnName;
            if(thisRoomName == ''){
                var nameStr = '无';
            }else{
                var nameStr = thisRoomName;
            }
            if(thisRoomYichang == 1){
                bgClass = ' aui-bg-warning';
                statusStr = '<p style="color:red">异常</p>';
                fnName = 'openYichang()';
            }else{
                if(thisRoomStatus == 0){
                    bgClass = ' aui-bg-success';
                    statusStr = '<p style="color:black">空闲房间</p>';
                    fnName = 'openRoom('+thisRoomId+',\''+thisRoomName+'\')';
                }
                if(thisRoomStatus == 1){
                    bgClass = ' aui-bg-danger';
                    statusStr = '<p style="color:black">等待技师</p>';
                    fnName = 'changeRoom('+thisRoomStatus+','+thisRoomId+',\''+thisRoomName+'\')';
                }
                if(thisRoomStatus == 2){
                    bgClass = ' aui-bg-danger';
                    statusStr = '<p style="color:blue">正在服务</p>';
                    fnName = 'changeRoom('+thisRoomStatus+','+thisRoomId+',\''+thisRoomName+'\')';
                }
                if(thisRoomStatus == 3){
                    bgClass = ' aui-bg-info';
                    statusStr = '<p style="color:black">等待清洁</p>';
                    fnName = 'changeRoom('+thisRoomStatus+','+thisRoomId+',\''+thisRoomName+'\')';
                }
                if(thisRoomStatus == 4){
                    bgClass = ' aui-bg-info'
                    statusStr = '<p style="color:blue">正在打扫</p>';
                    fnName = 'changeRoom('+thisRoomStatus+','+thisRoomId+',\''+thisRoomName+'\')';
                }
            }
            //alert(thisRoomName + thisRoomId)
            var thisStr = '<li id="box'+thisRoomId+'" class="'+roomBoxClass+' aui-text-center'+bgClass+'" tapmode onclick="'+fnName+'"><p style="color:black" id="roomName'+thisRoomId+'">'+nameStr+'</p>'+statusStr+'</li>';
            innerStr += thisStr;
        }
    }
    $api.html($api.byId('viewBox'), innerStr);
}
function openYichang(){
    alert('该房间状态为异常，不能使用');
    return false;
}
function changeRoom(roomStatus,roomId,roomName){
    api.confirm({
        msg: roomName + '房间正处在工作状态，确定要恢复到初始状态吗？此操作可能会影响到公司正常运作，需要在稍后输入你的密码，并记录在案，请确认！',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                api.openWin({
                    name: 'resetRoom',
                    url: './reset_room_frame.html',
                    pageParam: {
                        roomId:roomId,
                        roomName:roomName,
                        roomStatus:roomStatus
                    }
                });
            }
        }
    });
}
function openRoom(roomId,roomName){
    if(roomName == ''){
        alert('该房间未配置好');
        return false;
    }else{
        api.actionSheet({
            destructiveTitle: '1人',
            buttons: ['2人','3人','4人']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1 || ret.buttonIndex == 2 || ret.buttonIndex == 3 || ret.buttonIndex == 4){
                    var renNum = ret.buttonIndex;
                    api.confirm({
                        msg: '确定有'+renNum+'位客人到来并开启'+roomName+'房间吗？',
                        buttons: ['确定', '取消']
                    }, function(ret, err) {
                        if (ret) {
                            if(ret.buttonIndex == 1){
                                addNewDingdan(roomId,roomName,renNum);
                            }
                        } 
                    });
                }
            }
        });
    }
}
function addNewDingdan(roomId,roomName,renNum){
    var valueJson = { 
        company_id:companyId,
        mission_day:missionDay,
        ren_num:renNum,
        service_type:fanweiId,
        room_id:roomId,
        room_name:roomName,
        jingli_id:userId,
        jingli_name:userName,
        jingli_tel:userTel
    }
    // alert(JSON.stringify(valueJson))
    // return false;
    api.ajax({
        url: appUrl+'+'Add/newDingdan',
        method: 'post',
        data: {
            values: valueJson
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                alert('已生成订单，请前往订单界面完成进一步操作！');
                api.closeWin({
                    name: 'checkRoom'
                });
            }
            if(ret.has == 0){
                alert('该房间已被其他经理使用，请刷新并重新选择房间');
            }
        } else {
            //alert(JSON.stringify(err));
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
apiready = function(){
    api.parseTapmode();
    fanweiId = api.pageParam.fanweiId;
    configId = api.pageParam.configId;
    configHang = api.pageParam.configHang;
    configLie = api.pageParam.configLie;
    if(configLie == 1){
        roomBoxClass = 'aui-col-xs-12';
    }
    if(configLie == 2){
        roomBoxClass = 'aui-col-xs-6';
    }
    if(configLie == 3){
        roomBoxClass = 'aui-col-xs-4';
    }
    if(configLie == 4){
        roomBoxClass = 'aui-col-xs-3';
    }
    if(configLie == 5){
        roomBoxClass = 'aui-col-5';
    }
    if(configLie == 6){
        roomBoxClass = 'aui-col-xs-2';
    }
    getData();
    shuaxin();
}
        
</script>
</html>