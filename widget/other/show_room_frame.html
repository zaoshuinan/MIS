<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
</style>
<body>
    <div class="aui-content-padded icons">
        <ul class="aui-grid-nine" id="viewBox">
            <div style="text-align: center;padding: 50px;">
                <div class="loading-2">
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                </div>
                <p>加载数据中</p>
            </div>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var roomTypeName,roomConfigId,roomTypeHang,roomTypeLie,roomBoxClass;
var roomArr = new Array();
var companyId = $api.getStorage('companyId');
var missionDay = $api.getStorage('missionDay');
var userId = $api.getStorage('userId');
var userName = $api.getStorage('userName');
var userTel = $api.getStorage('userTel');
var lieZimuArr = ['A','B','C','D','E','F'];
function shuaxin(){
    api.setRefreshHeaderInfo({
        visible: true,
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#ccc',
        textColor: '#fff',
        textDown: '下拉刷新...',
        textUp: '松开刷新...',
        showTime: true,
    }, function(ret, err){
        getData();
        //从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        api.refreshHeaderLoadDone();
    });
}
function getData(){
    api.ajax({
        url: appUrl+'Get/roomStatusByJingli',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                room_config_id:roomConfigId
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                //alert(JSON.stringify(ret.data));
                //return false;
                reBuildData(ret.data);
            }
        } else {
            api.toast({
                msg: '网络出错'
            });
        }
    });
}
function reBuildData(roomJson){
    for(var i = 0;i < roomJson.length;i++){
        var thisRoomArr = new Array();
        var thisRoom = roomJson[i];
        var thisRoomHaoma = thisRoom.room_haoma;
        var thisRoomName = thisRoom.room_name;
        var thisRoomStatus = thisRoom.room_status;
        var thisRoomYichang = thisRoom.yichang;
        var thisRoomId = thisRoom.id;
        thisRoomArr['id'] = thisRoomId;
        thisRoomArr['name'] = thisRoomName;
        thisRoomArr['status'] = thisRoomStatus;
        thisRoomArr['yichang'] = thisRoomYichang;
        roomArr[thisRoomHaoma] = thisRoomArr;
    }
    buildPage();
}
function buildPage(){
    var innerStr = '';
    for(var i = 1;i <= roomTypeHang;i++){
        for(var j = 0;j < roomTypeLie;j++){
            var thisHaoma = lieZimuArr[j]+i;
            //alert(thisHaoma)
            var thisRoomId = roomArr[thisHaoma]['id'];
            var thisRoomName = roomArr[thisHaoma]['name'];
            var thisRoomStatus = roomArr[thisHaoma]['status'];
            var thisRoomYichang = roomArr[thisHaoma]['yichang'];
            var bgClass,statusStr,fnName;
            if(thisRoomName == ''){
                var nameStr = '无';
            }else{
                var nameStr = thisRoomName;
            }
            fnName = '';
            if(thisRoomYichang == 1){
                bgClass = ' aui-bg-warning';
                statusStr = '<p style="color:red">异常</p>';
                fnName = 'openYichang()';
            }else{
                if(thisRoomStatus == 0){
                    bgClass = ' aui-bg-success';
                    statusStr = '<p style="color:black">空闲房间</p>';
                }
                if(thisRoomStatus == 1){
                    bgClass = ' aui-bg-success';
                    statusStr = '<p style="color:yellow">正在使用</p>';
                }
                if(thisRoomStatus == 2){
                    bgClass = ' aui-bg-success';
                    statusStr = '<p style="color:black">正在使用</p>';
                }
                if(thisRoomStatus == 3){
                    bgClass = ' aui-bg-danger';
                    statusStr = '<p style="color:black">等待清洁</p>';
                    fnName = 'tapmode onclick="selectRoom('+thisRoomId+',\''+thisRoomName+'\')"';
                    //alert(thisRoomName + fnName)
                }
                if(thisRoomStatus == 4){
                    bgClass = ' aui-bg-info'
                    statusStr = '<p style="color:yellow">正在打扫</p>';
                }
            }
            var thisStr = '<li id="box'+thisRoomId+'" class="'+roomBoxClass+' aui-text-center'+bgClass+'" '+fnName+'><p style="color:black" id="roomName'+thisRoomId+'">'+nameStr+'</p>'+statusStr+'</li>';
            innerStr += thisStr;
        }
        //alert(innerStr)
    }
    $api.html($api.byId('viewBox'), innerStr);
}
function openYichang(){
    alert('该房间状态为异常，不能使用');
    return false;
}
function selectRoom(roomId,roomName){
    api.confirm({
        msg: '确认要打扫'+roomName + '房间吗？',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                openRoom(roomId,roomName)
            }
        }
    });
}
function openRoom(roomId,roomName){
    var valueJson = { 
        company_id:companyId,
        mission_day:missionDay,
        room_id:roomId,
        room_name:roomName,
        user_id:userId,
        user_name:userName,
        user_tel:userTel
    }
    api.ajax({
        url: appUrl+'Add/newQingjie',
        method: 'post',
        data: {
            values: valueJson
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                alert('新增房间清洁任务，请前往'+roomName+'房间打扫');
                api.closeWin({
                    name: 'showRoom'
                });
            }
            if(ret.has == 0){
                alert('该房间已被其他清洁人员打扫，请刷新并重新选择房间');
            }
        } else {
            //alert(JSON.stringify(err));
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
apiready = function(){
    api.parseTapmode();
    roomTypeName = api.pageParam.roomTypeName;
    roomTypeHang = api.pageParam.roomTypeHang;
    roomTypeLie = api.pageParam.roomTypeLie;
    roomConfigId = api.pageParam.roomConfigId;
    //alert(roomConfigId + ',' + roomTypeHang + ',' + roomTypeLie + ',' + roomTypeName)
    if(roomTypeLie == 1){
        roomBoxClass = 'aui-col-xs-12';
    }
    if(roomTypeLie == 2){
        roomBoxClass = 'aui-col-xs-6';
    }
    if(roomTypeLie == 3){
        roomBoxClass = 'aui-col-xs-4';
    }
    if(roomTypeLie == 4){
        roomBoxClass = 'aui-col-xs-3';
    }
    if(roomTypeLie == 5){
        roomBoxClass = 'aui-col-5';
    }
    if(roomTypeLie == 6){
        roomBoxClass = 'aui-col-xs-2';
    }
    getData();
    shuaxin();
}
        
</script>
</html>