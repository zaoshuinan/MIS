<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
.buy {
    background: #df9c63;
    height: 55px;
}
.ask {
    height: 55px;
    background: #797571;
}
</style>
<body>
    <div class="aui-content-padded icons">
        <ul class="aui-grid-nine" id="viewBox">
            <li id="shebei0" status="" class="aui-col-xs-6 aui-text-center" tapmode onclick="fnSelect(0)">
                <img src="../image/zhongfang2.png" style="width:60px">
                <p>钟房值班</p>
            </li>
            <li id="shebei1" status="" class="aui-col-xs-6 aui-text-center" tapmode onclick="fnSelect(1)">
                <img src="../image/zhongpeisong2.png" style="width:60px">
                <p>钟房配送</p>
            </li>
            <li id="shebei2" status="" class="aui-col-xs-6 aui-text-center" tapmode onclick="fnSelect(2)">
                <img src="../image/chanpinpeisong2.png" style="width:60px">
                <p>产品配送</p>
            </li>
            <li id="shebei3" status="" class="aui-col-xs-6 aui-text-center" tapmode onclick="fnSelect(3)">
                <img src="../image/qiantaishouyin2.png" style="width:60px">
                <p>前台收银</p>
            </li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var companyId,companyHaoma,viewBox;
var shebeiTypeNameArr = ['钟房值班','钟房配送','产品配送','前台收银'];
var shebeiTypeImgArr = ['zhongfang2','zhongpeisong2','chanpinpeisong2','qiantaishouyin2'];
var selectType;
var shebeiId
var dataId;
function fnSelect(index){
    var obj = $api.byId('shebei'+index);
    var objStatus = $api.attr(obj, 'status');
    if(objStatus == 1){
        alert('已经绑定了设备，请先解除绑定');
    }else{
        shebeiId = api.deviceId;
        selectType = index;
        api.ajax({
            url: appUrl+'Add/shebei',
            method: 'post',
            data: {
                values: { 
                    company_id:companyId,
                    company_haoma:companyHaoma,
                    shebei_type:index,
                    shebei_name:shebeiTypeNameArr[index],
                    shebei_id:shebeiId
                }
            }
        },function(ret, err){
            if (ret) {
                //alert( JSON.stringify( ret ) );
                dataId = ret.id;
                $api.html(viewBox, '<li class="aui-col-xs-12 aui-text-center" tapmode onclick="reFlash();"><img src="../image/'+shebeiTypeImgArr[selectType]+'.png" style="width:60px"><p>等待后台确认'+shebeiTypeNameArr[selectType]+'设备，点击刷新</p></li>');
                //alert('已录入设备信息，请在后台确认该设备');
            } else {
                api.toast({
                    msg: '网络错误',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }
}
function reFlash(){
    //alert(dataId);
    api.ajax({
        url: appUrl+'Get/checkShebei',
        method: 'post',
        data: {
            values: { 
                data_id: dataId
            }
        }
    },function(ret, err){
        if (ret) {
            // alert(JSON.stringify(ret));
            // return false;
            if(ret.shebei.has_check == 1){
                var lanuchCheckStr = ret.lanuch_check_str;
                $api.setStorage('shebeiType', selectType);
                $api.setStorage('hasLogin', '1');
                $api.setStorage('shebeiId', shebeiId);
                $api.setStorage('dataId', dataId);
                $api.setStorage('companyId', companyId);
                $api.setStorage('companyHaoma', companyHaoma);
                $api.setStorage('lanuchCheckStr', lanuchCheckStr);
                setCache();
            }else{
                alert('后台还没有确认该设备信息呢！');
            }
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
function setCache(){
    api.ajax({
        url: appUrl+'Get/setCacheByShebei',
        method: 'post',
        data: {
            values: { 
                company_id: companyId
            }
        }
    },function(ret, err){
        if (ret) {
            var cacheData = ret.data;
            var cacheJishi = JSON.parse(cacheData.cache_jishi);
            var cacheRoom = JSON.parse(cacheData.cache_room);
            var cacheService = JSON.parse(cacheData.cache_service);
            var cacheBanci = JSON.parse(cacheData.cache_banci);
            var cacheCompany = JSON.parse(cacheData.cache_company);
            var cacheCheckStr = cacheData.cache_check_str;
            var cacheYouhui = JSON.parse(cacheData.cache_youhuiduan);
            
            $api.setStorage('cacheCheckStr', cacheCheckStr);
            $api.setStorage('cacheJishi', cacheJishi);
            $api.setStorage('cacheRoom', cacheRoom);
            $api.setStorage('cacheService', cacheService);
            $api.setStorage('cacheBanci', cacheBanci);
            $api.setStorage('cacheYouhui', cacheYouhui);
            $api.setStorage('cacheCompany', cacheCompany); 
            //alert($api.getStorage('dataId'))
            alert('系统已记录该设备用于' + shebeiTypeNameArr[selectType] + ',将重启程序');
            api.rebootApp();
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
function checkShebei(){
    api.ajax({
        url: appUrl+'Get/shebeiStatus',
        method: 'post',
        data: {
            values: { 
                company_id: companyId
            },
            files: { 
                file: 'fs://a.gif'
            }
        }
    },function(ret, err){
        //alert(JSON.stringify(ret));
        if (ret) {
            if(ret.check == 1){
                var shebeiArr = ret.shebei;
                var shebei0Status = shebeiArr.shebei0;
                var shebei1Status = shebeiArr.shebei1;
                var shebei2Status = shebeiArr.shebei2;
                var shebei3Status = shebeiArr.shebei3;
                $api.attr($api.byId('shebei0'), 'status', shebei0Status);
                $api.attr($api.byId('shebei1'), 'status', shebei1Status);
                $api.attr($api.byId('shebei2'), 'status', shebei2Status);
                $api.attr($api.byId('shebei3'), 'status', shebei3Status);
            }
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
apiready = function(){
    viewBox = $api.byId('viewBox');
    companyId = api.pageParam.company_id;
    companyHaoma = api.pageParam.company_haoma;
    checkShebei();
    api.parseTapmode();
}
</script>
</html>