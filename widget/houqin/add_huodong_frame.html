<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content aui-card aui-noborder">       
        <div class="aui-form" style="margin-top:20px;">
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">活动名称</span>
                <input type="text" class="aui-input" id="huodongName" placeholder="活动名称" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">活动说明</span>
                <input type="text" class="aui-input" id="huodongInfo" placeholder="活动说明"/>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">活动最低消费</span>
                <input type="number" class="aui-input" id="huodongStartMoney" placeholder="活动最低消费"/>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">活动赠送金额</span>
                <input type="number" class="aui-input" id="huodongYouhuiMoney" placeholder="活动赠送金额"/>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">排序</span>
                <input type="number" class="aui-input" id="huodongOrder" placeholder="输入数字" />
            </div>
            <p class="aui-padded-10 aui-text-danger">
                请填写免费产品信息
            </p>
        </div>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="saveCheck()" id="saveButton">增加产品</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var pageAction,pageJson,dataId;
var getAction = 'huodongById';
var addAction = 'newHuodong';
var changeAction = 'changeHuodongById';
var companyId = $api.getStorage('companyId');

var huodongName,huodongInfo,huodongStartMoney,huodongYouhuiMoney,huodongOrder;

function saveCheck(){
    var canSend = 1;
    huodongName = $api.val($api.byId('huodongName'));
    huodongInfo = $api.val($api.byId('huodongInfo'));
    huodongStartMoney = $api.val($api.byId('huodongStartMoney'));
    huodongYouhuiMoney = $api.val($api.byId('huodongYouhuiMoney'));
    huodongOrder = $api.val($api.byId('huodongOrder'));
    if(huodongName == ''){
        api.toast({
            msg: '还没有输入活动名称'
        });
        canSend = 0;
    }
    if(huodongStartMoney == ''){
        api.toast({
            msg: '还没有输入最低消费金额'
        });
        canSend = 0;
    }
    if(huodongYouhuiMoney == ''){
        api.toast({
            msg: '还没有输入赠送金额'
        });
        canSend = 0;
    }
    if(canSend == 1){
        saveInfo();
    }
}

function saveInfo(){
    var ajaxUrl;
    var postJson = {
        company_id:companyId,
        huodong_name:huodongName,
        huodong_info:huodongInfo,
        huodong_start_money:huodongStartMoney,
        huodong_youhui_money:huodongYouhuiMoney,
        huodong_order:huodongOrder
    }
    if(pageAction == 'edit'){
        ajaxUrl = appUrl+'Change/' + changeAction;
        postJson.data_id = dataId;
    }else{
        ajaxUrl = appUrl+'Add/'+addAction;
    }
    api.ajax({
        url: ajaxUrl,
        method: 'post',
        data: {
            values: postJson,
            files: { 
                fileName: 'filePath'
            }
        }
    }, function(ret, err) {
        if (ret) {
            $api.setStorage('changeCache', '1');
            if(pageAction == 'edit'){
                alert('修改成功');
                api.sendEvent({
                    name: 'reFlashList',
                    extra: {
                        canFlash:1
                    }
                });
            }else{
                alert('添加成功');
            }
            api.closeWin();
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}

function bulidPageById(){
    api.ajax({
        url: appUrl+'Get/'+getAction,
        method: 'post',
        data: {
            values: { 
                data_id: dataId
            },
            files: { 
                fileName: 'filePath'
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                pageJson = ret.data;
                changePage();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}

function changePage(){
    huodongName = pageJson.huodong_name;
    huodongInfo = pageJson.huodong_info;
    huodongStartMoney = pageJson.huodong_start_money;
    huodongYouhuiMoney = pageJson.huodong_youhui_money;
    huodongOrder = pageJson.huodong_order;

    $api.val($api.byId('huodongName'), huodongName);
    $api.val($api.byId('huodongInfo'), huodongInfo);
    $api.val($api.byId('huodongStartMoney'), huodongStartMoney);
    $api.val($api.byId('huodongYouhuiMoney'), huodongYouhuiMoney);
    $api.val($api.byId('huodongOrder'), huodongOrder);
    $api.html($api.byId('saveButton'), '修改活动');
}

apiready = function(){
    api.parseTapmode();
    pageAction = api.pageParam.action;
    if(pageAction == 'edit'){
        dataId = api.pageParam.dataId;
        bulidPageById();
    }
}
        
</script>
</html>