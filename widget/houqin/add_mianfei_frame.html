<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content aui-card aui-noborder">       
        <div class="aui-form" style="margin-top:20px;">
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">产品名称</span>
                <input type="text" class="aui-input" id="mianfeiName" placeholder="产品名称" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">产品说明</span>
                <input type="text" class="aui-input" id="mianfeiInfo" placeholder="产品说明"/>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">产品库存</span>
                <input type="number" class="aui-input" id="mianfeiKucun" placeholder="产品库存"/>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">排序</span>
                <input type="number" class="aui-input" id="mianfeiOrder" placeholder="输入数字" />
            </div>
            <p class="aui-padded-10 aui-text-danger">
                请填写免费产品信息
            </p>
        </div>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="saveCheck()" id="saveButton">增加产品</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var pageAction,pageJson,dataId;
var getAction = 'mianfeiById';
var addAction = 'newMianfei';
var changeAction = 'changeMianfeiById';
var companyId = $api.getStorage('companyId');

var mianfeiName,mianfeiInfo,mianfeiKucun,mianfeiOrder;

function saveCheck(){
    var canSend = 1;
    mianfeiName = $api.val($api.byId('mianfeiName'));
    mianfeiInfo = $api.val($api.byId('mianfeiInfo'));
    mianfeiKucun = $api.val($api.byId('mianfeiKucun'));
    mianfeiOrder = $api.val($api.byId('mianfeiOrder'));
    if(mianfeiName == ''){
        api.toast({
            msg: '还没有输入名称信息'
        });
        canSend = 0;
    }
    if(canSend == 1){
        saveInfo();
    }
}

function saveInfo(){
    var ajaxUrl;
    var postJson = {
        company_id:companyId,
        mianfei_name:mianfeiName,
        mianfei_info:mianfeiInfo,
        mianfei_kucun:mianfeiKucun,
        mianfei_order:mianfeiOrder
    }
    if(pageAction == 'edit'){
        ajaxUrl = appUrl+'Change/' + changeAction;
        postJson.data_id = dataId;
    }else{
        ajaxUrl = appUrl+'Add/'+addAction;
    }
    api.ajax({
        url: ajaxUrl,
        method: 'post',
        data: {
            values: postJson,
            files: { 
                fileName: 'filePath'
            }
        }
    }, function(ret, err) {
        if (ret) {
            $api.setStorage('changeCache', '1');
            if(pageAction == 'edit'){
                alert('修改成功');
                api.sendEvent({
                    name: 'reFlashList',
                    extra: {
                        canFlash:1
                    }
                });
            }else{
                alert('添加成功');
            }
            api.closeWin();
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}

function bulidPageById(){
    api.ajax({
        url: appUrl+'Get/'+getAction,
        method: 'post',
        data: {
            values: { 
                data_id: dataId
            },
            files: { 
                fileName: 'filePath'
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                pageJson = ret.data;
                changePage();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}

function changePage(){
    mianfeiName = pageJson.mianfei_name;
    mianfeiInfo = pageJson.mianfei_info;
    mianfeiKucun = pageJson.mianfei_kucun;
    mianfeiOrder = pageJson.mianfei_order;
    $api.val($api.byId('mianfeiName'), mianfeiName);
    $api.val($api.byId('mianfeiInfo'), mianfeiInfo);
    $api.val($api.byId('mianfeiKucun'), mianfeiKucun);
    $api.val($api.byId('mianfeiOrder'), mianfeiOrder);
    $api.html($api.byId('saveButton'), '修改产品');
}

apiready = function(){
    api.parseTapmode();
    pageAction = api.pageParam.action;
    if(pageAction == 'edit'){
        dataId = api.pageParam.dataId;
        bulidPageById();
    }
}
        
</script>
</html>