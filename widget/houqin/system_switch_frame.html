<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<style>
html { background: #f7f9f8;}
</style>
<body>
    <div class="aui-card" id="passwordBox" style="margin-top: 60px">
        <div style="text-align: center;padding: 50px;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>系统检测中</p>
        </div>
    </div>
    <div class="aui-card aui-hidden" id="openBox" style="margin-top: 60px;text-align: center;padding: 20px;">
        <div id="openProgressBox" style="height: 40px;">
            <p style="text-align: center;font-size: 20px;color: black">请点击按钮开启系统</p>
        </div>
        <p style="margin-top:20px;"><div id="openSystemBtn" status="0" class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="openSystem()">开启系统</div></p>
    </div>
    <div class="aui-card aui-hidden" id="closeBox" style="margin-top: 60px;text-align: center;padding: 20px;">
        <div id="closeProgressBox" style="height: 40px;">
            <p style="text-align: center;font-size: 20px;color: black">请点击按钮关闭系统</p>
        </div>
        <p style="margin-top:20px;"><div id="closeSystemBtn" status="0" class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="closeSystem()">关闭系统</div></p>
    </div>
    <div class="aui-card aui-hidden" id="timeBox" style="margin-top: 60px">
        <div style="text-align: center;padding: 50px;">
            <p style="font-size: 30px;color:red" id="timeStrBox"></p>
            <p style="font-size: 30px;color:blue" id="missionDayBox"></p>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript">
var companyId = $api.getStorage('companyId');
var missionDay = $api.getStorage('missionDay');
var showType,nowTimeStr;
var jindu = 0;
var doingStep = nextStep = 1;
var stepObj;
var jinduObj1,jinduObj2,jinduObj3,jinduObj4;
var checkObj;
var timeNowDate;
var realPassword,password;
var openMsgArr = ['系统准备','创建缓存','更新缓存','开启成功'];
var closeMsgArr = ['系统准备','统计数据','关闭成功'];
function GetRandomNum(Min,Max){   
    var Range = Max - Min;   
    var Rand = Math.random();   
    var num = Min + Math.round(Rand * Range);
    return num;
} 
function sendDoing(){
    api.sendEvent({
        name: 'checkDoing',
        extra: {
            doing: 1
        }
    });
}
function sendOver(){
    api.sendEvent({
        name: 'systemSwitchOver',
        extra: {
            switchType: showType
        }
    });
}
function addDoingStep(){
    doingStep ++;
}
function addJindu(stopNum){
    var addNum = GetRandomNum(1,5);
    if(jindu < stopNum){
        jindu = jindu + addNum;
    }
}
function closeSystem(){
    sendDoing();
    var btnObj = $api.byId('closeSystemBtn');
    var btnStatus = $api.attr(btnObj, 'status');
    if(btnStatus == 0){
        var btnStatus = $api.attr(btnObj, 'status',1);
        $api.html($api.byId('closeProgressBox'), '<div class="aui-progress aui-progress aui-clearfix"><div class="aui-progress-bar" id="closeProgress" style="width: 60%;"></div></div><p id="closeMsg"></p>');
        $api.css($api.byId('closeProgress'), 'width: 0%');
        $api.removeCls(btnObj, 'aui-btn-danger');
        $api.html(btnObj, '正在关闭系统');
        stepObj = setInterval("closeCheckStep()",1);
        checkObj = setInterval("closeCheckLoading()",1);
        closeByStep();
    }
}
function closeByStep(){
    if(doingStep == 1){
        closeZhunbei();
    }
    if(doingStep == 2){
        closeAndTongji();
        clearInterval(jinduObj1);
        jindu = 20;
    }
    if(doingStep == 3){
        jindu = 100;
        clearInterval(jinduObj2);
    }
}
function closeCheckStep(){
    if(nextStep == doingStep){
        closeByStep(doingStep);
    }
}
function closeCheckLoading(){
    if(jindu <20){
        var colorStr = '#e74c3c';
        var msgStr = closeMsgArr[0];
    }
    if(jindu >= 20 && jindu < 80){
        var colorStr = '#f1c40f';
        var msgStr = closeMsgArr[1];
    }
    if(jindu >= 80){
        var colorStr = '#2ecc71';
        var msgStr = closeMsgArr[1];
    }
    if(jindu >= 100){
        var colorStr = '#2ecc71';
        var msgStr = closeMsgArr[2];
        clearInterval(checkObj)
        setTimeout("closeEnd()",200);
    }
    var msgStr1 = msgStr + ' '+jindu+'%';
    var msgStr2 = msgStr;
    $api.html($api.byId('closeMsg'), msgStr1);
    $api.html($api.byId('closeSystemBtn'), msgStr2);
    $api.css($api.byId('closeProgress'), 'width: '+jindu+'%;background-color: '+colorStr);
}
function closeZhunbei(){
    nextStep ++;
    jinduObj1 = setInterval("addJindu(20)",100);
    setTimeout("addDoingStep()",500);
}
function closeAndTongji(){
    nextStep++;
    jinduObj2 = setInterval("addJindu(80)",300);
    api.ajax({
        url: appUrl+'Change/tongjiLiushuiByQiantai',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                mission_day:missionDay
            }
        }
    }, function(ret, err) {
        if (ret) {missionDay
            if(ret.has == 1){
                setTimeout("addDoingStep()",4000);
                $api.setStorage('companyStatus', '0');
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function closeEnd(){
    $api.setStorage('companyStatus', 0);
    sendOver();
    alert('已经完成各项统计并关闭系统！');
    api.closeWin({
        name: 'system_switch'
    });
}
function openSystem(){
    sendDoing();
    var btnObj = $api.byId('openSystemBtn');
    var btnStatus = $api.attr(btnObj, 'status');
    if(btnStatus == 0){
        $api.attr(btnObj, 'status',1);
        $api.html($api.byId('openProgressBox'), '<div class="aui-progress aui-progress aui-clearfix"><div class="aui-progress-bar" id="openProgress" style="width: 60%;"></div></div><p id="openMsg"></p>');
        $api.css($api.byId('openProgress'), 'width: 0%');
        $api.removeCls(btnObj, 'aui-btn-danger');
        $api.html(btnObj, '正在开启系统');
        stepObj = setInterval("openCheckStep()",1);
        checkObj = setInterval("openCheckLoading()",1);
        openByStep();
    }
}
function openByStep(){
    if(doingStep == 1){
        openZhunbei();
    }
    if(doingStep == 2){
        openUpdataCache();
        clearInterval(jinduObj1);
        jindu = 20;
    }
    if(doingStep == 3){
        openAndResetCache();
        clearInterval(jinduObj2);
        jindu = 70;
    }
    if(doingStep == 4){
        //alert(4)
        jindu = 100;
        clearInterval(jinduObj3);
    }
}
function openCheckLoading(){
    if(jindu <20){
        var colorStr = '#e74c3c';
        var msgStr = openMsgArr[0];
    }
    if(jindu >= 20 && jindu < 70){
        var colorStr = '#f1c40f';
        var msgStr = openMsgArr[1];
    }
    if(jindu >=70 && jindu < 90){
        var colorStr = '#1abc9c';
        var msgStr = openMsgArr[2];
    }
    if(jindu >= 90){
        var colorStr = '#2ecc71';
        var msgStr = openMsgArr[2];
    }
    if(jindu >= 100){
        var colorStr = '#2ecc71';
        var msgStr = openMsgArr[3];
        clearInterval(checkObj)
        setTimeout("openEnd()",200);
    }
    var msgStr1 = msgStr + ' '+jindu+'%';
    var msgStr2 = msgStr;
    $api.html($api.byId('openMsg'), msgStr1);
    $api.html($api.byId('openSystemBtn'), msgStr2);
    $api.css($api.byId('openProgress'), 'width: '+jindu+'%;background-color: '+colorStr);
}
function openCheckStep(){
    if(nextStep == doingStep){
        openByStep(doingStep);
    }
}
function openZhunbei(){
    nextStep ++;
    jinduObj1 = setInterval("addJindu(20)",100);
    setTimeout("addDoingStep()",300);
}
function openUpdataCache(){
    nextStep++;
    jinduObj2 = setInterval("addJindu(70)",100);
    api.ajax({
        url: appUrl+'Cache/updateCacheByQiantai',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                creat_cache:1
            }
        }
    }, function(ret, err) {
        if (ret) {
            setTimeout("addDoingStep()",300);
        } else {
            api.toast({
                msg: '网络出错'
            });
        }
    });
}
function openAndResetCache(){
    nextStep ++;
    jinduObj3 = setInterval("addJindu(90)",100);
    api.ajax({
        url: appUrl+'Get/cacheAndOpenSystem',
        method: 'post',
        data: {
            values: { 
                company_id: companyId
            }
        }
    },function(ret, err){
        if (ret) {
            var cacheData = ret.cache;
            var cacheJishi = JSON.parse(cacheData.cache_jishi);
            var cacheRoom = JSON.parse(cacheData.cache_room);
            var cacheService = JSON.parse(cacheData.cache_service);
            var cacheBanci = JSON.parse(cacheData.cache_banci);
            var cacheYouhui = JSON.parse(cacheData.cache_youhuiduan);
            var cacheCompany = JSON.parse(cacheData.cache_company);
            var cacheCheckStr = cacheData.cache_check_str;
            var cachePeitao = JSON.parse(cacheData.cache_peitao);
            $api.setStorage('cachePeitao', cachePeitao);
            $api.setStorage('cacheCheckStr', cacheCheckStr);
            $api.setStorage('cacheJishi', cacheJishi);
            $api.setStorage('cacheRoom', cacheRoom);
            $api.setStorage('cacheService', cacheService);
            $api.setStorage('cacheYouhui', cacheYouhui);
            $api.setStorage('cacheBanci', cacheBanci);
            $api.setStorage('cacheCompany', cacheCompany); 
            setTimeout("addDoingStep()",300);
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
} 
function openEnd(){
    $api.setStorage('companyStatus', 1);
    sendOver();
    alert('开启系统成功，可以开始工作了！');
    api.closeWin({
        name: 'system_switch'
    });
}
function showOpenPage(){
    $api.addCls($api.byId('passwordBox'), 'aui-hidden');
    $api.addCls($api.byId('closeBox'), 'aui-hidden');
    $api.removeCls($api.byId('openBox'), 'aui-hidden');
}
function showClosePage(){
    $api.addCls($api.byId('passwordBox'), 'aui-hidden');
    $api.addCls($api.byId('openBox'), 'aui-hidden');
    $api.removeCls($api.byId('closeBox'), 'aui-hidden');
}
function checkPassword(){
    password = $api.val($api.byId('password'));
    if(password == ''){
        alert('请输入系统密码');
        return false;
    }
    if(password != realPassword){
        alert('密码错误，请重新输入');
        return false;
    }
    if(showType == 1){
        showOpenPage();
    }else{
        showClosePage();
    }
}
function showPasswordBox(){
    var innerStr = '<div style="text-align: center;padding: 50px;"><div class="aui-input-row"><span class="aui-input-addon" style="font-size: 20px;color:red">系统密码</span><input type="password" class="aui-input" style="font-size: 20px;color:blue" id="password" placeholder="请输入系统密码" /><span class="aui-input-addon"><div class="aui-btn aui-btn-success" id="checkPassword" status="1" style="font-size: 20px;color:blue" tapmode onclick="checkPassword()">验证</div></span></div></div>';
    $api.html($api.byId('passwordBox'), innerStr);
}
function getRealPassword(){
    api.ajax({
        url: appUrl+'Get/passwordByQiantai',
        method: 'post',
        data: {
            values: { 
                company_id: companyId
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                realPassword = ret.password;
                nowTimeStr = ret.time;
                showTimeBox();
                showPasswordBox();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function changeTime(){
    timeNowDate = new Date((timeNowDate/1000 + 1)*1000);
    var hours = timeNowDate.getHours();
    if(hours < 10){
        hours = '0' + hours;
    }      
    var minutes = timeNowDate.getMinutes();
    if(minutes < 10){
        minutes = '0' + minutes;
    }
    var seconds = timeNowDate.getSeconds();
    if(seconds < 10){
        seconds = '0' + seconds;
    }
    var showTimeStr = hours + ':' + minutes + ':' + seconds;
    $api.html($api.byId('timeStrBox'), '现在时间：'+showTimeStr);
}
function showTimeBox(){
    $api.html($api.byId('missionDayBox'), '工作日：'+missionDay);
    timeNowDate = new Date(nowTimeStr.replace(/-/g,"/"));
    var showTimeObj = setInterval("changeTime()",1000);
    $api.removeCls($api.byId('timeBox'), 'aui-hidden');
}
apiready = function () {
    showType = api.pageParam.showType;
    api.parseTapmode();
    getRealPassword();
}
</script>
</html>