<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content aui-card aui-noborder">       
        <div class="aui-form" style="margin-top:20px;">
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">经理手机</span>
                <input type="number" class="aui-input" id="userTel" placeholder="手机号码" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">经理名称</span>
                <input type="text" class="aui-input" id="userName" placeholder="经理名称"/>
            </div>

            <div class="aui-input-row">
                <span class="aui-input-addon">性别</span>
                <div class="aui-pull-left">
                    <input class="aui-radio aui-radio-info" type="radio" name="sex" id="man" onclick="changeSex(0)"> <span class="aui-radio-name">男</span>
                    <input class="aui-radio aui-radio-danger" type="radio" name="sex" id="women" checked onclick="changeSex(1)"> <span class="aui-radio-name">女</span>
                </div>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon  aui-text-danger">基本工资（元）</span>
                <input type="number" class="aui-input" id="userGongzi" placeholder="请输入经理工资，一般为0" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon  aui-text-danger">选择操作人员</span>
                <div class="aui-pull-left" id="zhongfangRenyuan">
                    
                </div>
            </div>
            <p class="aui-padded-10  aui-text-danger">
                初始密码为“123456”，提醒用户登录后修改密码！如修改了工资，将在审核通过后方能生效！
            </p>
        </div>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="saveCheck()" id="buttonBox"></button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/md5.js" ></script>
<script type="text/javascript">
var showType,jingliId;
var companyId = $api.getStorage('companyId');
var sex = 1;
var userArr = new Array();
var oldGongzi = 0;
var shenpi = 0;
var selectRenyuanId = 0;
var selectRenyuanName = '';
function changeSex(index){
    sex = index;
}
function saveCheck(){
    var canSend = 1;
    var userName = $api.val($api.byId('userName'));
    var userTel = $api.val($api.byId('userTel'));
    var userSex = sex;
    var userGongzi = $api.val($api.byId('userGongzi'));
    if(userTel == ''){
        alert('还没有输入电话号码！');
        return false;
    }
    if(userTel.length != 11){
        alert('请输入11位手机号码！')
        return false;
    }
    if(parseInt(userTel) < 10000000000){
        alert('手机号码输入有误！');
        return false;
    }
    if(userName == ''){
        alert('还没有输入经理名称！');
        return false;
    }
    if(userGongzi == ''){
        alert('如经理无基本工资，请在基本工资中输入“0”');
        return false;
    }
    if(selectRenyuanId == 0){
        alert('请选择操作人员！');
        return false;
    }
    if(userGongzi == oldGongzi){
        shenpi = 0;
        if(showType == 0){
            addInfo(userTel,userName,userSex,userGongzi);
        }else{
            saveInfo(userTel,userName,userSex,userGongzi);
        }
    }else{
        api.confirm({
            msg: '工资金额发生变动，需要通过审核',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1){
                    shenpi = 1;
                    if(showType == 0){
                        addInfo(userTel,userName,userSex,userGongzi);
                    }else{
                        saveInfo(userTel,userName,userSex,userGongzi);
                    }
                }
            }
        });
    }
}
function sendEvent(){
    api.sendEvent({
        name: 'jingliList',
        extra: {
            showType: showType
        }
    });
}
function addInfo(userTel,userName,userSex,userGongzi){
    var userPassword = 'e10adc3949ba59abbe56e057f20f883e';
    api.ajax({
        url: appUrl+'Add/jingliInfo',
        method: 'post',
        data: {
            values: {
                user_name:userName,
                user_sex:userSex,
                user_tel:userTel,
                user_password:userPassword,
                user_gongzi:userGongzi,
                user_type:2,
                company_id:companyId,
                shenpi:shenpi,
                old_gongzi:oldGongzi,
                send_user_id:selectRenyuanId,
                send_user_name:selectRenyuanName
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                alert('已有重复数据！');
                return false;
            }
            if(ret.has == 0){
                sendEvent();
                alert('新增经理成功');
                api.closeWin();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function saveInfo(userTel,userName,userSex,userGongzi){
    var userPassword = 'e10adc3949ba59abbe56e057f20f883e';
    api.ajax({
        url: appUrl+'Change/jingliInfo',
        method: 'post',
        data: {
            values: {
                user_name:userName,
                user_sex:userSex,
                user_tel:userTel,
                user_password:userPassword,
                user_gongzi:userGongzi,
                user_type:2,
                company_id:companyId,
                user_id:jingliId,
                shenpi:shenpi,
                old_gongzi:oldGongzi,
                send_user_id:selectRenyuanId,
                send_user_name:selectRenyuanName
            }
        }
    }, function(ret, err) {
        if (ret) {
            sendEvent();
            alert('修改经理成功');
            api.closeWin();
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function buildPage(){
    $api.val($api.byId('userTel'), userArr['user_tel']);
    $api.val($api.byId('userName'), userArr['user_name']);
    $api.val($api.byId('userGongzi'), userArr['user_gongzi']);
    oldGongzi = parseInt(userArr['user_gongzi']);
    sex = parseInt(userArr['user_sex']);
    //alert(sex)
    if(sex == 0){
        $api.attr($api.byId('man'), 'checked', 'checked');
        $api.removeAttr($api.byId('women'), 'checked');
    }else{
        $api.attr($api.byId('women'), 'checked', 'checked');
        $api.removeAttr($api.byId('man'), 'checked');
    }
}
function buildPageByJson(){
    api.ajax({
        url: appUrl+'Get/jingliInfoByZhongfang',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                user_id:jingliId
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                userArr = ret.data;
                buildPage();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function changeRenyuan(renyuanId,renyuanName){
    selectRenyuanId = renyuanId;
    selectRenyuanName = renyuanName;
}
function getZhongfangRenyuan(){
    if(showType == 1){
        $api.attr($api.byId('saveButton'), 'status',1);
    }
    api.ajax({
        url: appUrl+'Get/zhongfangRenyuan',
        method: 'post',
        data: {
            values: { 
                company_id: companyId
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 1){
                var renyuanArr = ret.data;
                var renyuanStr = '';
                for(var i = 0;i < renyuanArr.length;i++){
                    var renyuanId = renyuanArr[i].id;
                    var renyuanName = renyuanArr[i].user_name;
                    var thisRenyuanStr = '<input class="aui-radio aui-radio-danger" type="radio" name="zhongfangRen" id="zhongfang'+renyuanId+'" onclick="changeRenyuan('+renyuanId+',\''+renyuanName+'\')"> <span class="aui-radio-name">'+renyuanName+'</span>';
                    renyuanStr += thisRenyuanStr;
                }
                $api.html($api.byId('zhongfangRenyuan'), renyuanStr);
                if(showType == 0){
                    $api.html($api.byId('buttonBox'), '增加经理账号');
                }else{
                    buildPageByJson();
                    $api.html($api.byId('buttonBox'), '修改经理信息');
                }
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
apiready = function(){
    showType = api.pageParam.showType;
    jingliId = api.pageParam.jingliId;
    getZhongfangRenyuan();
    api.parseTapmode();
}      
</script>
</html>