<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content aui-card aui-noborder">       
        <div class="aui-form" style="margin-top:20px;">
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">申请人员：<b id="userBox" style="color:blue"></b></span>
                <button class="aui-btn aui-btn-danger" tapmode onclick="showHistroy()">查看人员近30天考勤数据</button>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">请假原因：<b id="yuanyinBox" style="color:blue"></b></span>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">请假日期：</span>
                <div id="dayBtnBox"></div>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon aui-text-danger">申请时间：<b id="sendTimeBox" style="color:blue"></b></span>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">批复说明：</span>
                <input type="text" class="aui-input" id="shuoming" placeholder="批复说明，为便于管理，建议填写"/>
            </div>
            <p class="aui-padded-10  aui-text-danger">
                点击请假日期，选择并确认准假类型
            </p>
        </div>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="saveCheck()">确定批复</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/md5.js" ></script>
<script type="text/javascript">
var qingjiaId,qingjiaJson,userId,userName,userType,userTel,yuanyin,shuoming;
var qingjiaDayArr = new Array;
var qingjiaDayStr = '';
var qingjiaTypeStr = '';
var cacheCompany = $api.getStorage('cacheCompany');
//alert(JSON.stringify(cacheCompany))
var qingjiaMoney;
var jingliQingjiaMoney = cacheCompany.jingli_qingjia_money;
var jishiQingjiaMoney = cacheCompany.jishi_qingjia_money;
var otherQingjiaMoney = cacheCompany.other_qingjia_money
var companyId = $api.getStorage('companyId');
function saveCheck(){
    var canSend = 1;
    shuoming = $api.val($api.byId('yuanyin'));
    qingjiaDayStr = '';
    qingjiaTypeStr = '';
    for(var i = 0;i < qingjiaDayArr.length;i++){
        var thisObj = $api.byId('day'+i);
        var thisDay = qingjiaDayArr[i];
        var thisHasSelect = $api.attr(thisObj, 'hasSelect');
        var thisHasType = $api.attr(thisObj, 'hasType');
        if(thisHasSelect == 0){
            canSend = 0;
        }else{
            if(thisHasType != 3){
                if(qingjiaTypeStr == ''){
                    qingjiaDayStr = thisDay;
                    qingjiaTypeStr = thisHasType;
                }else{
                    qingjiaDayStr += ',' + thisDay;
                    qingjiaTypeStr += ',' + thisHasType;
                }
            }
        }
    }
    if(canSend == 0){
        alert('请确认每天请假的处理类型');
        return false;
    }else{
        if(shuoming == ''){
            api.confirm({
                msg: '确定不输入任何情况说明吗？',
                buttons: ['确定', '取消']
            }, function(ret, err) {
                if (ret) {
                    if(ret.buttonIndex == 1){
                        sendQingjia();
                    }
                }
            });
        }else{
            sendQingjia();
        }
    }
}
function sendQingjia(){
    var valueJson = { 
        company_id: companyId,
        qingjia_id:qingjiaId,
        user_id:userId,
        jishi_id:0,
        user_type:userType,
        user_name:userName,
        user_tel:userTel,
        shuoming:shuoming,
        yuanyin:yuanyin,
        kou_money:qingjiaMoney,
        qingjia_day_str:qingjiaDayStr,
        qingjia_type_str:qingjiaTypeStr
    }
    api.ajax({
        url: appUrl+'Add/qingjiaByStr',
        method: 'post',
        data: {
            values: valueJson
        }
    }, function(ret, err) {
        if (ret) {
            sentEvent();
            alert('已发送批准信息');
            api.closeWin({
                name: 'qingjiaDetail'
            });
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function sentEvent(){
    api.sendEvent({
        name: 'reFlashQingjiaList',
        extra: {
            reFlash: 1
        }
    });
}
function showHistroy(){
    var winName = 'user_qingjia_histroy'
    api.openWin({
        name: winName,
        url: './'+winName+'_win.html',
        pageParam: {
            userId: userId
        }
    });
}
function buildPageByJson(){
    api.ajax({
        url: appUrl+'Get/qingjiaDetailByZhongfang',
        method: 'post',
        data: {
            values: {
                qingjia_id:qingjiaId
            }
        }
    },function(ret, err){
        if (ret) {
            qingjiaJson = ret.data;
            buildPage();
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
function buildPage(){
    userId = qingjiaJson.user_id;
    userType = qingjiaJson.user_type;
    userName = qingjiaJson.user_name;
    userTel = qingjiaJson.user_tel;
    if(userType == 9){
        var userStr = '技师，'+userName+'号（'+userTel+'）';
        qingjiaMoney = jingliQingjiaMoney;
    }
    if(userType == 2){
        var userStr = '经理，'+userName+'（'+userTel+'）';
        qingjiaMoney = jishiQingjiaMoney;
    }
    if(userType >2 && userType < 9){
        var userStr = '工作人员，'+userName+'（'+userTel+'）';
        qingjiaMoney = otherQingjiaMoney;
    }
    $api.html($api.byId('userBox'), userStr);
    yuanyin = qingjiaJson.yuanyin;
    $api.html($api.byId('yuanyinBox'), yuanyin);
    var sendTime = qingjiaJson.send_time;
    $api.html($api.byId('sendTimeBox'), sendTime);
    var qingjiaDay = qingjiaJson.qingjia_day;
    var startDay = qingjiaJson.start_day;
    var innerStr = '';
    for(var i = 0;i < qingjiaDay;i++){
        if(i == 0){
            var thisQingjiaDay = startDay;
            qingjiaDayArr[i] = startDay;
        }else{
            var thisQingjiaDay = addDate(startDay,i);
            qingjiaDayArr[i] = thisQingjiaDay;
        }
        var thisButtonStr = '<button id="day'+i+'" hasSelect="0" hasType="0" class="aui-btn aui-btn-default" dayNum="'+i+'" style="margin:2px" tapmode onclick="changeDayStatus('+i+')">'+thisQingjiaDay+'</button>';
        innerStr += thisButtonStr;
    }
    $api.html($api.byId('dayBtnBox'), innerStr);
}
function showObjType(obj,index){
    if(index == 1){
        $api.removeCls(obj, 'aui-btn-default');
        $api.removeCls(obj, 'aui-btn-danger');
        $api.removeCls(obj, 'aui-btn-success');
        $api.removeCls(obj, 'aui-btn-warning');
        $api.attr(obj, 'hasSelect',1);
        $api.attr(obj, 'hasType',1);
        $api.addCls(obj, 'aui-btn-danger');
    }
    if(index == 2){
        $api.removeCls(obj, 'aui-btn-default');
        $api.removeCls(obj, 'aui-btn-danger');
        $api.removeCls(obj, 'aui-btn-success');
        $api.removeCls(obj, 'aui-btn-warning');
        $api.attr(obj, 'hasSelect',1);
        $api.attr(obj, 'hasType',2);
        $api.addCls(obj, 'aui-btn-success');
    }
    if(index == 3){
        $api.removeCls(obj, 'aui-btn-default');
        $api.removeCls(obj, 'aui-btn-danger');
        $api.removeCls(obj, 'aui-btn-success');
        $api.removeCls(obj, 'aui-btn-warning');
        $api.attr(obj, 'hasSelect',1);
        $api.attr(obj, 'hasType',3);
        $api.addCls(obj, 'aui-btn-warning');
    }
}
function changeDayStatus(index){
    api.actionSheet({
        destructiveTitle: '正常请假，扣钱（红色）',
        buttons: ['正常请假，不扣钱（绿色）','不允许请假（黄色）']
    }, function(ret, err) {
        if (ret) {
            var thisObj = $api.byId('day'+index);
            if(ret.buttonIndex == 1){
                showObjType(thisObj,1)
            }
            if(ret.buttonIndex == 2){
                showObjType(thisObj,2)
            }
            if(ret.buttonIndex == 3){
                showObjType(thisObj,3)
            }
        } else {
            alert(JSON.stringify(err));
        }
    });
}
function addDate(date, days) {
    if (days == undefined || days == '') {
        days = 1;
    }
    var date = new Date(date);
    date.setDate(date.getDate() + days);
    var month = date.getMonth() + 1;
    if(month < 10){
        month = '0' + month;
    }
    var day = date.getDate();
    if(day < 10){
        day = '0' + day;
    }
    return date.getFullYear() + '-' + month + '-' + day;
}
apiready = function(){
    api.parseTapmode();
    qingjiaId = api.pageParam.qingjiaId;
    buildPageByJson();
}
        
</script>
</html>