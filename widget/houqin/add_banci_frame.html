<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content aui-card aui-noborder">       
        <div class="aui-form" style="margin-top:20px;">
            <div class="aui-input-row">
                <span class="aui-input-addon  aui-text-danger">班次名称</span>
                <input type="text" class="aui-input" id="banciName" placeholder="班次名称" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">班次说明</span>
                <input type="text" class="aui-input" id="banciInfo" placeholder="班次说明"/>
            </div>
            <div class="aui-input-row" tapmode onclick="selectStartTime()">
                <span class="aui-input-addon  aui-text-danger">开始时间</span>
                <input type="text" class="aui-input" id="beginTime" placeholder="点击选择开始时间" readonly />
            </div>
            <div class="aui-input-row" tapmode onclick="selectEndTime()">
                <span class="aui-input-addon  aui-text-danger">结束时间</span>
                <input type="text" class="aui-input" id="endTime" placeholder="点击选择结束时间" readonly />
            </div>
            <div class="aui-input-row" tapmode onclick="selectJingli()">
                <span class="aui-input-addon  aui-text-danger">选择经理</span>
                <input type="text" class="aui-input" id="selectJingliName" placeholder="点击选择经理" readonly />
                <input type="hidden" class="aui-input" id="selectJingliId" readonly />
            </div>
            <div class="aui-input-row" tapmode onclick="selectJishi()">
                <span class="aui-input-addon  aui-text-danger">选择技师</span>
                <input type="text" class="aui-input" id="selectJishiName" placeholder="点击选择技师" readonly />
                <input type="hidden" class="aui-input" id="selectJishiId" readonly />
                <input type="hidden" class="aui-input" id="jishiRealId" readonly />
            </div>
            <div class="aui-input-row" tapmode onclick="selectOther()">
                <span class="aui-input-addon  aui-text-danger">选择工作人员</span>
                <input type="text" class="aui-input" id="selectOtherName" placeholder="点击选择工作人员" readonly />
                <input type="hidden" class="aui-input" id="selectOtherId" readonly />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">排序</span>
                <input type="number" class="aui-input" id="banciOrder" placeholder="输入数字" />
            </div>
            <p class="aui-padded-10  aui-text-danger">
                请填写班次信息，为了便于管理，记得关联经理与技师哦！
            </p>
        </div>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="saveCheck()" id="saveButton">增加班次</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var pageAction,banciId,banciArr,userArr;
var selectJingliIdStr = selectJingliNameStr = selectJishiIdStr = selectJishiRealIdStr =  selectJishiNameStr = selectOtherIdStr = selectOtherNameStr = '';
var companyId = $api.getStorage('companyId');
var companyId = $api.getStorage('companyId');
var startHour,startMin,endHour,endMin,banciName,banciInfo,banciOrder;
function selectJingli(){
    if(showType == 0){
        alert('请先保存班次，再关联人员');
        return false;
    }
    api.openWin({
        name: 'zhongfangSelectJingli',
        url: './zhongfang_select_jingli_win.html',
        pageParam: {
            banciId:banciId,
            banciName:banciName
        }
    });
}
function selectOther(){
    if(showType == 0){
        alert('请先保存班次，再关联人员');
        return false;
    }
    api.openWin({
        name: 'zhongfangSelectOther',
        url: './zhongfang_select_other_win.html',
        pageParam: {
            banciId:banciId,
            banciName:banciName
        }
    });
}
function selectJishi(){
    if(showType == 0){
        alert('请先保存班次，再关联人员');
        return false;
    }
    api.openWin({
        name: 'zhongfangSelectJishi',
        url: './zhongfang_select_jishi_win.html',
        pageParam: {
            banciId:banciId,
            banciName:banciName
        }
    });
}
function selectStartTime(){
    api.openPicker({
        type: 'time',
        date: '10:50',
        title: '选择开始时间'
    }, function(ret, err){
        if( ret ){
             startHour = ret.hour;
             startMin = ret.minute;
             $api.val($api.byId('beginTime'), startHour + '时' + startMin + '分');
        }else{
             api.toast({
                 msg: '选择错误',
                 duration: 2000,
                 location: 'bottom'
             });
        }
    });
}
function selectEndTime(){
    api.openPicker({
        type: 'time',
        date: '10:50',
        title: '选择结束时间'
    }, function(ret, err){
        if( ret ){
             endHour = ret.hour;
             endMin = ret.minute;
             $api.val($api.byId('endTime'), endHour + '时' + endMin + '分');
        }else{
             api.toast({
                 msg: '选择错误',
                 duration: 2000,
                 location: 'bottom'
             });
        }
    });
}
function saveCheck(){
    var canSend = 1;
    banciName = $api.val($api.byId('banciName'));
    banciInfo = $api.val($api.byId('banciInfo'));
    var startTime = $api.val($api.byId('startTime'));
    var endTime = $api.val($api.byId('endTime'));
    selectJingliIdStr = $api.val($api.byId('selectJingliId'));
    selectJingliNameStr = $api.val($api.byId('selectJingliName'));
    selectJishiIdStr = $api.val($api.byId('selectJishiId'));
    selectJishiRealIdStr = $api.val($api.byId('jishiRealId'));
    selectJishiNameStr = $api.val($api.byId('selectJishiName'));
    selectOtherIdStr = $api.val($api.byId('selectOtherId'));
    selectOtherNameStr = $api.val($api.byId('selectOtherName'));
    banciOrder = $api.val($api.byId('banciOrder'));
    if(banciName == ''){
        api.toast({
            msg: '还没有输入班次信息'
        });
        canSend = 0;
    }
    if(startTime == '' || endTime == ''){
        api.toast({
            msg: '请输入时间信息'
        });
        canSend = 0;
    }
    if(canSend == 1){
        if(showType == 0){
            addInfo();
        }else{
            saveInfo();
        }
    }
}
function saveInfo(){
    api.ajax({
        url: appUrl+'Change/changeBanciById',
        method: 'post',
        data: {
            values: {
                company_id:companyId,
                banci_name:banciName,
                banci_info:banciInfo,
                banci_begin_hour:startHour,
                banci_begin_min:startMin,
                banci_end_hour:endHour,
                banci_end_min:endMin,
                banci_order:banciOrder
            }
        }
    }, function(ret, err) {
        if (ret) {
            $api.setStorage('changeCache', '1');
            alert('修改成功');
            api.sendEvent({
                name: 'reFlashList',
                extra: {
                    canFlash:1
                }
            });
            api.closeWin();
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function addInfo(){
    api.ajax({
        url: appUrl+'Add/newBanci',
        method: 'post',
        data: {
            values: {
                company_id:companyId,
                banci_name:banciName,
                banci_info:banciInfo,
                banci_begin_hour:startHour,
                banci_begin_min:startMin,
                banci_end_hour:endHour,
                banci_end_min:endMin,
                banci_order:banciOrder
            }
        }
    }, function(ret, err) {
        if (ret) {
            alert('添加成功');
            api.closeWin();
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function bulidPageById(){
    api.ajax({
        url: appUrl+'Get/banciById',
        method: 'post',
        data: {
            values: { 
                banci_id: banciId,
                company_id:companyId
            }
        }
    }, function(ret, err) {
        //alert(JSON.stringify(ret))
        if (ret) {
            if(ret.has == 1){
                userArr = ret.user_data;
                banciArr = ret.banci_data;
                reBuildBanciData();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function reBuildBanciData(){
    for(var i = 0;i < userArr.length;i++){
        var thisUser = userArr[i];
        var thisUserType = thisUser.user_type;
        var thisUserId = thisUser.id;
        var thisUserName =thisUser.user_name;
        var thisUserBanciId = thisUser.user_banci_id;
        //alert(banciId + '-' + thisUserBanciId)
        if(thisUserBanciId == banciId){
            if(thisUserType == 2){
                if(selectJingliIdStr == ''){
                    selectJingliIdStr = thisUserId;
                    selectJingliNameStr = thisUserName;
                }else{
                    selectJingliIdStr += ',' + thisUserId;
                    selectJingliNameStr += ',' + thisUserName;
                }
            }
            if(thisUserType == 9){
                var thisJishiRealId = thisUser.jishi_id;
                var thisJishiPaihao = thisUser.jishi_paihao+'号';
                if(selectJishiIdStr == ''){
                    selectJishiIdStr = thisUserId;
                    selectJishiRealIdStr = thisJishiRealId;
                    selectJishiNameStr = thisJishiPaihao;
                }else{
                    selectJishiIdStr += ',' + thisUserId;
                    selectJishiRealIdStr += ',' + thisJishiRealId;
                    selectJishiNameStr += ',' + thisJishiPaihao;
                }
            }
            if(thisUserType > 2 && thisUserType < 9){
                //alert(thisUserName)
                if(selectOtherIdStr == ''){
                    selectOtherIdStr = thisUserId;
                    selectOtherNameStr = thisUserName;
                }else{
                    selectOtherIdStr += ',' + thisUserId;
                    selectOtherNameStr += ',' + thisUserName;
                }
            }
        }
    }
    //alert(selectJishiIdStr + selectJishiRealIdStr + selectJishiNameStr + selectJingliIdStr + selectJingliNameStr + selectOtherIdStr + selectOtherNameStr)
    changePage();
}
function changePage(){
    banciName = banciArr.banci_name;
    banciInfo = banciArr.banci_info
    startHour = banciArr.banci_begin_hour;
    startMin = banciArr.banci_begin_min;
    endHour = banciArr.banci_end_hour;
    endMin = banciArr.banci_end_min;
    banciOrder = banciArr.banci_order;
    $api.val($api.byId('banciName'), banciName);
    $api.val($api.byId('banciInfo'), banciInfo);
    $api.val($api.byId('beginTime'), startHour + '时' + startMin + '分');
    $api.val($api.byId('endTime'), endHour + '时' + endMin + '分');
    $api.val($api.byId('selectJishiId'), selectJishiIdStr);
    $api.val($api.byId('selectJishiName'), selectJishiNameStr);
    $api.val($api.byId('selectJingliId'), selectJingliIdStr);
    $api.val($api.byId('selectJingliName'), selectJingliNameStr);
    $api.val($api.byId('selectOtherId'), selectOtherIdStr);
    $api.val($api.byId('selectOtherName'), selectOtherNameStr);
    $api.val($api.byId('jishiRealId'), selectJishiRealIdStr);
    $api.val($api.byId('banciOrder'), banciOrder);
    $api.html($api.byId('saveButton'), '修改班次');
}
apiready = function(){
    api.parseTapmode();
    showType = api.pageParam.showType;
    banciName = api.pageParam.banciName;
    if(showType == 1){
        banciId = api.pageParam.banciId;
        bulidPageById();
    }
    api.addEventListener({
        name: 'backSelect'
    }, function(ret, err) {
        //alert(JSON.stringify(ret))
        if (ret) {
            if(ret.value.type == 'jingli'){
                selectJingliIdStr = ret.value.selectUserIdStr;
                selectJingliNameStr = ret.value.selectUserNameStr;
                $api.val($api.byId('selectJingliId'), selectJingliIdStr);
                $api.val($api.byId('selectJingliName'), selectJingliNameStr);
            }
            if(ret.value.type == 'jishi'){
                selectJishiIdStr = ret.value.selectUserIdStr;
                selectJishiNameStr = ret.value.selectUserNameStr;
                selectJishiRealIdStr = ret.value.selectJishiRealIdStr;
                $api.val($api.byId('selectJishiId'), selectJishiIdStr);
                $api.val($api.byId('selectJishiName'), selectJishiNameStr);
                $api.val($api.byId('jishiRealId'), selectJishiRealIdStr);
            }
            if(ret.value.type == 'other'){
                selectOtherIdStr = ret.value.selectUserIdStr;
                selectOtherNameStr = ret.value.selectUserNameStr;
                $api.val($api.byId('selectOtherId'), selectOtherIdStr);
                $api.val($api.byId('selectOtherName'), selectOtherNameStr);
            }
        }
    });
}      
</script>
</html>