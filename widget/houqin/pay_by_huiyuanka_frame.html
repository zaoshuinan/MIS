<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<style>
html { background: #f7f9f8;}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 60px;
}
</style>
<body>
    <div class="aui-card aui-noborder">
        <div class="aui-form" style="margin-top:50px;margin-left: 50px;">
            <div class="aui-input-row">
                <p style="color:red;font-size: 80px">应收 <span id="yingshou"></span>元</p>
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon  aui-text-danger" style="font-size: 20px">验证方式</span>
                <div class="aui-pull-left">
                    <input class="aui-radio aui-radio-info" type="radio" name="checkType" checked="" onclick="changeType(1)"> <span class="aui-radio-name">电话号码</span>
                    <input class="aui-radio aui-radio-danger" type="radio" name="checkType"  onclick="changeType(0)"> <span class="aui-radio-name">会员卡卡号</span>
                </div>
            </div>
            <div class="aui-input-row aui-hidden" id="huiyuanKahaoBox">
                <span class="aui-input-addon  aui-text-danger" style="font-size: 20px">会员卡号</span>
                <input type="number" class="aui-input" id="huiyuanKahao" style="color:blue;font-size: 20px" placeholder=" 请输入会员卡卡号" value="" />
                <span class="aui-input-addon">
                    <div class="aui-btn" id="checkTel" status="1" tapmode onclick="checkHuiyuan(0)">会员验证</div>
                </span>
            </div>
            <div class="aui-input-row" id="huiyuanTelBox">
                <span class="aui-input-addon  aui-text-danger" style="font-size: 20px">会员手机号</span>
                <input type="number" class="aui-input" id="huiyuanTel" style="color:blue;font-size: 20px" placeholder=" 请输入会员11位手机号码" value="" />
                <span class="aui-input-addon">
                    <div class="aui-btn" id="checkTel" status="1" tapmode onclick="checkHuiyuan(1)">会员验证</div>
                </span>
            </div>
        </div>
    </div>
    <div class="aui-card" id="showInfo" style="padding: 30px;"> 
        <p style="font-size: 20px;text-align: center;">请选择验证方式并验证会员</p>
    </div>
    <footer class="aui-nav" id="footer">
        <div class="aui-col-xs-12 aui-bg-danger" tapmode onclick="quedingShouyin()">收银确认</div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript">
var companyId = $api.getStorage('companyId');
var missionDay = $api.getStorage('missionDay');
var payType,payMoney,youhuiMoney,dingdanIdStr,allMoney
var canSend = 0;
var checkType = 0;
var huiyuanTel = '';
var huiyuanKahao = '';
var huiyuanInfoArr = new Array();
var showBox = $api.byId('showInfo');
var hasMoney = 0;
var shengyuMoney = 0;
var huiyuankaId = 0;
function changeType(index){
    checkType = index;
    $api.val($api.byId('huiyuanKahao'), '');
    $api.val($api.byId('huiyuanTel'), '');
    huiyuanTel = '';
    huiyuanKahao = '';
    canSend = 0;
    if(index == 0){
        $api.html(showBox, '<p style="font-size: 20px;text-align: center;color:red">你选择的是卡号验证方式，请输入会员卡号</p>');
        $api.removeCls($api.byId('huiyuanKahaoBox'), 'aui-hidden');
        $api.addCls($api.byId('huiyuanTelBox'), 'aui-hidden');
    }else{
        $api.html(showBox, '<p style="font-size: 20px;text-align: center;color:red">你选择的是会员电话号码验证方式，请输入电话号码</p>');
        $api.removeCls($api.byId('huiyuanTelBox'), 'aui-hidden');
        $api.addCls($api.byId('huiyuanKahaoBox'), 'aui-hidden');
    }
}
function checkHuiyuan(index){
    if(index == 1){
        huiyuanTel = $api.val($api.byId('huiyuanTel'));
        if(huiyuanTel == ''){
            alert('请输入会员11位手机号');
            return false;
        }
        if(huiyuanTel.length != 11){
            alert('输入的号码不是11位');
            return false;
        }
    }else{
        huiyuanKahao = $api.val($api.byId('huiyuanKahao'));
        if(huiyuanKahao == ''){
            alert('请输入会员卡号');
            return false;
        }
    }
    getHuiyuanInfo(index)
}
function getHuiyuanInfo(index){
    if(index == 0){
        var huiyuanCheck = huiyuanKahao;
    }else{
        var huiyuanCheck = huiyuanTel;
    }
    $api.html(showBox, '<div style="text-align: center;"><div class="loading-2"><i></i><i></i><i></i><i></i><i></i></div><p>会员验证中</p></div>');
    //return false;
    api.ajax({
        url: appUrl+'Get/huiyuankaById',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                check_type:index,
                huiyuan_check:huiyuanCheck
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 0){
                $api.html(showBox, '<p style="font-size: 20px;text-align: center;color:red">没有找到会员信息，请重新验证！</p>');
            }else{
                huiyuanInfoArr = ret.data;
                showDetail();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function showDetail(){
    hasMoney = parseFloat(huiyuanInfoArr['money']);
    huiyuankaId = huiyuanInfoArr['id'];
    var innerStr = '<p style="font-size: 30px;">会员名称：<b>'+huiyuanInfoArr['huiyuan_name']+'</b></p><p style="font-size: 30px;">会员电话：<b>'+huiyuanInfoArr['huiyuan_tel']+'</b></p><p style="font-size: 30px;">会员卡号：<b>'+huiyuanInfoArr['huiyuan_kahao']+'</b></p><p style="font-size: 30px;">卡内余额：<b style="color:red">'+hasMoney+'</b>元</p><p style="font-size: 30px;">此次消费：<b style="color:red">'+payMoney+'</b>元</p>'
    if(hasMoney >= payMoney){
        shengyuMoney = hasMoney - parseFloat(payMoney);
        innerStr += '<p style="font-size: 30px;">扣后余额：<b style="color:red">'+shengyuMoney+'</b>元</p><p style="font-size:30px;color:blue">请询问客人信息并确认！</p>';
        canSend = 1;
    }else{
        innerStr += '<p style="font-size: 30px;color:red">会员卡余额不足，不能扣除！</p><p style="font-size:30px;color:blue">请询问客人是否充值！</p><p>如客人需退卡，请前往会员管理办理（余额需小于此次消费）</p>';
        canSend = 0;
    }
    $api.html(showBox, innerStr);
}
function quedingShouyin(){
    if(canSend == 1){
        api.confirm({
            title: '确认信息',
            msg: '确认扣除电话号码为'+huiyuanTel+'的会员'+payMoney+'元吗？',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1){
                    sendDingdanOver();
                }
            }
        });
    }else{
        alert('不符合收银条件，请退出该页面');
        return false;
    }
}

function sendDingdanOver(){
    var valueJson = { 
        company_id:companyId,
        dingdan_id_str:dingdanIdStr,
        maidan_type:1,
        all_money:allMoney,
        youhui_money:youhuiMoney,
        yingshou_money:payMoney,
        huiyuanka_id:huiyuankaId,
        old_money:hasMoney,
        shengyu_money:shengyuMoney,
        mission_day:missionDay
    }
    // alert(JSON.stringify(valueJson));
    // return false;
    api.ajax({
        url: appUrl+'Change/dingdanOverByHuiyuanka',
        method: 'post',
        data: {
            values: valueJson
        }
    }, function(ret, err) {
        if (ret) {
            // alert(JSON.stringify(ret));
            // return false;
            if(ret.has == 1){
                api.sendEvent({
                    name: 'reFlashShouyin',
                    extra: {
                        can: '1'
                    }
                });
                alert('收银成功');
                api.closeWin({
                    name: 'fuwu_dingdan'
                });
                api.closeWin({
                    name: 'pay'
                });
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}

function showZhaoling(){
    canSend = 0;
    var shishou = $api.val($api.byId('shishou'));
    if(shishou == ''){
        alert('请输入正确的实收金额');
        canSend = 0;
        //$api.addAttr($api.byId('footer'), 'aui-hidden');
        return false;
    }
    shishouMoney = parseInt(shishou);
    if(shishouMoney < payMoney){
        alert('实收金额小于应收金额，请再次确认');
        canSend = 0;
        //$api.addAttr($api.byId('footer'), 'aui-hidden');
        return false;
    }else{
        zhaolingMoney = shishouMoney - payMoney;
        $api.html($api.byId('zhaoling'), zhaolingMoney);
        canSend = 1;
        //$api.removeAttr($api.byId('footer'), 'aui-hidden');
    }
    //alert(parseInt(shishou))
}

apiready = function () {
    api.parseTapmode();
    payMoney = api.pageParam.payMoney;
    youhuiMoney = api.pageParam.youhuiMoney;
    dingdanIdStr = api.pageParam.dingdanIdStr;
    allMoney = parseFloat(payMoney) + parseFloat(youhuiMoney);
    //alert(dingdanIdStr)
    $api.html($api.byId('yingshou'), payMoney);
    changeType(1)
}
</script>
</html>