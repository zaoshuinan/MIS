<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 2px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
</style>
<body>
    <header class="aui-bar aui-bar-nav aui-bg-danger" id="misHeader">
        <a class="aui-btn aui-pull-left aui-bg-danger" id="backBtn" tapmode onclick="closeFrame()">
            <span class="aui-iconfont aui-icon-close"></span>
        </a>
        <div class="aui-title aui-bg-danger" id="zhName">关闭重选技师页面</div>
        <a class="aui-iconfont aui-icon-menu aui-pull-right"></a>
    </header>
    <div class="aui-content-padded icons">
        <div class="aui-grid-nine"  id="viewBox">
            <div style="text-align: center;padding: 50px;">
                <div class="loading-2">
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                    <i></i>
                </div>
                <p>读取数据中....</p>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var zhongfangId,dingdanId,jingliLiushuiId,roomId,roomName,serviceType,serviceName,serviceShichang,serviceId,jishiIdStr,tichengStr,oldJishiId,oldJishiPaihao;
var selectJishiId,selectJishiPaihao,selectJishiTicheng,defaultJishiId,defaultJishiPaihao;
var jishiArr;
var tichengArr = new Array();
var userId = $api.getStorage('userId');
var userName = $api.getStorage('userName');
var userTel = $api.getStorage('userTel');
var banciJson = $api.getStorage('cacheBanci');
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var cacheService = $api.getStorage('cacheService');
//alert(JSON.stringify($api.getStorage('cacheService')));
function closeFrame(){
    api.closeFrame();
}
function shuaxin(){
    api.setRefreshHeaderInfo({
        visible: true,
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#ccc',
        textColor: '#fff',
        textDown: '下拉刷新...',
        textUp: '松开刷新...',
        showTime: true,
    }, function(ret, err){
        getData();
        //从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        api.refreshHeaderLoadDone();
    });
}
function noclick(str){
    api.toast({
        msg: str
    });
    return false;
}
function sendJishi(index){
    var valueJson = { 
        company_id:companyId,
        mission_day:missionDay,
        dingdan_id:dingdanId,
        jingli_liushui_id:jingliLiushuiId,
        zhongfang_id:zhongfangId,
        room_id:roomId,
        room_name:roomName,
        service_id:serviceId,
        service_type:serviceType,
        service_name:serviceName,
        service_shichang:serviceShichang,
        jishi_id:selectJishiId,
        jishi_paihao:selectJishiPaihao,
        jingli_name:userName,
        jingli_tel:userTel,
        ticheng:selectJishiTicheng
    }
    if(index == 1){
        valueJson.default = 0;
        valueJson.send_type = '1';
        valueJson.default_jishi_id = defaultJishiId;
        valueJson.default_jishi_paihao = defaultJishiPaihao;
    }else{
        valueJson.default = 1;
    }
    // alert(JSON.stringify(valueJson));
    // sendEvent(zhongfangId);
    // alert('已重选了'+selectJishiPaihao+'号技师，请通知其尽快前往'+roomName+'房间！');
    // api.closeFrame();
    // return false;
    api.ajax({
        url:appUrl+'Add/zhongfangReSelect',
        method: 'post',
        data: {
            values: valueJson
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 0){
                alert('该技师已被其他经理选择，请刷新界面并重新选择');
                return false;
            }
            if(ret.has == 1){
                sendEvent(zhongfangId);
                alert('已重选了'+selectJishiPaihao+'号技师，请通知其尽快前往'+roomName+'房间！');
                api.closeFrame();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function sendEvent(){
    api.sendEvent({
        name: 'changeZhongfang',
        extra: {
            zhongfangId:zhongfangId
        }
    });
}
function selectJishi(showNum,jishiId,jishiPaihao,jishiTicheng){
    if(showNum == 0){
        api.confirm({
            msg: '你确认选择'+jishiPaihao+'号技师吗？',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1){
                    selectJishiId = jishiId;
                    selectJishiPaihao = jishiPaihao;
                    selectJishiTicheng = jishiTicheng;
                    sendJishi(0);
                }
            }
        });
    }else{
        api.confirm({
            msg: '你选择的'+jishiPaihao+'号技师不是系统默认派遣技师，此操作将被系统记录，你确定要选择该技师吗？',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                if(ret.buttonIndex == 1){
                    selectJishiId = jishiId;
                    selectJishiPaihao = jishiPaihao;
                    selectJishiTicheng = jishiTicheng;
                    sendJishi(1);
                }
            }
        });
    }
}
function buildPage(){
    var innerStr = '';
    var imgArr = new Array();
    for(var i = 0;i < jishiArr.length;i++){
        var thisJishi = jishiArr[i];
        var jishiId = thisJishi.id;
        var jishiKey = 'jishi'+jishiId;
        var jishiTicheng = tichengArr[jishiKey];
        var jishiStatus = thisJishi.jishi_status;
        var jishiKaoqinTime = thisJishi.jishi_kaoqin_time;
        var jishiEndTime = thisJishi.jishi_end_time;
        var jishiTouxiangUrl = ipUrl + thisJishi.jishi_touxiang_url;
        imgArr[i] = jishiTouxiangUrl;
        var jishiPaihao = thisJishi.jishi_paihao;
        if(jishiEndTime != '0000-00-00 00:00:00'){
            var timeStr = '<p style="color:red">下钟时间:'+jishiEndTime.substr(11,5)+'</p>';
        }else{
            var timeStr = '<p style="color:blue">考勤时间:'+jishiKaoqinTime.substr(11,5)+'</p>';
        }
        if(jishiStatus != 0){
            if(jishiStatus == 1){
                if(i == 0){
                    var bgClass = ' aui-bg-success';
                    var statusStr = '默认';
                    var textColor = 'warning';
                    defaultJishiId = jishiId;
                    defaultJishiPaihao = jishiPaihao;
                }else{
                    var bgClass = '';
                    var statusStr = '待上钟';
                    var textColor = 'danger';
                }
                if(jishiId == oldJishiId){
                    var clickStr = ' tapmode onclick="noSelect()"';
                    var statusStr = '被退回';
                    var textColor = 'primary';
                }else{
                    var clickStr = ' tapmode onclick="selectJishi(\''+i+'\',\''+jishiId+'\',\''+jishiPaihao+'\',\''+jishiTicheng+'\')"';
                }
                
            }
            if(jishiStatus == 2){
                var bgClass = ' aui-bg-info';
                var clickStr = ' tapmode onclick="noclick(\'技师正等待客户确认，无法选择\')"';
                var textColor = 'danger';
                var statusStr = '待确认';
            }
             if(jishiStatus == 3){
                var bgClass = ' aui-bg-warning';
                var clickStr =  ' tapmode onclick="noclick(\'技师正在上钟，无法选择\')"';
                var textColor = 'default';
                var statusStr = '工作中';
            }
            var thisStr = '<li class="aui-col-xs-3 aui-text-center'+bgClass+'"'+clickStr+'><img id="img'+i+'" style="width:80px;height:80px;border-radius: 50%;" src="../image/jishi.png"><p class="aui-text-'+textColor+'" style="font-size:24px;">'+jishiPaihao+'号<span style="font-size:20px">('+statusStr+')</span></p>'+timeStr+'</li>';
            innerStr += thisStr;
        }
    }
    var viewBox = $api.byId('viewBox');
    $api.html(viewBox, innerStr);
    //闭包处理
    for(var j = 0;j<imgArr.length;j++){
        (function(j) {
            var objIdName = 'img' + j;
            //alert('1-'+objIdName)
            var realImgUrl = imgArr[j];
            api.imageCache({
                url: realImgUrl
            }, function(ret, err){
                if( ret ){
                     var cacheUrl = ret.url;
                     $api.attr($api.byId(objIdName), 'src', cacheUrl);
                }
            });
        })(j);
    }
}
function noSelect(){
    alert('该技师不能再次选择');
    return false;
}
function getServiceInfo(){
    var thisServiceJson;
    var muzuServiceTypeJson = cacheService.muzu;
    var anmoServiceTypeJson = cacheService.anmo;
    var sangnaServiceTypeJson = cacheService.sangna;
    if(muzuServiceTypeJson){
        for(var i = 0;i < muzuServiceTypeJson.length;i++){
            var thisMuzuServiceJson = muzuServiceTypeJson[i];
            var thisMuzuServiceId = thisMuzuServiceJson.id;
            if(thisMuzuServiceId == serviceId){
                thisServiceJson = thisMuzuServiceJson;
            }
        }
    }
    if(anmoServiceTypeJson){
        for(var j = 0;j < anmoServiceTypeJson.length;j++){
            var thisAnmoServiceJson = anmoServiceTypeJson[j];
            var thisAnmoServiceId = thisAnmoServiceJson.id;
            if(thisAnmoServiceId == serviceId){
                thisServiceJson = thisAnmoServiceJson;
            }
        }
    }
    if(sangnaServiceTypeJson){
        for(var k = 0;k < sangnaServiceTypeJson.length;k++){
            var thisSangnaServiceJson = sangnaServiceTypeJson[k];
            var thisSangnaServiceId = thisSangnaServiceJson.id;
            if(thisSangnaServiceId == serviceId){
                thisServiceJson = thisSangnaServiceJson;
            }
        }
    }
    serviceName = thisServiceJson.service_name;
    servicePrice = thisServiceJson.service_price;
    serviceShichang = thisServiceJson.service_shichang;
    jishiIdStr = thisServiceJson.jishi_real_id_str;
    tichengStr = thisServiceJson.service_jishi_ticheng_str;
    //alert(serviceName + servicePrice + serviceShichang + jishiIdStr + tichengStr)
    getJishiTicheng();
}
function getJishiTicheng(){
    var tichengAllArr = tichengStr.split(',');
    for(var j = 0;j < tichengAllArr.length;j++){
        var thisStr = tichengAllArr[j];
        var thisArr = thisStr.split(':');
        var thisJishiId = thisArr[0];
        var thisJishiTicheng = thisArr[1];
        var thisKey = 'jishi'+thisJishiId;
        tichengArr[thisKey] = thisJishiTicheng;
        //alert(thisKey + '->' + tichengArr[thisKey]);
    }
    getData();
}
function getData(){
    api.ajax({
        url: appUrl+'Get/selectJishiByJingli',
        method: 'post',
        data: {
            values: { 
                jishi_id_str: jishiIdStr
            }
        }
    }, function(ret, err) {
        //alert(JSON.stringify(ret));
        if (ret) {
            if(ret.has == 1){
                jishiArr = ret.data;
                buildPage();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
apiready = function(){
    api.parseTapmode();
    header = $api.byId('misHeader');
    fixStatusBar(header);
    zhongfangId = api.pageParam.zhongfangId;
    dingdanId = api.pageParam.dingdanId;
    jingliLiushuiId = api.pageParam.jingliLiushuiId;
    roomId = api.pageParam.roomId;
    roomName = api.pageParam.roomName;
    serviceType = api.pageParam.serviceType;
    serviceId = api.pageParam.serviceId;
    oldJishiId = api.pageParam.jishiId;
    oldJishiPaihao = api.pageParam.jishiPaihao;
    getServiceInfo();
    shuaxin();
}      
</script>
</html>