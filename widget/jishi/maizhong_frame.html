<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <div class="aui-content aui-card aui-noborder">       
        <div class="aui-form" style="margin-top:30px;">
            <p style="font-size: 18px;" class="aui-text-danger"><b id="banciBox"></b></p>
            <p style="font-size: 18px;" class="aui-text-danger">买钟单钟价格：<b id="maizhongMoney"></b>元</p>
            <div class="aui-input-row">
                <span class="aui-input-addon" style="color:red">买钟起始时间</span>
                <input type="text" class="aui-input" style="color:blue" tapmode onclick="selectTime()" placeholder="点击选择时间(取整点或半点)" id="timeBox" value="" />
            </div>
            <div class="aui-input-row">
                <span class="aui-input-addon">选择买钟时长</span>
                <div class="aui-pull-left" id="shichangBox">
                    <input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(1)" id="shichang1" value="1"> <span class="aui-radio-name">1</span>
                    <input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(2)" id="shichang2" value="2"> <span class="aui-radio-name">2</span>
                    <input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(3)" id="shichang3" value="3"> <span class="aui-radio-name">3</span>
                    <input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(4)" id="shichang4" value="4"> <span class="aui-radio-name">4</span>
                    <input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(5)" id="shichang5" value="5"> <span class="aui-radio-name">5</span>
                </div>
            </div>
            <p style="font-size: 18px;" id="msgBox" class="aui-text-danger aui-hidden">前台缴费金额：<b id="allMoney"></b>元<br>买到：<b id="backTime"></b></p>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="checkMaizhong()">确定买钟</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/laytpl.js" ></script>
<script type="text/javascript">
var shichang = 0;
var canSend = 0;
var isToday = 0;
var cacheBanci = $api.getStorage('cacheBanci');
var userBanciId = $api.getStorage('userBanciId');
// alert(userBanciId)
// alert(JSON.stringify(cacheBanci))
var thisBanciJson = cacheBanci[userBanciId];
var companyId = $api.getStorage('companyId');
var userId = $api.getStorage('userId');
var userName = $api.getStorage('userName');
var userTel = $api.getStorage('userTel');
var missionDay = $api.getStorage('missionDay');
var maizhongMoney = $api.getStorage('cacheCompany').jishi_maizhong;
var allMoney = 0;
var startTime = '';
var startTimeStr = '';
var endTimeStr = '';
var banciName,banciEndHour,banciEndMin,banciStartHour;
//alert(jishiMaizhongMoney)
function removeSelect(){
    var buttonStr = '<input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(1)" id="shichang1" value="1"> <span class="aui-radio-name">1</span><input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(2)" id="shichang2" value="2"> <span class="aui-radio-name">2</span><input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(3)" id="shichang3" value="3"> <span class="aui-radio-name">3</span><input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(4)" id="shichang4" value="4"> <span class="aui-radio-name">4</span><input class="aui-radio aui-radio-danger" type="radio" name="shichang" onclick="changeShichang(5)" id="shichang5" value="5"> <span class="aui-radio-name">5</span>';
    $api.html($api.byId('shichangBox'), buttonStr);
}
function selectTime(){
    var myDate = new Date();
    var year = myDate.getFullYear(); 
    var month = myDate.getMonth()+1;
    var day = myDate.getDate();
    var hour = myDate.getHours();
    var minute = myDate.getMinutes();
    var second = myDate.getSeconds();  
    //var typeStr = 'date_time';
    //var styleStr = year + '-'+month+'-'+day+' '+hour+':'+minute;
    var typeStr = 'time';
    var styleStr = hour+':'+minute;
    //alert(year + '-'+month+'-'+day+' 12:30');
    api.openPicker({
        type: typeStr,
        date: styleStr,
        title: '选择起始时间'
    }, function(ret, err){
        if( ret ){
             if(ret.hour >6 && ret.hour <= 12){
                api.toast({
                    msg: '该时间段不必买钟',
                    duration: 2000,
                    location: 'bottom'
                });
             }else{
                if(ret.hour >= 12 && ret.hour < hour){
                    api.toast({
                        msg: '亲，这个时间点过去了',
                        duration: 2000,
                        location: 'bottom'
                    });
                }else{
                    if(ret.hour < banciStartHour){
                        alert('你还没上班呢！')
                        return false;
                    }else{
                        selectHour = parseInt(ret.hour);
                        selectMinute = parseInt(ret.minute);
                        if(selectMinute >=30){
                            selectHour ++;
                            selectMinute = 0;
                        }else{
                            if(selectMinute != 0){
                                selectMinute = 30;
                            }
                        }
                        if(selectHour < 10){
                            var selectHourStr = '0'+selectHour;
                        }else{
                            var selectHourStr = selectHour
                        }
                        if(selectMinute < 10){
                            var selectMinuteStr = '0'+selectMinute;
                        }else{
                            selectMinuteStr = selectMinute;
                        }
                        if(selectHour < 12){
                            isToday = 0;
                        }else{
                            isToday = 1;
                        }
                        var timeObj = $api.byId('timeBox');
                        startTime = selectHourStr + ':' + selectMinuteStr;
                        startTimeStr = selectHourStr + ':' + selectMinuteStr + ':00'
                        var showTime = selectHourStr + '时' + selectMinuteStr + '分';
                        $api.val(timeObj, showTime);
                        shichang = 0;
                        setTimeout("removeSelect()",50);
                        $api.addCls($api.byId('msgBox'), 'aui-hidden');
                    }
                }
             }  
        }else{
             api.toast({
                 msg: '选择错误',
                 duration: 2000,
                 location: 'bottom'
             });
        }
    });
}
Date.prototype.Format = function (fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
function changeShichang(index){
    shichang = index;
    if(startTime == ''){
        endTimeStr = '';
        allMoney = 0;
        canSend = 0;
        $api.addCls($api.byId('msgBox'), 'aui-hidden');
        alert('请先选择起始时间');
        setTimeout("removeSelect()",20);
        return false;
    }else{
        var selectTimeStr = missionDay +' '+startTime + ':00';
        //alert(selectTimeStr);
        selectTimeStr = selectTimeStr.replace(/-/g,"/");
        var selectTime = new Date(selectTimeStr);
        var selectTimeNum = selectTime.getTime();
        if(isToday ==1){
            var shichangNum = shichang  * 3600 * 1000;
        }else{
            var shichangNum = (24+shichang)  * 3600 * 1000;
        }
        var endTimeNum = selectTimeNum + shichangNum;
        var endTime = new Date(endTimeNum);
        var endHour = endTime.getHours();
        if(endHour < 12){
            var endHour1 = 24+endHour;
        }else{
            var endHour1 = endHour;
        }
        if(banciEndHour < 12){
            var banciEndHour1 = 24+parseInt(banciEndHour);
        }else{
            var banciEndHour1 = parseInt(banciEndHour);
        }
        //alert(endHour1 +'-' + parseInt(banciEndHour1));
        if(endHour1 >parseInt(banciEndHour1)){
            shichang = 0;
            endTimeStr = '';
            allMoney = 0;
            setTimeout("removeSelect()",20);
            $api.addCls($api.byId('msgBox'), 'aui-hidden');
            alert('都下班了，别买了，亲~');
            canSend = 0;
            return false;
        }else{
            endTimeStr = new Date(endTimeNum).Format("yyyy-MM-dd hh:mm:ss");
            canSend = 1;
            allMoney = parseInt(maizhongMoney) * parseInt(shichang);
            //alert('开始时间是' + selectTimeNum +'，增加时间是' + shichangNum + '，结束时间是' + endTimeNum + '，字符串为'+endTimeStr);
            $api.html($api.byId('backTime'), endTimeStr);
            $api.html($api.byId('allMoney'), allMoney);
            $api.removeCls($api.byId('msgBox'), 'aui-hidden');
        }  
    } 
}
function checkMaizhong(){
    if(canSend == 0){
        alert('请选择好买钟起始时间与时长');
        return false;
    }
    if(canSend == 1){
        var allMoney = parseInt(maizhongMoney) * parseInt(shichang);
        api.confirm({
            title: '确认信息',
            msg: '你确定要买'+shichang+'个钟，交费'+allMoney+'元吗？',
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret) {
                
                if(ret.buttonIndex == 1){
                    //alert(JSON.stringify(ret))
                    sendMaizhong();
                }
            }
        });
        
    }
}
function sendMaizhong(){
    api.ajax({
        url: appUrl+'Add/newMaizhongByJingli',
        method: 'post',
        data: {
            values: { 
                company_id:companyId,
                user_id:userId,
                user_name:userName,
                user_tel:userTel,
                jishi_id:0,
                shichang:shichang,
                maizhong_money:maizhongMoney,
                all_money:allMoney,
                maizhong_type:0,
                maizhong_day:missionDay,
                start_time:startTimeStr,
                end_time:endTimeStr.substring(11)
            }
        }
    }, function(ret, err) {
        if (ret) {
            alert('买钟成功，请先到前台缴费'+allMoney+'元，再扫码离开');
            api.closeWin();
        } else {
            //alert(JSON.stringify(err))
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function getBanci(){
    //alert(JSON.stringify(thisBanciJson))
    banciName = thisBanciJson.banci_name;
    banciEndHour = thisBanciJson.banci_end_hour;
    banciEndMin = thisBanciJson.banci_end_min;
    banciStartHour = thisBanciJson.banci_start_hour;
    if(banciEndHour < 10){
        var banciEndHourStr = '0' + banciEndHour;
    }else{
        var banciEndHourStr = banciEndHour;
    }
    if(banciEndMin < 10){
        var banciEndMinStr = '0' + banciEndMin;
    }else{
        var banciEndMinStr = banciEndMin;
    }
    var banciStr = '班次：'+banciName+'，下班时间：'+banciEndHourStr+':'+banciEndMinStr
    $api.html($api.byId('banciBox'), banciStr);
    $api.html($api.byId('maizhongMoney'), maizhongMoney);
}
apiready = function(){
    api.parseTapmode();
    getBanci();
}
        
</script>
</html>