<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style>
html { background: #f7f9f8;}
</style>
<body>
    <div class="aui-content-padded icons" style="padding-top: 20px;">
        <ul class="aui-grid-nine" id="viewBox">
            <li class="aui-col-xs-3 aui-text-center" tapmode onclick="changeTouxiang()"><img id="touxiang" src="" style="width:40px;height:40px;border-radius: 50%;"><p>点击更换</p></li>
            <li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnSave()"><img src="../image/baocuntupian.png" style="width:40px;border-radius: 50%;"><p>保存</p></li>
            <li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnReset()"><img src="../image/reset.png" style="width:40px;border-radius: 50%;"><p>重置</p></li>
            <li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnClose()"><img src="../image/close.png" style="width:40px;border-radius: 50%;"><p>关闭</p></li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript">
var uiMediaScanner = null, imageFilter = null,FNImageClip=null;
var isIOS = false;
var returnUrl;
var touxiangUrl;
function showTouxiang(cacheImgUrl){
    //alert(cacheImgUrl);
    $api.attr($api.byId('touxiang'), 'src', cacheImgUrl);
}
// 生成guid,主要用于生成随机文件名
function NewGuid() {
        function S4() {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }

        return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
}

// 获取当前的时间，拼接成2015-11-09这样的格式，主要用于对图片进行时间分类
function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
                month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
                strDate = "0" + strDate;
        }
        var currentdate = year + seperator1 + month + seperator1 + strDate
        return currentdate;
}

// 获取文件拓展名
function getExt(fileName) {
        return fileName.substring(fileName.lastIndexOf('.') + 1);
}

// 图片压缩
// imgsrc：源图片的路径
// quality：图片压缩质量，一般建议0.5
// scale：图片压缩比例，也是建议0.5
// ext：源图片拓展名
// callback：转换成功之后回调函数
function imgCompress(imgsrc, quality, scale, ext, callback) {
        // 压缩文件的保存目录
        var savePath = api.cacheDir + "/" + getNowFormatDate() + "/";
        // 压缩文件生成的随机文件名称
        var savename = NewGuid() + "." + ext;
        imageFilter.compress({
                img : imgsrc,
                quality : quality,
                scale : quality,
                save : {
                        album : false,
                        imgPath : savePath,
                        imgName : savename
                }
        }, function(ret, err) {
                if (ret) {
                        callback(savePath + savename);
                } else {
                        alert(JSON.stringify(err));
                }
        });
}
function fnSave(){
    //alert(returnUrl)
    FNImageClip.save({
        destPath: returnUrl,
        copyToAlbum: false,
        quality: 1
    },function(ret, err){        
        if(ret) {
            var imgUrl = ret.destPath;
            // alert($api.getStorage('userId'))
            // return false;
            api.ajax({
                url: appUrl+'Upload/uploadTouxiang',
                method: 'post',
                data: {
                    values: { 
                        user_id: $api.getStorage('userId'),
                        company_id:$api.getStorage('companyId'),
                        user_tel:$api.getStorage('userTel'),
                        user_type:$api.getStorage('userType')
                    },
                    files: { 
                        pic: imgUrl
                    }
                }
            }, function(ret, err) {
                if (ret) {
                    if (ret.statu == 1) {
                            //alert(JSON.stringify(ret));
                            var imgPath = ret.path;
                            api.sendEvent({
                                name: 'changeTouxiang',
                                extra: {
                                    imgPath: imgPath
                                }
                            });
                            fnClose();
                            api.closeWin({
                                name: 'change_touxiang'
                            });
                    } else if (ret.statu == 0) {
                            alert("上传失败");
                    }
                } else {
                    api.toast({
                        msg: '网络错误'
                    });
                }
            });
        } else{
            alert(JSON.stringify(err));
        }
    });
}
function fnClose(){
    FNImageClip.close();
}
function fnReset(){
    FNImageClip.reset();
}
function changeTouxiang(){
    api.actionSheet({
            title : '选择图片',
            buttons : ['优雅自拍', '浏览相册']
    }, function(ret, err) {
            var index = ret.buttonIndex;
            switch(index) {
                    // 拍照
                    case 1:
                        // 打开拍照
                        api.getPicture({
                                sourceType : "camera",
                                encodingType : "jpg",
                                destinationType : "url",
                                mediaValue : "pic",
                                quality : 50,
                                saveToPhotoAlbum : true
                        }, function(ret, err) {
                                if (ret && ret.data) {
                                        // 拍照返回的本地路径
                                        returnUrl = ret.data;
                                        //alert(returnUrl);
                                        //var url = appUrl+'Upload/uploadTouxiang';
                                        FNImageClip.open({
                                            rect: {
                                                x: 0,
                                                y: 200,
                                                w: api.winWidth,
                                                h: api.winHeight - 200
                                            },
                                            srcPath: returnUrl,
                                            style: {
                                                mask: '#888',
                                                clip: {
                                                    w: 200,
                                                    h: 200,
                                                    x: (api.winWidth-200)/2,
                                                    y: (api.winHeight - 400)/2,
                                                    borderColor: 'red',
                                                    borderWidth: 1,
                                                    appearance: 'rectangle'
                                                }
                                            },
                                            fixedOn: api.frameName
                                        }, function(ret, err){        
                                            if( ret ){
                                                //alert( JSON.stringify( ret ) );
                                            }else{
                                                alert( JSON.stringify( err ) );
                                            }
                                        });
                                        // imgCompress(returnUrl, 0.5, 0.5, getExt(returnUrl), function(compressImg) {
                                        //         $api.attr($api.byId('touxiang'), 'src', compressImg);
                                        //         api.ajax({
                                        //                 url : url,
                                        //                 method : 'post',
                                        //                 timeout : 30,
                                        //                 dataType : 'json',
                                        //                 returnAll : false,
                                        //                 data : {
                                        //                         files : {
                                        //                                 "pic" : compressImg
                                        //                         }
                                        //                 }
                                        //         }, function(ret, err) {
                                        //                 if (ret) {
                                        //                         if (ret.statu == 1) {
                                        //                                 alert(JSON.stringify(ret));
                                        //                         } else if (ret.statu == 0) {
                                        //                                 alert("上传失败");
                                        //                         }
                                        //                 } else {
                                        //                         api.alert({
                                        //                                 msg : ('错误码：' + err.code + '；错误信息：' + err.msg + '；网络状态码：' + err.statusCode)
                                        //                         });
                                        //                 }
                                        //         }); 
                                        // });
                                        
                                        
                                        // var normalW = 100;
                                        // var showImgHtml = '<li class="aui-list-view-cell aui-img aui-col-xs-4"><img class="aui-img-object" src="' + returnUrl + '" style="width:' + normalW + 'px;height:' + normalW + 'px;"></li>';
                                        
                                } else {
                                        api.toast({
                                                msg : '没有选择，或者选择出错'
                                        });
                                }
                        });
                        break;
                        // 打开图片选择器
                        case 2:
                                uiMediaScanner.open({
                                        type : 'picture',
                                        column : 4,
                                        classify : true,
                                        max : 1,
                                        sort : {
                                                key : 'time',
                                                order : 'desc'
                                        },
                                        texts : {
                                                stateText : '已选*项',
                                                cancelText : '取消',
                                                finishText : '完成'
                                        },
                                        styles : {
                                                bg : '#fff',
                                                mark : {
                                                        icon : '',
                                                        position : 'bottom_left',
                                                        size : 20
                                                },
                                                nav : {
                                                        bg : '#b23e4b',
                                                        stateColor : '#fff',
                                                        stateSize : 18,
                                                        cancelBg : 'rgba(0,0,0,0)',
                                                        cancelColor : '#fff',
                                                        cancelSize : 18,
                                                        finishBg : 'rgba(0,0,0,0)',
                                                        finishColor : '#fff',
                                                        finishSize : 18
                                                }
                                        }
                                }, function(ret) {
                                        if (ret) {
                                           for (var i = 0; i < ret.list.length; i++) {
                                                   var selectImg = ret.list[i];
                                                   // 获取图片的路径
                                                   var selectimgPath = selectImg.path;
                                                   var selectimgThumbPath = selectImg.thumbPath;
                                                   // IOS需要将虚拟路径转换为本地路径才可以压缩
                                                   if (isIOS) {
                                                           // 转换为真实路径
                                                           uiMediaScanner.transPath({
                                                                   path : selectimgPath
                                                           }, function(transObj) {
                                                                   // 图片压缩
                                                                   imgCompress(transObj.path, 0.5, 0.5, selectImg.suffix, function(compressImg) {
                                                                            returnUrl = compressImg;

                                                                           FNImageClip.open({
                                                                               rect: {
                                                                                   x: 0,
                                                                                   y: 200,
                                                                                   w: api.winWidth,
                                                                                   h: api.winHeight - 200
                                                                               },
                                                                               srcPath: compressImg,
                                                                               style: {
                                                                                   mask: '#888',
                                                                                   clip: {
                                                                                       w: 200,
                                                                                       h: 200,
                                                                                       x: (api.winWidth-200)/2,
                                                                                       y: (api.winHeight - 400)/2,
                                                                                       borderColor: 'red',
                                                                                       borderWidth: 1,
                                                                                       appearance: 'rectangle'
                                                                                   }
                                                                               },
                                                                               fixedOn: api.frameName
                                                                           }, function(ret, err){        
                                                                               if( ret ){
                                                                                   //alert( JSON.stringify( ret ) );
                                                                               }else{
                                                                                   alert( JSON.stringify( err ) );
                                                                               }
                                                                           });
                                                                   });
                                                           });
                                                   } else {
                                                           // 图片压缩
                                                           imgCompress(selectimgPath, 0.5, 0.5, selectImg.suffix, function(compressImg) {
                                                                   // 追加图片
                                                                   returnUrl = compressImg
                                                                   FNImageClip.open({
                                                                       rect: {
                                                                           x: 0,
                                                                           y: 200,
                                                                           w: api.winWidth,
                                                                           h: api.winHeight - 200
                                                                       },
                                                                       srcPath: compressImg,
                                                                       style: {
                                                                           mask: '#888',
                                                                           clip: {
                                                                               w: 200,
                                                                               h: 200,
                                                                               x: (api.winWidth-200)/2,
                                                                               y: (api.winHeight - 400)/2,
                                                                               borderColor: 'red',
                                                                               borderWidth: 1,
                                                                               appearance: 'rectangle'
                                                                           }
                                                                       },
                                                                       fixedOn: api.frameName
                                                                   }, function(ret, err){        
                                                                       if( ret ){
                                                                           //alert( JSON.stringify( ret ) );
                                                                       }else{
                                                                           alert( JSON.stringify( err ) );
                                                                       }
                                                                   });
                                                           });
                                                   }
                                           }
                                   }
                           });
                           break;
            }
    });
}
function getCacheImgUrl(realImgUrl,fn){
    //alert(realImgUrl);
    //var cacheUrl;
    api.imageCache({
        url: touxiangUrl
    }, function(ret, err){
        if( ret ){
             //alert( JSON.stringify( ret ) );
             //alert(ret.url)
             cacheUrl = ret.url;
             fn(cacheUrl);
        }else{
             //alert( JSON.stringify( err ) );
             cacheUrl = realImgUrl;
             fn(cacheUrl);
             //return cacheUrl;
        }
    });
    //cacheUrl = 1;
    
    //return cacheUrl;
}
apiready = function(){
    // 引入多选模块
    uiMediaScanner = api.require('UIMediaScanner');
    // 引入过滤压缩模块
    imageFilter = api.require("imageFilter");
    FNImageClip = api.require('FNImageClip');
    // 判断是否是IOS系统
    isIOS = api.systemType == "ios" ? true : false;
    if(!$api.getStorage('touxiangUrl')){
        touxiangUrl = '../image/dianji.png';
    }else{
        touxiangUrl = $api.getStorage('touxiangUrl');
    }
    getCacheImgUrl(touxiangUrl,showTouxiang);
}

</script>
</html>