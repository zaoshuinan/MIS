<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 55px;
}
</style>
<body>
     <div class="aui-card aui-noborder" style="margin-top:10px;padding:10px;">
        <ul class="aui-grid-nine" id="viewBox">

        </ul>
    </div>
    <footer class="aui-nav" id="aui-footer">
        <div class="aui-col-xs-12 aui-bg-danger" id="saveBtn">点击上方产品以选择</div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript">
var dingdanId,roomName,peitaoIdStr,peitaoNameStr,jishiPaihao;
var companyId = $api.getStorage('companyId');
var missionDay = $api.getStorage('missionDay');
var userType = $api.getStorage('userType');
var userId = $api.getStorage('userId');
var userName = $api.getStorage('userName');
var jishiPaihao = $api.getStorage('jishiPaihao');
var userTel = $api.getStorage('userTel');
var peitaoIdArr = Array();
var peitaoJson = $api.getStorage('cachePeitao');
var peitaoNameArr = Array();
function buildPage(){
    peitaoIdArr = peitaoIdStr.split(',');
    peitaoNameArr = peitaoNameStr.split(',');
    var htmlStr = '';
    for(var i = 0; i < peitaoIdArr.length; i++){
        var showNum;
        if(peitaoIdArr.length == 1){
            showNum = 12;
        }
        if(peitaoIdArr.length == 2){
            showNum = 6;
        }
        if(peitaoIdArr.length == 3){
            showNum = 4;
        }
        if(peitaoIdArr.length == 4){
            showNum = 3;
        }
        if(peitaoIdArr.length > 4){
            showNum = 3;
        }
        var tplStr = '<li class="aui-col-xs-'+showNum+' aui-text-center" tapmode onclick="saveChanpin('+i+')"><img src="../image/peitao.png" style="width:60px"><p>'+peitaoNameArr[i]+'</p></li>';
        htmlStr += tplStr;
    }
    $api.html($api.byId('viewBox'), htmlStr);
}
function saveChanpin(index){
    var peitaoName = peitaoNameArr[index];
    //alert(peitaoName)
    var peitaoId = peitaoIdArr[index];
    var peitaoPrice = peitaoJson[peitaoId].peitao_price;
    var peitaoTicheng = peitaoJson[peitaoId].peitao_ticheng;
    api.confirm({
        title: '选择确认',
        msg: '你确认选择'+peitaoName+'吗？',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                var valueJson = { 
                    peitao_id: peitaoId,
                    peitao_name:peitaoName,
                    dingdan_id:dingdanId,
                    company_id:companyId,
                    jishi_paihao:jishiPaihao,
                    jishi_tel:userTel,
                    jishi_id:$api.getStorage('jishiId'),
                    peitao_price:peitaoPrice,
                    peitao_ticheng:peitaoTicheng,
                    room_haoma:roomName,
                    mission_day:missionDay
                }
                // alert(JSON.stringify(valueJson));
                // return false;
                api.ajax({
                    url: appUrl+'Add/peitaoLiushui',
                    method: 'post',
                    data: {
                        values: valueJson
                    }
                }, function(ret, err) {
                    if (ret) {
                        //alert(ret.id);
                        api.toast({
                            msg: '已发送信息，请等待配送'
                        });
                        api.closeWin();
                    } else {
                        api.toast({
                            msg: '网络错误'
                        });
                    }
                });
            }
        } else {
            alert(JSON.stringify(err));
        }
    });
}
apiready = function(){
    api.parseTapmode();
    dingdanId = api.pageParam.dingdanId;
    peitaoIdStr = api.pageParam.peitaoIdStr;
    peitaoNameStr = api.pageParam.peitaoNameStr;
    roomName = api.pageParam.roomName;
    buildPage();
}
    
</script>
</html>