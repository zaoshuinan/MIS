<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div class="aui-content-padded icons" style="padding-top: 20px;">
        <ul class="aui-grid-nine" id="viewBox1">
            
        </ul>
    </div>
    
    <div class="aui-content-padded icons" style="padding-top: 20px;">
        <ul class="aui-user-view">
            <li class="aui-user-view-cell aui-img" id="viewBox">
                <div style="text-align: center;">
                    <div class="loading-2">
                        <i></i>
                        <i></i>
                        <i></i>
                        <i></i>
                        <i></i>
                    </div>
                    <p style="color:black">检测状态</p>
                </div>
            </li>
        </ul>
    </div>

    <div class="aui-content-padded icons aui-hidden" id="querenBox" style="padding-top: 20px;">
        <ul class="aui-grid-nine">
            <li class="aui-col-xs-6 aui-text-center" tapmode onclick="openQueren()"><img src="../image/queren.png" style="width:40px"><p>客户确认</p><li class="aui-col-xs-6 aui-text-center" tapmode onclick="openChange()"><img src="../image/quxiao.png" style="width:40px"><p>更换技师</p></li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/laytpl.js" ></script>
<script type="text/javascript">
var dingdanId,companyId,jishiId,jishiTel,jishiPaihao,hasCheck,zhongfangId,jishiLiushuiId,selectRoomId,selectRoomName,serviceId,serviceTicheng,serviceShichang,servicePrice,serviceType,jingliLiushuiId,jiazhongPrice,jiazhongTicheng,jiazhongAllMoney,jiazhongAllTicheng,oldJiazhongNum,showTime,jishiDayNum,jishiAllNum;
var daojishiObj,chaSecond;
var missionDay = $api.getStorage('missionDay');
var myId,myName,myTel;
var hasShangzhong = 0;
var jiazhongNum = 0;
var dayNum = $api.getStorage('dayNum');
var allNum = $api.getStorage('allNum');
var cacheService = $api.getStorage('cacheService');
var thisServiceJson;
//alert(JSON.stringify($api.getStorage('cacheService')))
function openQueren(){
    var viewBox = $api.byId('viewBox');
    api.confirm({
        title: '系统信息',
        msg: '客户是否同意让你上钟',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                api.ajax({
                    url: appUrl+'Change/querenDingdan',
                    method: 'post',
                    data: {
                        values: { 
                            zhongfang_id:zhongfangId,
                            dingdan_id:dingdanId,
                            jishi_liushui_id:jishiLiushuiId,
                            jingli_liushui_id:jingliLiushuiId,
                            jishi_id:jishiId,
                            shichang:serviceShichang,
                            room_name:selectRoomName
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                        $api.setStorage('working', 1);
                        var zhongButton = $api.byId('zhongButton');
                        var zhongName = $api.byId('zhongName');
                        var zhongImg = $api.byId('zhongImg');
                        hasShangzhong = 1;
                        $api.html(zhongName, '下钟');
                        $api.attr(zhongImg, 'src', '../image/xiazhong.png');
                        $api.html(viewBox, '<img class="aui-img-object aui-pull-left" src="../image/yewutongzhi.png"><div class="aui-img-body">上钟啦，当前房间:'+selectRoomName+'！<p class="aui-ellipsis-1">感谢你的辛勤付出！</p></div>');
                        $api.html($api.byId('querenBox'), '<ul class="aui-grid-nine"><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenPeitao()"><img src="../image/peitao.png" style="width:40px"><p>配套</p></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenMianfei()"><img src="../image/mianfei.png" style="width:40px"><p>免费</p></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenShoufei()"><img src="../image/shoufei.png" style="width:40px"><p>收费</p></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenJiazhong()"><img src="../image/jiazhong1.png" style="width:40px"><p>加钟</p></li></ul><p style="color:red;padding:10px;font-size:16px;" id="fuwuBox">本服务价格'+servicePrice+'元，技师提成：'+serviceTicheng+'元</p><p style="color:red;padding:10px;font-size:16px;"  id="jiazhongBox"></p>');
                    } else {
                        api.toast({
                            msg: '网络错误'
                        });
                    }
                }); 
            }
        }
    });   
}
function openChange(){
    api.confirm({
        title: '更换技师',
        msg: '你确认被客户取消并更换技师吗？',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                api.ajax({
                    url: appUrl+'Change/genghuanJishi',
                    method: 'post',
                    data: {
                        values: { 
                            zhongfang_id: zhongfangId,
                            jingli_liushui_id:jingliLiushuiId,
                            jishi_id:jishiId,
                            jishi_liushui_id:jishiLiushuiId
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                        if(ret.has == 1){
                            api.toast({
                                msg: '已通知钟房更换技师，继续努力！'
                            });
                            var zhongButton = $api.byId('zhongButton');
                            var zhongName = $api.byId('zhongName');
                            var zhongImg = $api.byId('zhongImg');
                            hasShangzhong = 0;
                            hasCheck = 0;
                            $api.html(zhongName, '上钟');
                            $api.attr(zhongImg, 'src', '../image/shangzhong.png');
                            $api.html(viewBox, '<img class="aui-img-object aui-pull-left" src="../image/yewutongzhi.png"><div class="aui-img-body"><span>你暂时还没有上钟业务呢！亲~<p class="aui-ellipsis-1">接钟房通知后点击上钟按钮刷新~</p></div>');
                            $api.addCls($api.byId('querenBox'), 'aui-hidden');
                        }
                        //alert(JSON.stringify(ret));
                    } else {
                        api.toast({
                            msg: '网络错误'
                        });
                        //alert(JSON.stringify(err));
                    }
                });
            }
        } 
    });
}
function openMaizhong(){
    api.actionSheet({
        destructiveTitle: '我要买钟',
        buttons: ['买钟历史']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                addMaizhong()
            }
            if(ret.buttonIndex == 2){
                maizhongHistroy()
            }
        }
    });
}
function addMaizhong(){
    api.confirm({
        title: '确认信息',
        msg: '你确认需要买钟吗？',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            //alert(JSON.stringify(ret));
            if(ret.buttonIndex == 1){
                api.openWin({
                    name: 'addMaizhong',
                    url: './maizhong_win.html',
                    pageParam: {
                        name: 'value'
                    }
                });
            }
        }
    });
}
function maizhongHistroy(){
    api.openWin({
        name: 'maizhongHistroy',
        url: './maizhong_histroy_win.html',
        pageParam: {
            name: 'value'
        }
    });
}
function buildButtons(){
    var viewBox = $api.byId('viewBox');
    var innerStr1 = '<li class="aui-col-xs-3 aui-text-center" tapmode onclick="openYuyue()"><img src="../image/yuyue.png" style="width:60px"><p>预约</p></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="openMaizhong()"><img src="../image/maizhong.png" style="width:60px"><p>买钟</p></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="openQingjia()"><img src="../image/qingjia1.png" style="width:60px"><p>请假</p></li><li id="zhongButton" class="aui-col-xs-3 aui-text-center" tapmode onclick="checkShangzhong()"><img id="zhongImg" src="../image/shangzhong.png" style="width:60px"><p id="zhongName">上钟</p></li>';
    
    $api.html($api.byId('viewBox1'), innerStr1);
}
function xiazhong(){
    //alert($api.getStorage('working'))
    api.confirm({
        title: '确认下钟',
        msg: '你确认要下钟吗？',
        buttons: ['确定', '取消']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                checkXiazhong()
            }
        }
    });
}
function checkXiazhong(){
    api.ajax({
        url: appUrl+'Get/xiazhongTime',
        method: 'post',
        data: {
            values: { 
                valueName: 'value'
            }
        }
    }, function(ret, err) {
        if (ret) {
            var thisTimeStr = ret.time;
            startTimeStr = startTimeStr.replace(/-/g,"/");
            thisTimeStr = thisTimeStr.replace(/-/g,"/");
            var startTime = new Date(startTimeStr);
            var thisTime = new Date(thisTimeStr);
            var startTimeNum = startTime.getTime();
            var thisTimeNum = thisTime.getTime();
            var shichangNum = serviceShichang  * 60 * 1000;
            var endTimeNum = startTimeNum + shichangNum;
            var lineNum =  20 * 60 * 1000;
            var lineTimeNum = endTimeNum - lineNum;
            //alert(startTimeStr +':' + startTimeNum+ '-' + thisTimeStr+':'+thisTimeNum + '-' + endTimeNum + '-' + lineTimeNum);
            if(thisTimeNum > endTimeNum){
                var chaochuNum = thisTimeNum - endTimeNum;
                var chaochuMin = parseInt(chaochuNum / 60000);
                msg = '现在时间是：'+thisTimeStr.substr(11)+'，超出'+chaochuMin+'分钟！感谢你的付出';
            }else{
                if(thisTimeNum < lineTimeNum){
                    var chaNum = endTimeNum - thisTimeNum;
                    var chaMin = parseInt(chaNum / 60000);
                    msg = '离下钟时间还有'+chaMin+'分钟呢！你确定要提前下钟？';
                }else{
                    msg = '现在的时间是：'+thisTimeStr.substr(11)+'，正常下钟'
                }
            }
            api.confirm({
                title: '下钟确认信息',
                msg: msg,
                buttons: ['确定', '取消']
            }, function(ret, err) {
                if (ret) {
                    if(ret.buttonIndex == 1){
                        addEvent();
                        openQuerenWin()
                    }
                }
            });
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function addEvent(){
    api.addEventListener({
        name: 'hasXiazhong'
    }, function(ret, err) {
        if (ret) {
            $api.setStorage('working', 0);
            var zhongButton = $api.byId('zhongButton');
            var zhongName = $api.byId('zhongName');
            var zhongImg = $api.byId('zhongImg');
            hasShangzhong = 0;
            hasCheck = 0;
            $api.html(zhongName, '上钟');
            $api.attr(zhongImg, 'src', '../image/shangzhong.png');
            $api.html(viewBox, '<img class="aui-img-object aui-pull-left" src="../image/yewutongzhi.png"><div class="aui-img-body"><span>你暂时还没有上钟业务呢！亲~<p class="aui-ellipsis-1">接钟房通知后点击上钟按钮刷新~</p></div>');
            $api.addCls($api.byId('querenBox'), 'aui-hidden');
        }
    });
}
function openQuerenWin(){
    var pageJson = { 
        zhongfangId: zhongfangId,
        dingdanId:dingdanId,
        jishiLiushuiId:jishiLiushuiId,
        jishiId:jishiId,
        jingliLiushuiId:jingliLiushuiId,
        selectRoomId:selectRoomId
    }
    api.openWin({
        name: 'xiazhongQueren',
        url: './xiazhong_queren_win.html',
        pageParam: pageJson
    });
}
function getThisServiceJson(serviceId){
    //alert(cacheService.length)
    var muzuServiceJson = cacheService.muzu;
    var anmoServiceJson = cacheService.anmo;
    var sangnaServiceJson = cacheService.sangna;
    if(muzuServiceJson){
        for(var i = 0;i < muzuServiceJson.length;i++){
            var thisId = muzuServiceJson[i].id;
            if(thisId == serviceId){
                thisJson = muzuServiceJson[i];
            }
        }
    }
    if(anmoServiceJson){
        for(var j = 0;j < anmoServiceJson.length;j++){
            var thisId = anmoServiceJson[j].id;
            if(thisId == serviceId){
                thisJson = anmoServiceJson[j];
            }
        }
    }
    if(sangnaServiceJson){
        for(var k = 0;k < sangnaServiceJson.length;k++){
            var thisId = sangnaServiceJson[k].id;
            if(thisId == serviceId){
                thisJson = sangnaServiceJson[k];
            }
        }
    }
    return thisJson;
}
Date.prototype.Format = function (fmt) { //author: meizz 
    var o = {
        "M+": this.getMonth() + 1, //月份 
        "d+": this.getDate(), //日 
        "h+": this.getHours(), //小时 
        "m+": this.getMinutes(), //分 
        "s+": this.getSeconds(), //秒 
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
        "S": this.getMilliseconds() //毫秒 
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
function checkShangzhong(){
    if(hasShangzhong == 1){
        xiazhong();
    }else{
        if(hasCheck == 1){
            api.toast({
                msg: '已有上钟信息!'
            });
        }else{
            var innerStr = '';
            //alert(jishiId)
                api.ajax({
                    url: appUrl+'Get/jishiShangzhong',
                    method: 'post',
                    data: {
                        values: { 
                            company_id: companyId,
                            mission_day:missionDay,
                            jishi_id:jishiId
                        }
                    }
                },function(ret, err){
                    if (ret) {
                        // alert( JSON.stringify( ret ) );
                        // return false;
                        if(ret.has == 0){
                            hasCheck = 0;
                            //alert('亲，暂时还没有业务呢！')
                            innerStr = '<img class="aui-img-object aui-pull-left" src="../image/yewutongzhi.png"><div class="aui-img-body"><span>你暂时还没有上钟业务呢！亲~<p class="aui-ellipsis-1">接钟房通知后点击上钟按钮刷新~</p></div>';
                            $api.html(viewBox, innerStr);
                            $api.addCls($api.byId('querenBox'), 'aui-hidden');
                        }else{
                            hasCheck = 1;
                            //alert(JSON.stringify(ret))
                            var jishiLiushuiData = ret.data;
                            var jishiStatus = jishiLiushuiData.status;
                            dingdanId = jishiLiushuiData.dingdan_id;
                            zhongfangId = jishiLiushuiData.zhongfang_id;
                            serviceTicheng = jishiLiushuiData.ticheng;
                            jishiLiushuiId = jishiLiushuiData.id;
                            jingliLiushuiId = jishiLiushuiData.jingli_liushui_id;
                            serviceId = jishiLiushuiData.service_id;
                            serviceType = jishiLiushuiData.service_type;
                            thisServiceJson = getThisServiceJson(serviceId)
                            // alert(JSON.stringify(thisServiceJson))
                            // return false;
                            //alert(serviceType);
                            serviceName = thisServiceJson.service_name;
                            servicePrice = thisServiceJson.service_price;
                            serviceShichang = thisServiceJson.service_shichang;
                            selectRoomName = jishiLiushuiData.room_name;
                            selectRoomId = jishiLiushuiData.room_id;
                            jiazhongPrice = thisServiceJson.service_jiazhong_price;
                            //alert(jiazhongPrice)
                            jiazhongTicheng = thisServiceJson.service_jiazhong_ticheng;
                            oldJiazhongNum = jishiLiushuiData.jiazhong_num;
                            jiazhongAllTicheng = jishiLiushuiData.jiazhong_ticheng;
                            startTimeStr = jishiLiushuiData.time
                            var showTime = jishiLiushuiData.time.substr(11);
                            if(jishiStatus == 1){
                                innerStr = '<img class="aui-img-object aui-pull-left" src="../image/yewutongzhi.png"><div class="aui-img-body"><span><b style="color:red">'+selectRoomName+'房</b>，'+serviceName+'('+serviceShichang+'分钟)</span><p class="aui-ellipsis-1">请尽快前往房间确认订单！('+showTime+')</p></div>';
                                $api.html(viewBox, innerStr);
                                $api.html($api.byId('querenBox'), '<ul class="aui-grid-nine"><li class="aui-col-xs-6 aui-text-center" tapmode onclick="openQueren()"><img src="../image/queren.png" style="width:40px"><p>客户确认</p><li class="aui-col-xs-6 aui-text-center" tapmode onclick="openChange()"><img src="../image/quxiao.png" style="width:40px"><p>更换技师</p></li></ul><p id="jiazhongBox"></p>');
                            }
                            if(jishiStatus == 2){
                                if(oldJiazhongNum == 0){
                                    var jiazhongStr = '没有加钟信息';
                                }else{
                                    var jiazhongStr = '加钟 X '+oldJiazhongNum+'，提成'+jiazhongAllTicheng+'元';
                                }
                                $api.setStorage('working', 1);
                                var zhongButton = $api.byId('zhongButton');
                                var zhongName = $api.byId('zhongName');
                                var zhongImg = $api.byId('zhongImg');
                                hasShangzhong = 1;

                                var thisTimeStr = ret.time;
                                startTimeStr = startTimeStr.replace(/-/g,"/");
                                thisTimeStr = thisTimeStr.replace(/-/g,"/");
                                var startTime = new Date(startTimeStr);
                                var thisTime = new Date(thisTimeStr);
                                var startTimeNum = startTime.getTime();
                                var thisTimeNum = thisTime.getTime();
                                var shichangNum = serviceShichang  * 60 * 1000;
                                var endTimeNum = startTimeNum + shichangNum;
                                var endTime = new Date(endTimeNum);
                                var endTimeStr = new Date(endTimeNum).Format("yyyy-MM-dd hh:mm:ss"); 
                                chaSecond = (endTimeNum - thisTimeNum)/1000;
                                clearInterval(daojishiObj);
                                daojishiObj = setInterval("daojishi()",1000);
                                
                                //alert(chaStr)
                                //alert(chaNum/1000);
                                var endShowStr = endTimeStr.substr(11);
                                $api.html(zhongName, '下钟');
                                $api.attr(zhongImg, 'src', '../image/xiazhong.png');
                                $api.html(viewBox, '<img class="aui-img-object aui-pull-left" src="../image/yewutongzhi.png"><div class="aui-img-body">'+serviceName+'，当前房间:'+selectRoomName+'<p class="aui-ellipsis-1">开始时间：'+showTime+'，时长：'+serviceShichang+'分钟</p><p class="aui-ellipsis-1">离下钟还有<b id="daoShi" style="color:red">0</b>时<b id="daoFen" style="color:red">0</b>分<b id="daoMiao" style="color:red">0</b>秒<span style="color:red" id="endBox"></span></p></div>');
                                $api.html($api.byId('querenBox'), '<ul class="aui-grid-nine"><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenPeitao()"><img src="../image/peitao.png" style="width:40px"><p>配套</p><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenMianfei()"><img src="../image/mianfei.png" style="width:40px"><p>免费</p></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenShoufei()"><img src="../image/shoufei.png" style="width:40px"><p>收费</p></li></li><li class="aui-col-xs-3 aui-text-center" tapmode onclick="fnOpenJiazhong()"><img src="../image/jiazhong1.png" style="width:40px"><p>加钟</p></li></ul><p style="color:red;padding:10px;font-size:16px;" id="fuwuBox">本服务价格'+servicePrice+'元，技师提成：'+serviceTicheng+'元</p><p style="color:red;padding:10px;font-size:16px;" id="jiazhongBox">'+jiazhongStr+'</p>');
                            }
                            $api.removeCls($api.byId('querenBox'), 'aui-hidden');
                        }
                        
                    } else {
                        api.toast({
                            msg: '网络错误'
                        });
                    }
                });
        }
    }
}
function daojishi(){
    var daoFen = parseInt(chaSecond / 60);
    var daoMiao = parseInt(chaSecond % 60);
    var daoShi = parseInt(daoFen / 60);
    daoFen = parseInt(daoFen % 60);
    if(daoShi <= 0 && daoShi <= 0 && daoMiao <= 0){
        daoShi = '00';
        daoFen = '00';
        daoMiao = '00';
        $api.html($api.byId('endBox'), '(超时)');
    }else{
        if(daoShi < 10){
            daoShi = '0' + daoShi;
        }
        if(daoFen < 10){
            daoFen = '0' + daoFen;
        }
        if(daoMiao < 10){
            daoMiao = '0' + daoMiao;
        }
    }
    
    $api.html($api.byId('daoShi'), daoShi);
    $api.html($api.byId('daoFen'), daoFen);
    $api.html($api.byId('daoMiao'), daoMiao);
    chaSecond --;
}
function fnOpenJiazhong(){
    api.actionSheet({
        destructiveTitle:'加1个钟（价格：'+jiazhongPrice+'元）',
        buttons: ['加2个钟（价格：'+jiazhongPrice*2+'元）','加3个钟（价格：'+jiazhongPrice*3+'元）']
    }, function(ret, err) {
        if (ret) {
            if(oldJiazhongNum == 0){
                if(ret.buttonIndex == 1){
                       jiazhongNum = 1;
                }
                if(ret.buttonIndex == 2){
                       jiazhongNum = 2;
                }
                if(ret.buttonIndex == 3){
                       jiazhongNum = 3;
                }
            }else{
                if(ret.buttonIndex == 1){
                       jiazhongNum = parseInt(oldJiazhongNum) + 1;
                }
                if(ret.buttonIndex == 2){
                       jiazhongNum = parseInt(oldJiazhongNum) +  2;
                }
                if(ret.buttonIndex == 3){
                       jiazhongNum = parseInt(oldJiazhongNum) +  3;
                }
            }
            jiazhongAllMoney = jiazhongPrice * jiazhongNum;
            jiazhongAllTicheng = jiazhongTicheng * jiazhongNum;
            if(oldJiazhongNum == 0){
                var msg = '你确认要加'+jiazhongNum+'个钟吗？收费'+jiazhongAllMoney+'元，提成'+jiazhongAllTicheng+'元！'
            }else{
                var msg = '你已有'+oldJiazhongNum+'个加钟了，目前共有'+jiazhongNum+'个加钟，收费'+jiazhongAllMoney+'元，提成'+jiazhongAllTicheng+'元！确定吗？'
            }
            if(ret.buttonIndex == 1|| ret.buttonIndex == 2 || ret.buttonIndex == 3){
                api.confirm({
                    title: '确认加钟',
                    msg: msg,
                    buttons: ['确定', '取消']
                }, function(ret, err) {
                    if (ret) {
                        //alert(JSON.stringify(ret))
                        if(ret.buttonIndex == 1){
                            addJiazhong();
                        }
                        //addJiazhong();
                    } else {
                        
                    }
                });
            }
        } else {
            alert(JSON.stringify(err));
        }
    });
}
function addJiazhong(){
    api.ajax({
        url: appUrl+'Change/jiazhongByJishi',
        method: 'post',
        data: {
            values: { 
                jishi_liushui_id:jishiLiushuiId,
                dingdan_id:dingdanId,
                jiazhong_num:jiazhongNum,
                jiazhong_money:jiazhongAllMoney,
                jiazhong_ticheng:jiazhongAllTicheng
            }
        }
    }, function(ret, err) {
        if (ret) {
            $api.html($api.byId('jiazhongBox'),'加钟 X '+jiazhongNum+'，提成'+jiazhongAllTicheng+'元');
            alert('加钟成功');
        } else {
            alert(JSON.stringify(err));
        }
    });
}
function fnOpenPeitao(){
    var peitaoJson = thisServiceJson;
    //alert(JSON.stringify(thisServiceJson))
    var peitaoNameStr = peitaoJson.service_peitao_name_str;
    var peitaoIdStr = peitaoJson.service_peitao_id_str;
    //alert(peitaoNameStr)
    api.actionSheet({
        destructiveTitle: '选择配套产品',
        buttons: ['查看所选产品']
    },function(ret,err){
        var winName,winUrl;
        if(ret.buttonIndex == 1){
            winName = 'selectPeitao';
            winUrl = './select_peitao_win.html';
        }
        if(ret.buttonIndex == 2){
            winName = 'showPeitao';
            winUrl = './show_peitao_win.html';
        }
        //alert(winName + winUrl + dingdanId);
        api.openWin({
            name: winName,
            url: winUrl,
            bounces: false,
            slidBackEnabled:false,
            pageParam: {
                dingdanId:dingdanId,
                roomName:selectRoomName,
                peitaoIdStr:peitaoIdStr,
                peitaoNameStr:peitaoNameStr
            }
        });
    });
    //alert(peitaoNameStr + peitaoIdStr);
}
//点击收费产品动作
function fnOpenShoufei(){
    api.actionSheet({
        destructiveTitle: '选择付费产品',
        buttons: [ '查看已选列表']
    },function(ret,err){
        var winName,winUrl;
        if(ret.buttonIndex == 1){
            winName = 'selectShoufei';
            winUrl = './select_shoufei_win.html';
        }
        if(ret.buttonIndex == 2){
            winName = 'showShoufei';
            winUrl = './show_shoufei_win.html';
        }
        api.openWin({
            name: winName,
            url: winUrl,
            bounces: false,
            slidBackEnabled:false,
            pageParam: {
                'dingdanId':dingdanId,
                'roomHaoma':selectRoomName,
                'myId':myId,
                'myName':myName,
                'myTel':myTel
            }
        });
    });
}
//点击免费产品动作
function fnOpenMianfei(){
    api.actionSheet({
        destructiveTitle: '选择免费产品',
        buttons: ['查看已选列表']
    },function(ret,err){
        var winName,winUrl;
        if(ret.buttonIndex == 1){
            winName = 'selectMianfei';
            winUrl = './select_mianfei_win.html';
        }
        if(ret.buttonIndex == 2){
            winName = 'showMianfei';
            winUrl = './show_mianfei_win.html';
        }
        //alert(winName + winUrl + dingdanId);
        api.openWin({
            name: winName,
            url: winUrl,
            bounces: false,
            slidBackEnabled:false,
            pageParam: {
                'dingdanId':dingdanId,
                'roomHaoma':selectRoomName,
                'myId':myId,
                'myName':myName,
                'myTel':myTel
            }
        });
    });
}
function openYuyue(){
    api.actionSheet({
        destructiveTitle: '新建预约',
        buttons: ['查看预约列表']
    }, function(ret, err){
        if( ret ){
            //alert( JSON.stringify( ret ) );
            if(ret.buttonIndex == 1){
                api.openWin({
                    name: 'addYuyue',
                    url: './add_yuyue_win.html',
                    bounces: false,
                    slidBackEnabled:false,
                    pageParam: {key : 'value'}
                });
            }
            if(ret.buttonIndex == 2){
                api.openWin({
                    name: 'yuyueList',
                    url: './yuyue_list_win.html',
                    bounces: false,
                    slidBackEnabled:false,
                    pageParam: {key : 'value'}
                });
            }
        }else{
             //alert( JSON.stringify( err ) );
        }
    });
}
function openQingjia(){
    api.actionSheet({
        destructiveTitle: '休假申请',
        buttons: ['请假列表']
    }, function(ret, err) {
        if (ret) {
            if(ret.buttonIndex == 1){
                api.confirm({
                    msg: '确定要申请休假吗？',
                    buttons: ['确定', '取消']
                }, function(ret, err) {
                    if (ret) {
                        if(ret.buttonIndex == 1){
                            api.openWin({
                                name: 'addQingjia',
                                url: './add_qingjia_win.html',
                                pageParam: {
                                    userType: 0
                                }
                            });
                        }
                    }
                }); 
            }
            if(ret.buttonIndex == 2){
                api.openWin({
                    name: 'qingjiaHistroy',
                    url: './qingjia_histroy_win.html',
                    pageParam: {
                        userType: 0
                    }
                });
            }
        } 
    });
}
apiready = function(){
    companyId = $api.getStorage('companyId');
    jishiId = $api.getStorage('jishiId');
    jishiTel = $api.getStorage('userTel');
    myId = jishiId;
    myTel = jishiTel;
    myName = jishiPaihao = $api.getStorage('jishiPaihao');
    api.parseTapmode();
    buildButtons();
    checkShangzhong();
}
    
</script>
</html>