<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
</style>
<body>
    <div class="aui-content-padded icons">
        <div class="aui-grid-nine"  id="viewBox">

        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/laytpl.js" ></script>
<script type="text/javascript">
var dingdanId,jishiIdStr,jishiTichengStr,tichengJson,jishiJson;
var selectJishiId,selectJishiPaihao,selectJishiTicheng,selectJishiImgUrl,selectRoomHaoma,companyId,fuwuName;
var userId = $api.getStorage('userId');
var jishiStatus;
function selectJishi(jishiId,jishiPaihao,jishiImgUrl,jishiTel){
    //alert(selectRoomHaoma + '-' + companyId);
    //return false;
    selectJishiImgUrl = jishiImgUrl;
    selectJishiId = jishiId;
    selectJishiPaihao = jishiPaihao;
    selectJishiTicheng = tichengJson[jishiId];
    api.actionSheet({
        title: '选择技师',
        buttons: ['确定选择该技师']
    },function(ret,err){
        //alert(selectJishiTicheng +'-'+ selectJishiId + '-'+selectJishiPaihao);
        if(ret.buttonIndex == 1){
            api.ajax({
                url: appUrl+'Change/selectJishi',
                method: 'post',
                data: {
                    values: { 
                        jishi_id: jishiId,
                        jishi_paihao:jishiPaihao,
                        jishi_tel:jishiTel,
                        jishi_img_url:jishiImgUrl,
                        dingdan_id:dingdanId,
                        jingli_name:$api.getStorage('userName'),
                        jingli_tel:$api.getStorage('userTel'),
                        room_haoma:selectRoomHaoma,
                        company_id:companyId,
                        fuwu_name:fuwuName
                    },
                    files: { 
                        file: 'fs://a.gif'
                    }
                }
            },function(ret, err){
                if (ret) {
                    //alert( JSON.stringify( ret ) );
                    //return false;
                    api.sendEvent({
                        name: 'showJishiPaihao',
                        extra: {
                            'jishiId':selectJishiId,
                            'jishiTicheng':selectJishiTicheng,
                            'jishiPaihao':selectJishiPaihao,
                            'jishiImgUrl':selectJishiImgUrl,
                            'jishiTel':jishiTel
                        }
                    });
                    api.closeWin();
                } else {
                    alert( JSON.stringify( err ) );
                }
            });
            
        }
        
    });
    
}
function creatJson(){
    jishiIdArr = jishiIdStr.split(',');
    jishiTichengArr = jishiTichengStr.split(',');
    jsonStr = '{';
    for(var i = 0;i < jishiIdArr.length;i++){
        if(i != 0){
            jsonStr += ',';
        }
        jsonStr += '"'+jishiIdArr[i]+'":"'+jishiTichengArr[i]+'"';
    }
    jsonStr += '}';
    return JSON.parse(jsonStr);
}
function shuaxin(){
    api.setRefreshHeaderInfo({
        visible: true,
        loadingImg: 'widget://image/refresh.png',
        bgColor: '#ccc',
        textColor: '#fff',
        textDown: '下拉刷新...',
        textUp: '松开刷新...',
        showTime: true,
    }, function(ret, err){
        buildPageByJson(jishiStatus);
        //从服务器加载数据，完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
        api.refreshHeaderLoadDone();
    });
}
function buildPageByJson(jishiStatus){
    //alert(jishiIdStr);
    $api.html($api.byId('viewBox'), '<p style="margin-top:10px;" class="aui-text-center">加载数据中......</p>');
    api.ajax({
        url: appUrl+'Get/jishiJson',
        method: 'post',
        data: {
            values: { 
                jishi_id_str: jishiIdStr
            },
            files: { 
                file: 'fs://a.gif'
            }
        }
    },function(ret, err){
        if (ret) {
            var jishiJson = ret.jishi_data;
            var innerStr = '';
            var imgArr = new Array();
            var check = ret.check;
            if(check == 0){
                innerStr = '<p style="margin-top:10px;" class="aui-text-center">没有找到数据</p>';
            }else{
                for(var i = 0;i < jishiJson.length;i++){
                    var thisJishiJson = jishiJson[i];
                    var imgUrl;
                    if(thisJishiJson.jishi_touxiang_url == ''){
                        imgUrl = '../image/jishi.png';
                    }else{
                        imgUrl = ipUrl + thisJishiJson.jishi_touxiang_url;
                    }
                    imgArr[i] = imgUrl;
                    //alert(thisJishiJson);
                    var thisStr = '<li class="aui-col-xs-4 aui-text-center" tapmode onclick="selectJishi('+thisJishiJson.id+',\''+thisJishiJson.jishi_paihao+'\',\''+imgUrl+'\',\''+thisJishiJson.jishi_tel+'\')"><img style="width:80px;height:80px;border-radius: 50%;" src=""><p>'+thisJishiJson.jishi_paihao+'号</p></li>';
                    var thisStatus = thisJishiJson.jishi_status;
                    if(thisStatus == jishiStatus){
                        innerStr += thisStr;
                    }
                }
            }
            var viewBox = $api.byId('viewBox');
            $api.html(viewBox, innerStr);
            //闭包处理
            for(var j = 0;j<imgArr.length;j++){
                (function(j) {
                    var objIdName = 'img' + j;
                    //alert('1-'+objIdName)
                    var realImgUrl = imgArr[j];
                    api.imageCache({
                        url: realImgUrl
                    }, function(ret, err){
                        if( ret ){
                             var cacheUrl = ret.url;
                             $api.attr($api.byId(objIdName), 'src', cacheUrl);
                        }
                    });
                })(j);
            }
        } else {
            //alert( JSON.stringify( err ) );
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
function tichengStrToJson(jishiTichengStr){
    jishiTichengArr = jishiTichengStr.split(',');
    var jishiTichengJson = {};
    for(var i = 0; i < jishiTichengArr.length; i++){
        var thisJishiTichengStr = jishiTichengArr[i];
        var thisJishiTichengArr = thisJishiTichengStr.split(':');
        var thijishiId = thisJishiTichengArr[0];
        var thisJishiTicheng = thisJishiTichengArr[1];
        jishiTichengJson[thijishiId] = thisJishiTicheng;
    }
    //alert(JSON.stringify(jishiTichengJson));
    return jishiTichengJson;
}
apiready = function(){
    api.parseTapmode();
    companyId = $api.getStorage('companyId');
    dingdanId = api.pageParam.dingdanId;
    jishiIdStr = api.pageParam.jishiIdStr;
    fuwuName = api.pageParam.fuwuName;
    jishiTichengStr = api.pageParam.jishiTichengStr;
    selectRoomHaoma = api.pageParam.selectRoomHaoma;
    tichengJson = tichengStrToJson(jishiTichengStr);
    jishiStatus = 2;
    buildPageByJson(jishiStatus);
    shuaxin();
}
        
</script>
</html>