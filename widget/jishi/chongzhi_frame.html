<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
</head>
<style type="text/css">
body {
    height: auto;
}
.aui-content-padded {
    padding-top: 15px;
}
.aui-btn-block {
    margin-bottom: 15px;
}
.aui-nav{
    background-color: #3e6491;
    color: #ffffff;
    text-align: center;
    line-height: 50px;
}
</style>
<body>
    <p style="margin:10px 0px;" class="padded">请输入会员信息和充值信息</p>
    <div class="aui-content">       
        <div class="aui-form">
            <div class="aui-input-row">
                <span class="aui-input-addon">客户手机</span>
                <input type="number" class="aui-input" placeholder="手机号码" id="tel"/>
                <span class="aui-input-addon">
                    <div class="aui-btn" id="checkTel" status="1" tapmode onclick="checkTel()">验证手机</div>
                </span>
            </div>
            <div class="aui-hidden" id="chongzhiDetail">
                <div class="aui-input-row">
                    <span class="aui-input-addon">充值金额</span>
                    <input type="number" class="aui-input" placeholder="充值金额" id="chongzhiMoney"/>
                </div>
                <div class="aui-input-row">
                    <span class="aui-input-addon">是否赠送</span>
                    <input type="checkbox" class="aui-switch aui-pull-right" id="zengsongBtn" status="0" onclick="showZengsong(this)">
                </div>
                <div class="aui-hidden" id="zengsongList" style="padding-bottom: 55px;">
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="aui-nav yincang" id="aui-footer">
        <div class="aui-col-xs-12" id="saveBtn">
            <button class="aui-btn aui-btn-danger aui-btn-block" tapmode onclick="sendInfo()">提交充值信息</button>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/function.js" ></script>
<script type="text/javascript" src="../script/laytpl.js" ></script>
<script type="text/javascript">
var zengsongMoney = 0;
var yanzhengNum = 0;
var jingliId = $api.getStorage('userId');
var jingliName = $api.getStorage('userName');
var jingliTel = $api.getStorage('userTel');
var companyId = $api.getStorage('companyId');
var zengsongBtn = $api.byId('zengsongBtn');
var telBox = $api.byId('tel');
var chongzhiJson = $api.getStorage('cacheChongzhi');
var moneyBox = $api.byId('chongzhiMoney');
var chongzhiMoney;
var chongzhiStartMoney = 0;
var chongzhiZengsongMoney = 0;
var allMoney = 0;
var huiyuanId = 0;
var chongzhiTichengMoney = 0;
var huiyuanName = '';
//alert(JSON.stringify(chongzhiJson));
//alert($api.getStorage('cacheChongzhi'));
function buildZengsongList(){
    var innerHtml = '';
    var zengsongBox = $api.byId('zengsongList');
    for(key in chongzhiJson){
        //alert(key);
        //alert(chongzhiJson[key].id)
        var thisStr = '<div class="aui-input-row"><label class="aui-input-addon">充'+chongzhiJson[key].chongzhi_start_money+'，送'+chongzhiJson[key].chongzhi_youhui_money+'</label><input class="aui-pull-right aui-radio aui-radio-success" tapmode onclick="changeZengsongMoney('+chongzhiJson[key].chongzhi_start_money+','+chongzhiJson[key].chongzhi_youhui_money+','+chongzhiJson[key].chongzhi_ticheng_money+')" type="radio" name="zengsongMoney"></div>';
        innerHtml += thisStr;
    }
    $api.html(zengsongBox, innerHtml);
}
function checkTel(){
    var tel = $api.val(telBox);
    var canSend = 1;
    if(yanzhengNum == 1){
        api.toast({
            msg: '无需重复验证',
            duration: 2000,
            location: 'bottom'
        });
    }else{
        if(tel == ''){
            api.toast({
                msg: '还没有将输入客户手机号码',
                duration: 2000,
                location: 'bottom'
            });
            canSend = 0;
            return false;
        }
        if(tel.length != 11){
            api.toast({
                msg: '输入的11位号码',
                duration: 2000,
                location: 'bottom'
            });
            canSend = 0;
            return false;
        }
        var checkTel = parseInt(tel);
        if(checkTel < 10000000000){
            api.toast({
                msg: '输入号码有误',
                duration: 2000,
                location: 'bottom'
            });
            canSend = 0;
            return false;
        }
        if(canSend == 1){
            api.ajax({
                url: appUrl+'Get/checkHuiyuanTel',
                method: 'post',
                data: {
                    values: { 
                        company_id: $api.getStorage('companyId'),
                        huiyuan_tel:tel
                    },
                    files: { 
                        file: 'fs://a.gif'
                    }
                }
            },function(ret, err){
                if (ret) {
                    //alert( JSON.stringify( ret ) );
                    if(ret.check == 0){
                        api.toast({
                            msg: '没有找到该会员数据，请重新输入',
                            duration: 2000,
                            location: 'bottom'
                        });
                    }
                    if(ret.check == 1){
                        yanzhengNum = 1;
                        huiyuanId = ret.data.id;
                        huiyuanName = ret.data.huiyuan_name;
                        $api.attr(telBox, 'disabled', '');
                        $api.removeCls($api.byId('chongzhiDetail'), 'aui-hidden');
                        $api.html($api.byId('checkTel'), huiyuanName);
                        //alert(huiyuanId);
                    }
                } else {
                    api.toast({
                        msg: '网络错误',
                        duration: 2000,
                        location: 'bottom'
                    });
                }
            });
        }
    }
}
function changeZengsongMoney(startMoney,zengsongMoney,tichengMoeny){
    chongzhiStartMoney = startMoney;
    chongzhiZengsongMoney = zengsongMoney;
    chongzhiTichengMoney = tichengMoeny;
}
function showZengsong(){
    chongzhiMoney = $api.val(moneyBox);
    //alert(parseInt(chongzhiMoney))
    //return false;
    
    thisStatus = $api.attr(zengsongBtn, 'status');
        if(thisStatus == 0){
            $api.removeCls($api.byId('zengsongList'), 'aui-hidden');
            $api.attr(zengsongBtn, 'status',1);
        }else{
            $api.addCls($api.byId('zengsongList'), 'aui-hidden');
            $api.attr(zengsongBtn, 'status',0);
        }
    
}
function sendInfo(){
    var canSend = 1;
    if(huiyuanId == 0){
        api.toast({
            msg: '还没验证会员手机呢！亲~',
            duration: 2000,
            location: 'bottom'
        });
        canSend = 0;
        return false;
    }
    var tel = $api.val($api.byId('tel'));
    chongzhiMoney = parseInt($api.val($api.byId('chongzhiMoney')));
    var zengsongStatus = $api.attr(zengsongBtn, 'status');
    if($api.val($api.byId('chongzhiMoney')) == ''){
        api.toast({
            msg: '还没有输入充值金额',
            duration: 2000,
            location: 'bottom'
        });
        canSend = 0;
        return false;
    }
    
    if(isNaN(chongzhiMoney)){
        api.toast({
            msg: '输入的充值金额不正确',
            duration: 2000,
            location: 'bottom'
        });
        canSend = 0;
        return false;
    }
    if(zengsongStatus == 1){
        if(chongzhiZengsongMoney == 0){
            api.toast({
                msg: '你还没有选择赠送金额',
                duration: 2000,
                location: 'bottom'
            });
            canSend = 0;
            return false;
        }
        if(chongzhiStartMoney > chongzhiMoney){
            api.toast({
                msg: '你输入的金额小于赠送标准',
                duration: 2000,
                location: 'bottom'
            });
            canSend = 0;
            return false;
        }
        allMoney = chongzhiMoney + chongzhiZengsongMoney;
    }else{
        allMoney = chongzhiMoney;
    }
    if(canSend == 1){
        if(zengsongStatus == 1){
            var zengsongStr = '(赠送'+chongzhiZengsongMoney+'元)'
        }else{
            var zengsongStr = '';
        }
        api.confirm({
            title: '请确认充值信息',
            msg: '确认给'+huiyuanName+'('+tel+')充值：'+allMoney+'元'+zengsongStr+'吗？',
            buttons:['确定', '取消']
        },function(ret,err){
            if(ret.buttonIndex == 1){
                api.ajax({
                    url: appUrl+'Add/chongzhi',
                    method: 'post',
                    data: {
                        values: { 
                            chongzhi_money:chongzhiMoney,
                            zengsong_money:chongzhiZengsongMoney,
                            all_money:allMoney,
                            ticheng_money:chongzhiTichengMoney,
                            huiyuanka_id: huiyuanId,
                            huiyuan_tel:tel,
                            huiyuan_name:huiyuanName,
                            company_id:companyId,
                            jingli_id:jingliId,
                            jingli_name:jingliName,
                            jingli_tel:jingliTel,
                        },
                        files: { 
                            file: 'fs://a.gif'
                        }
                    }
                },function(ret, err){
                    if (ret) {
                        alert( JSON.stringify( ret ) );
                    } else {
                        alert( JSON.stringify( err ) );
                    }
                });
                api.alert({
                    title: '预充值成功', 
                    msg: '请前往前台支付并确认'
                });
                api.closeWin();
            }
        });
    }
}
apiready = function(){
    api.parseTapmode();
    buildZengsongList();
}
        
</script>
</html>