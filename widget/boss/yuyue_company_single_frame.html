<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div id="chartBox" class="aui-col-xs-12"; style="height:500px;">
        <div style="text-align: center;padding-top: 50px;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>读取数据中....</p>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript">
var headerHeight,frameHeight,buttonBoxHeight;
var isToday,showDate;
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var yuyueArr = new Array();
var jingliYuyueNum = jishiYuyueNum = querenNum =  allNum = 0;
function buildChart(){
    //querenNum = 79;
    //alert((parseFloat(querenNum / allNum) * 100).toFixed(2));
    var lv = (parseFloat(querenNum / allNum) * 100).toFixed(2);
    var chartBox = $api.byId('chartBox');
    var tongjiChart = echarts.init(chartBox);
    var option = {
                    title : {
                        text: '成功预约率'+lv+'%（'+querenNum+'/'+allNum+'）',
                        x:'left'
                    },
                    tooltip : {
                        trigger: 'item',
                        formatter: "{a} <br/>{b} : {c}单 ({d}%)"
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'right',
                        data: ['经理预约数','技师预约数']
                    },
                    color:['#e74c3c','#f1c40f','#2ecc71'],
                    series : [
                        {
                            name: '成功预约数',
                            type: 'pie',
                            radius : '55%',
                            center: ['50%', '60%'],
                            data:[
                                {value:jingliYuyueNum, name:'经理预约数'},
                                {value:jishiYuyueNum, name:'技师预约数'}
                            ],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
    tongjiChart.setOption(option, true);
}
function getChartData(){
    api.ajax({
        url: appUrl+'Get/todayYuyueByBoss',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                mission_day:showDate
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 0){
                $api.html($api.byId('chartBox'), '<li class="aui-list-view-cell aui-text-center">没有找到数据</li>');
            }else{
                yuyueArr = ret.data;
                allNum = yuyueArr.length;
                reBuildData();
            }  
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function reBuildData(){
    var canBuildChart = 0;
    for(var i = 0;i < allNum;i ++){
        var thisYuyue = yuyueArr[i];
        var thisStatus = parseInt(thisYuyue['status']);
        var thisYuyueType = thisYuyue['yuyue_type'];
        if(thisStatus == 1){
            if(thisYuyueType == 0){
                jingliYuyueNum ++;
            }
            if(thisYuyueType == 1){
                jishiYuyueNum ++;
            }
            querenNum ++;
        }
    }
    canBuildChart = 1;
    if(canBuildChart == 1){
        setTimeout("buildChart()",50);
    }
}
apiready = function(){
    api.parseTapmode();
    isToday = api.pageParam.isToday;
    if(isToday == 0){
        showDate = api.pageParam.showDate
    }else{
        showDate = $api.getStorage('missionDay');
    }
    getChartData();
}
    
</script>
</html>