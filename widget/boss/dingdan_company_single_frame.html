<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div id="chartBox" class="aui-col-xs-12"; style="height:500px;">
        <div style="text-align: center;padding-top: 50px;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>读取数据中....</p>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript">
var headerHeight,frameHeight,buttonBoxHeight;
var isToday,showDate;
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var dingdanArr = timeArr = new Array();
var dingdanNum =  0;
timeArr['time12'] = 0;
timeArr['time13'] = 0;
timeArr['time14'] = 0;
timeArr['time15'] = 0;
timeArr['time16'] = 0;
timeArr['time17'] = 0;
timeArr['time18'] = 0;
timeArr['time19'] = 0;
timeArr['time20'] = 0;
timeArr['time21'] = 0;
timeArr['time22'] = 0;
timeArr['time23'] = 0;
timeArr['time24'] = 0;
timeArr['time1'] = 0;
timeArr['time2'] = 0;
timeArr['time3'] = 0;
timeArr['time4'] = 0;
timeArr['time5'] = 0;
timeArr['time6'] = 0;
timeArr['time7'] = 0;
function buildChart(){
    var chartBox = $api.byId('chartBox');
    var tongjiChart = echarts.init(chartBox);
    var option = {
                    title: {
                        text: '客流量跟踪（共'+dingdanNum+'单）'
                    },
                    xAxis:  {
                        type: 'category',
                        boundaryGap: false,
                        data: ['12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '01', '02', '03', '04', '05', '06', '07']
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: '{value}单'
                        },
                        axisPointer: {
                            snap: true
                        }
                    },
                    visualMap: {
                        show: false,
                        dimension: 0,
                        pieces: [{
                            gt: 0,
                            lte: 2,
                            color: 'green'
                        },{
                            gt: 2,
                            lte: 5,
                            color: 'red'
                        },{
                            gt: 5,
                            lte: 8,
                            color: 'green'
                        },{
                            gt: 8,
                            lte: 12,
                            color: 'red'
                        },{
                            gt: 12,
                            lte: 20,
                            color: 'green'
                        }]
                    },
                    series: [
                        {
                            name:'客流量',
                            type:'line',
                            smooth: true,
                            data: [timeArr['time12'], timeArr['time13'], timeArr['time14'], timeArr['time15'], timeArr['time16'], timeArr['time17'], timeArr['time18'], timeArr['time19'], timeArr['time20'], timeArr['time21'], timeArr['time22'], timeArr['time23'], timeArr['time24'], timeArr['time1'], timeArr['time2'], timeArr['time3'], timeArr['time4'], timeArr['time5'], timeArr['time6'], timeArr['time7']],
                            markArea: {
                                data: [ [{
                                    name: '早高峰',
                                    xAxis: '14'
                                }, {
                                    xAxis: '17'
                                }], [{
                                    name: '晚高峰',
                                    xAxis: '20'
                                }, {
                                    xAxis: '24'
                                }] ]
                            }
                        }
                    ]
                };
    tongjiChart.setOption(option, true);
}
function getChartData(){
    api.ajax({
        url: appUrl+'Get/todayDingdanByBoss',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                mission_day:showDate
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 0){
                $api.html($api.byId('chartBox'), '<li class="aui-list-view-cell aui-text-center">没有找到数据</li>');
            }else{
                dingdanArr = ret.data;
                dingdanNum = dingdanArr.length;
                reBuildData();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function reBuildData(){
    var canBuildChart = 0;
    if(dingdanNum != 0){
        for(var i = 0;i < dingdanNum;i ++){
            var thisDingdan = dingdanArr[i];
            var thisDingdanTime = thisDingdan['shangzhong_time'];
            var thisHour = parseInt(thisDingdanTime.substring(11,13));
            if(thisHour == 0){
                var timeKey = 'time' + 24;
            }else{
                var timeKey = 'time' + thisHour;
            }
            timeArr[timeKey] ++;
        }
    }
    //alert(timeArr['time12']);
    canBuildChart = 1;
    if(canBuildChart == 1){
        setTimeout("buildChart()",50);
    }
}
apiready = function(){
    api.parseTapmode();
    isToday = api.pageParam.isToday;
    if(isToday == 0){
        showDate = api.pageParam.showDate
    }else{
        showDate = $api.getStorage('missionDay');
    }
    getChartData();
}
    
</script>
</html>