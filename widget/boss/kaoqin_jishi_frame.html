<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui-accordion.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui-slide.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div class="aui-card" id="showBox" style="padding:10px;">
        <div style="text-align: center;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>读取数据中....</p>
        </div>
    </div>
    <div class="aui-card" id="showBox">
        <ul class="aui-list-view">
            <li class="aui-list-view-cell aui-fold">
                <div class="aui-arrow-right aui-text-danger" id="boxTitle">点击查看详情</div>
                <div class="aui-fold-content">
                    <ul class="aui-list-view" id="detailBox">
                        
                    </ul>
                </div>
            </li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript" src="../script/aui-accordion.js"></script>
<script type="text/javascript" src="../script/aui-tap.js" ></script>
<script type="text/javascript" src="../script/aui-slide.js"></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript">
var headerHeight,frameHeight,buttonBoxHeight;
var kaoqinStatus,banciId,banciName,banciUserIdStr,isToday,showDate,kaoqinStr,noStr,badStr;
var jishiArr = new Array();
var kaoqinArr = new Array();
var kaoqinHas;
var jishiShowStr;
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var fold = new auiAccordion({
    callback:loadCallBack
});
function loadCallBack (event) {
    if(event.currentTarget.getAttribute("data") && event.currentTarget.getAttribute("data") == 'slide'){
        var slide = new auiSlide({
            container:document.getElementById("aui-slide"),
            // "width":300,
            "height":240,
            "speed":500,
            autoPlay: 0, //自动播放
            "pageShow":true,
            "pageStyle":'dot',
            'dotPosition':'center'
        })
    }
}
function getJishi(){
    api.ajax({
        url: appUrl+'Get/jishiKaoqinTodayByBoss',
        method: 'post',
        data: {
            values: { 
                company_id:companyId,
                mission_day:showDate,
                kaoqin_status:kaoqinStatus,
                banci_id:banciId,
                banci_user_id_str:banciUserIdStr
            }
        }
    }, function(ret, err) {
        if (ret) {
            jishiArr = ret.jishi_data;
            if(ret.kaoqin_has == 1){
                kaoqinArr = ret.kaoqin_data;
                kaoqinHas = 1
            }else{
                kaoqinHas = 0;
            }
            setTimeout("buildPage()",400);
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function buildPage(){
    if(banciId == 0){
        jishiShowStr = '<p>全部的技师有</p><p>';
        var boxTitleStr = '查看全部技师'+kaoqinStr+'详情';
    }else{
        jishiShowStr = '<p>'+banciName+'的技师有</p><p>';
        var boxTitleStr = '查看'+banciName+'详情'
    }
    
    var jishiStr = '';
    var zhengchangNum = noNum = badNum = 0;
    var jishiNum = jishiArr.length;
    var hasKaoqinNum = kaoqinArr.length;
    var hasKaoqinIdStr = '';
    var kaoqinDetailStr = '';
    var zhengchangKaoqinIdStr = '';
    for(var i = 0;i < hasKaoqinNum;i++){
        var kaoqinJishi = kaoqinArr[i];
        var kaoqinJishiId = kaoqinJishi['user_id'];
        var kaoqinJishiName = kaoqinJishi['user_name']+'号';
        var kaoqinJishiTel = kaoqinJishi['user_tel'];
        var kaoqinJishiZhengchang = kaoqinJishi['zhengchang'];
        var kaoqinJishiKaoqinTime = kaoqinJishi['kaoqin_time'];
        kaoqinJishiKaoqinTime = kaoqinJishiKaoqinTime.substring(11,16);
        if(hasKaoqinIdStr == ''){
            hasKaoqinIdStr =  'jishi' + kaoqinJishiId;
        }else{
            hasKaoqinIdStr += ',jishi' + kaoqinJishiId;
        }
        if(kaoqinJishiZhengchang == 1){
            if(zhengchangKaoqinIdStr == ''){
                zhengchangKaoqinIdStr = 'jishi' + kaoqinJishiId;
            }else{
                zhengchangKaoqinIdStr += ',jishi' + kaoqinJishiId;
            }
            var statusStr = '正常';
            var statusColor = 'success';
        }else{
            var statusStr = badStr;
            var statusColor = 'danger';
        }
        kaoqinDetailStr += '<li class="aui-list-view-cell"><a>'+kaoqinJishiName+'('+kaoqinJishiTel+')<span class="aui-badge aui-badge-'+statusColor+'">'+statusStr+'('+kaoqinJishiKaoqinTime+')</span></a></li>';
    }

    for(var j = 0;j < jishiNum;j++){
        var thisJishi = jishiArr[j];
        var thisJishiId = thisJishi['id'];
        var thisJishiName = thisJishi['jishi_paihao']+'号';
        var thisJishiTel = thisJishi['user_tel'];
        var checkKaoqin = 0;
        var checkZhengchang = 0;
        hasKaoqinCheckArr = hasKaoqinIdStr.split('jishi'+thisJishiId);
        if(hasKaoqinCheckArr.length > 1){
            checkKaoqin = 1;
        }
        //alert(hasKaoqinIdStr +':jishi' + thisJishiId + hasKaoqinCheckArr.length + checkKaoqin);
        zhengchangCheckArr = zhengchangKaoqinIdStr.split('jishi'+thisJishiId);

        if(zhengchangCheckArr.length > 1){
            checkZhengchang = 1;
        }
        //alert(zhengchangKaoqinIdStr + ':' + 'jishi' + thisJishiId + zhengchangCheckArr.length + checkZhengchang)
        if(kaoqinHas == 0){
            if(jishiStr == ''){
                jishiStr = '<b style="color:red">'+thisJishiName+'</b>';
            }else{
                jishiStr += '，<b style="color:red">'+thisJishiName+'</b>';
            }
        }else{
            if(checkKaoqin == 1){
                if(checkZhengchang == 1){
                    if(jishiStr == ''){
                        jishiStr = '<b style="color:green">'+thisJishiName+'</b>';
                    }else{
                        jishiStr += '，<b style="color:green">'+thisJishiName+'</b>';
                    }
                    zhengchangNum++;
                }else{
                    if(jishiStr == ''){
                        jishiStr = '<b style="color:red">'+thisJishiName+'</b>';
                    }else{
                        jishiStr += '，<b style="color:red">'+thisJishiName+'</b>';
                    }
                    badNum++;
                }
            }else{
                if(jishiStr == ''){
                    jishiStr = '<b style="color:blue">'+thisJishiName+'</b>';
                }else{
                    jishiStr += '，<b style="color:blue">'+thisJishiName+'</b>';
                }
                noNum++;
            }
        }   
    }
    jishiShowStr += jishiStr + '</p>';
    jishiShowStr += '<p><b style="color:black">共'+jishiNum+'名</b>，<span style="color:green">正常'+kaoqinStr+zhengchangNum+'人</span>，<span style="color:blue">'+noStr+noNum+'人</span>，<span style="color:red">'+badStr+badNum+'人<span></p>';
    $api.html($api.byId('showBox'), jishiShowStr);
    $api.html($api.byId('detailBox'),kaoqinDetailStr);
    $api.html($api.byId('boxTitle'),boxTitleStr);
}
apiready = function(){
    api.parseTapmode();
    kaoqinStatus = parseInt(api.pageParam.kaoqinStatus);
    if(kaoqinStatus == 1){
        kaoqinStr = '上班';
        noStr = '未到';
        badStr = '迟到';
    }
    if(kaoqinStatus == 9){
        kaoqinStr = '下班';
        noStr = '未扫码';
        badStr = '早退';
    }
    banciId = api.pageParam.banciId;
    banciName = api.pageParam.banciName;
    //alert(banciName);
    banciUserIdStr = api.pageParam.banciUserIdStr;
    isToday = api.pageParam.isToday;
    if(isToday == 0){
        showDate = api.pageParam.showDate;
    }else{
        showDate = missionDay;
    }
    //alert(companyId + showDate + kaoqinStatus + banciId + banciUserIdStr);
    getJishi();
}
    
</script>
</html>