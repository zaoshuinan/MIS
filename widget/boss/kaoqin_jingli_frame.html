<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui-accordion.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui-slide.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div class="aui-card" id="showBox" style="padding:10px;">
        <div style="text-align: center;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>读取数据中....</p>
        </div>
    </div>
    <div class="aui-card" id="showBox">
        <ul class="aui-list-view">
            <li class="aui-list-view-cell aui-fold">
                <div class="aui-arrow-right aui-text-danger" id="boxTitle">点击查看详情</div>
                <div class="aui-fold-content">
                    <ul class="aui-list-view" id="detailBox">
                        
                    </ul>
                </div>
            </li>
        </ul>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript" src="../script/aui-accordion.js"></script>
<script type="text/javascript" src="../script/aui-tap.js" ></script>
<script type="text/javascript" src="../script/aui-slide.js"></script>
<script type="text/javascript">
var headerHeight,frameHeight,buttonBoxHeight;
var kaoqinStatus,banciId,banciName,banciUserIdStr,isToday,showDate,kaoqinStr,noStr,badStr;
var jingliArr = new Array();
var kaoqinArr = new Array();
var kaoqinHas;
var jingliShowStr;
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var fold = new auiAccordion({
    callback:loadCallBack
});
function loadCallBack (event) {
    if(event.currentTarget.getAttribute("data") && event.currentTarget.getAttribute("data") == 'slide'){
        var slide = new auiSlide({
            container:document.getElementById("aui-slide"),
            // "width":300,
            "height":240,
            "speed":500,
            autoPlay: 0, //自动播放
            "pageShow":true,
            "pageStyle":'dot',
            'dotPosition':'center'
        })
    }
}
function getJingli(){
    api.ajax({
        url: appUrl+'Get/jingliKaoqinTodayByBoss',
        method: 'post',
        data: {
            values: { 
                company_id:companyId,
                mission_day:showDate,
                kaoqin_status:kaoqinStatus,
                banci_id:banciId,
                banci_user_id_str:banciUserIdStr
            }
        }
    }, function(ret, err) {
        if (ret) {
            jingliArr = ret.jingli_data;
            if(ret.kaoqin_has == 1){
                kaoqinArr = ret.kaoqin_data;
                kaoqinHas = 1
            }else{
                kaoqinHas = 0;
            }
            setTimeout("buildPage()",400);
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function buildPage(){
    if(banciId == 0){
        jingliShowStr = '<p>全部的经理有</p><p>';
        var boxTitleStr = '查看全部经理'+kaoqinStr+'详情';
    }else{
        jingliShowStr = '<p>'+banciName+'的经理有</p><p>';
        var boxTitleStr = '查看'+banciName+'详情'
    }
    
    var jingliStr = '';
    var zhengchangNum = noNum = badNum = 0;
    var jingliNum = jingliArr.length;
    var hasKaoqinNum = kaoqinArr.length;
    var hasKaoqinIdStr = '';
    var kaoqinDetailStr = '';
    var zhengchangKaoqinIdStr = '';
    for(var i = 0;i < hasKaoqinNum;i++){
        var kaoqinJingli = kaoqinArr[i];
        var kaoqinJingliId = kaoqinJingli['user_id'];
        var kaoqinJingliName = kaoqinJingli['user_name'];
        var kaoqinJingliTel = kaoqinJingli['user_tel'];
        var kaoqinJingliZhengchang = kaoqinJingli['zhengchang'];
        var kaoqinJingliKaoqinTime = kaoqinJingli['kaoqin_time'];
        kaoqinJingliKaoqinTime = kaoqinJingliKaoqinTime.substring(11,16);
        if(hasKaoqinIdStr == ''){
            hasKaoqinIdStr =  'jingli' + kaoqinJingliId;
        }else{
            hasKaoqinIdStr += ',jingli' + kaoqinJingliId;
        }
        if(kaoqinJingliZhengchang == 1){
            if(zhengchangKaoqinIdStr == ''){
                zhengchangKaoqinIdStr = 'jingli' + kaoqinJingliId;
            }else{
                zhengchangKaoqinIdStr += ',jingli' + kaoqinJingliId;
            }
            var statusStr = '正常';
            var statusColor = 'success';
        }else{
            var statusStr = badStr;
            var statusColor = 'danger';
        }
        kaoqinDetailStr += '<li class="aui-list-view-cell"><a>'+kaoqinJingliName+'('+kaoqinJingliTel+')<span class="aui-badge aui-badge-'+statusColor+'">'+statusStr+'('+kaoqinJingliKaoqinTime+')</span></a></li>';
    }

    for(var j = 0;j < jingliNum;j++){
        var thisJingli = jingliArr[j];
        var thisJingliId = thisJingli['id'];
        var thisJingliName = thisJingli['user_name'];
        var thisJingliTel = thisJingli['user_tel'];
        var checkKaoqin = 0;
        var checkZhengchang = 0;
        hasKaoqinCheckArr = hasKaoqinIdStr.split('jingli'+thisJingliId);
        if(hasKaoqinCheckArr.length > 1){
            checkKaoqin = 1;
        }
        zhengchangCheckArr = zhengchangKaoqinIdStr.split('jingli'+thisJingliId);
        if(zhengchangCheckArr.length > 1){
            checkZhengchang = 1;
        }
        if(kaoqinHas == 0){
            if(jingliStr == ''){
                jingliStr = '<b style="color:red">'+thisJingliName+'</b>';
            }else{
                jingliStr += '，<b style="color:red">'+thisJingliName+'</b>';
            }
        }else{
            if(checkKaoqin == 1){
                if(checkZhengchang == 1){
                    if(jingliStr == ''){
                        jingliStr = '<b style="color:green">'+thisJingliName+'</b>';
                    }else{
                        jingliStr += '，<b style="color:green">'+thisJingliName+'</b>';
                    }
                    zhengchangNum++;
                }else{
                    if(jingliStr == ''){
                        jingliStr = '<b style="color:red">'+thisJingliName+'</b>';
                    }else{
                        jingliStr += '，<b style="color:red">'+thisJingliName+'</b>';
                    }
                    badNum++;
                }
            }else{
                if(jingliStr == ''){
                    jingliStr = '<b style="color:blue">'+thisJingliName+'</b>';
                }else{
                    jingliStr += '，<b style="color:blue">'+thisJingliName+'</b>';
                }
                noNum++;
            }
        }   
    }
    jingliShowStr += jingliStr + '</p>';
    jingliShowStr += '<p><b style="color:black">共'+jingliNum+'名</b>，<span style="color:green">正常'+kaoqinStr+zhengchangNum+'人</span>，<span style="color:blue">'+noStr+noNum+'人</span>，<span style="color:red">'+badStr+badNum+'人<span></p>';
    
    $api.html($api.byId('showBox'), jingliShowStr);
    $api.html($api.byId('detailBox'),kaoqinDetailStr);
    $api.html($api.byId('boxTitle'),boxTitleStr);
}
apiready = function(){
    api.parseTapmode();
    kaoqinStatus = parseInt(api.pageParam.kaoqinStatus);
    if(kaoqinStatus == 1){
        kaoqinStr = '上班';
        noStr = '未到';
        badStr = '迟到';
    }
    if(kaoqinStatus == 9){
        kaoqinStr = '下班';
        noStr = '未扫码';
        badStr = '早退';
    }
    banciId = api.pageParam.banciId;
    banciName = api.pageParam.banciName;
    //alert(banciName);
    banciUserIdStr = api.pageParam.banciUserIdStr;
    isToday = api.pageParam.isToday;
    if(isToday == 0){
        showDate = api.pageParam.showDate;
    }else{
        showDate = missionDay;
    }
    //alert(companyId + showDate + kaoqinStatus + banciId + banciUserIdStr);
    getJingli();
}
    
</script>
</html>