<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div id="chartBox" class="aui-col-xs-12"; style="height:500px;">
        <div style="text-align: center;padding-top: 50px;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>读取数据中....</p>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript">
var headerHeight,frameHeight,buttonBoxHeight;
var isToday,showDate;
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var shouyinArr = chongzhiArr = maizhongArr = new Array();
var shouyinNum = chongzhiNum = maizhongNum = 0;
var chongzhiMoney = shouyinMoney  = maizhongMoney = jingliMaizhongMoney = jishiMaizhongMoney = allMoney = zengsongMoney = youhuiMoney = jiazhongMoney = 0;
function buildChart(){
    var chartBox = $api.byId('chartBox');
    var tongjiChart = echarts.init(chartBox);
    var option = {
                    title: {
                        text: '公司收入及组成（共'+allMoney+'元）'
                    },
                    color: ['#d81e06'],
                    tooltip : {
                        trigger: 'axis',
                        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        },
                        formatter: function (params) {
                            var tar = params[1];
                            return tar.name + '<br/>' + tar.seriesName + ' : ' + tar.value + '元';
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type : 'category',
                        splitLine: {show:false},
                        data : ['总收入','服务','充值','买钟']
                    },
                    yAxis: {
                        type : 'value'
                    },
                    series: [
                        {
                            name: '辅助',
                            type: 'bar',
                            stack:  '总量',
                            itemStyle: {
                                normal: {
                                    barBorderColor: 'rgba(0,0,0,0)',
                                    color: 'rgba(0,0,0,0)'
                                },
                                emphasis: {
                                    barBorderColor: 'rgba(0,0,0,0)',
                                    color: 'rgba(0,0,0,0)'
                                }
                            },
                            data: [0,(allMoney - shouyinMoney),(allMoney - shouyinMoney - chongzhiMoney),0]
                        },
                        {
                            name: '入账',
                            type: 'bar',
                            stack: '总量',
                            label: {
                                normal: {
                                    show: true,
                                    position: 'inside'
                                }
                            },
                            data:[allMoney,shouyinMoney,chongzhiMoney,maizhongMoney]
                        }
                    ]
                };
    tongjiChart.setOption(option, true);
}
function getChartData(){
    api.ajax({
        url: appUrl+'Get/todayShouruByBoss',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                mission_day:showDate
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 0){
                $api.html($api.byId('chartBox'), '<li class="aui-list-view-cell aui-text-center">没有找到数据</li>');
            }else{
                if(ret.has_shouyin == 1){
                    shouyinArr = ret.shouyin_data;
                    shouyinNum = shouyinArr.length;
                }
                if(ret.has_chongzhi == 1){
                    chongzhiArr = ret.chongzhi_data;
                    chongzhiNum = chongzhiArr.length;
                }
                if(ret.has_maizhong == 1){
                    maizhongArr = ret.maizhong_data;
                    maizhongNum = maizhongArr.length;
                }
                reBuildData();
            }  
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function reBuildData(){
    var canBuildChart = 0;
    if(shouyinNum != 0){
        for(var i = 0;i < shouyinNum;i ++){
            var thisShouyin = shouyinArr[i];
            var thisShishouMoney = parseFloat(thisShouyin['shishou_money']);
            shouyinMoney += thisShishouMoney;
        }
    }
    if(chongzhiNum != 0){
        for(var j = 0;j < chongzhiNum;j ++){
            var thisChongzhi = chongzhiArr[j];
            var thisChongzhiMoney = parseFloat(thisChongzhi['chongzhi_money']);
            var thisZengsongMoney = parseFloat(thisChongzhi['zengsong_money']);
            chongzhiMoney += thisChongzhiMoney;
            zengsongMoney += thisZengsongMoney;
        }
    }
    if(maizhongNum != 0){
        for(var k = 0;k < maizhongNum;k ++){
            var thisMaizhong = maizhongArr[k];
            var thisMaizhongType = parseFloat(thisMaizhong['maizhong_type']);
            var thisMaizhongMoney = parseFloat(thisMaizhong['all_money']);
            if(thisMaizhongType == 1){
                jishiMaizhongMoney += thisMaizhongMoney;
            }
            if(thisMaizhongType == 2){
                jingliMaizhongMoney += thisMaizhongMoney;
            }
            maizhongMoney += thisMaizhongMoney;
        }
    }
    allMoney = maizhongMoney + chongzhiMoney  + shouyinMoney;
    canBuildChart = 1;
    if(canBuildChart == 1){
        setTimeout("buildChart()",50);
    }
}
apiready = function(){
    isToday = api.pageParam.isToday;
    if(isToday == 0){
        showDate = api.pageParam.showDate
    }else{
        showDate = $api.getStorage('missionDay');
    }
    api.parseTapmode();
    getChartData();
}  
</script>
</html>