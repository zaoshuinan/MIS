<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/loading.css" />
</head>
<body>
    <div id="chartBox" class="aui-col-xs-12"; style="height:500px;">
        <div style="text-align: center;padding-top: 50px;">
            <div class="loading-2">
                <i></i>
                <i></i>
                <i></i>
                <i></i>
                <i></i>
            </div>
            <p>读取数据中....</p>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js" ></script>
<script type="text/javascript" src="../script/echarts.min.js" ></script>
<script type="text/javascript">
var headerHeight,frameHeight,buttonBoxHeight;
var isToday,showDate;
var missionDay = $api.getStorage('missionDay');
var companyId = $api.getStorage('companyId');
var jingliLiushuiArr = jishiLiushuiArr = chongzhiArr = yuyueArr = shoufeiArr = peitaoArr = jingliTongjiArr = jishiTongjiArr = new Array();
var jingliLiushuiNum = jishiLiushuiNum = chongzhiNum = yuyueNum = shoufeiNum = peitaoNum = jingliTongjiNum = jishiTongjiNum =  0;
var jingliTichengMoney = jishiTichengMoney = jingliChongzhiMoney = jingliYuyueMoney = jingliShoufeiMoney = jishiYuyueMoney = jishiShoufeiMoney = jishiPeitaoMoney = jingliAllMoney = jishiAllMoney = allMoney = 0;
function buildChart(){
    if(isToday == 0){
        var titleStr = '公司支出及组成（'+allMoney+'元）';
    }else{
        var titleStr = '公司支出及组成（不包含扣除部分）';
    } 
    var chartBox = $api.byId('chartBox');
    var tongjiChart = echarts.init(chartBox);
    var option = {
                    title: {
                        text: titleStr
                    },
                    color: ['#1296db'],
                    tooltip : {
                        trigger: 'axis',
                        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        },
                        formatter: function (params) {
                            var tar = params[1];
                            return tar.name + '<br/>' + tar.seriesName + ' : ' + tar.value + '元';
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type : 'category',
                        splitLine: {show:false},
                        data : ['总支出','经理实际提成','技师实际提成']
                    },
                    yAxis: {
                        type : 'value'
                    },
                    series: [
                        {
                            name: '辅助',
                            type: 'bar',
                            stack:  '总量',
                            itemStyle: {
                                normal: {
                                    barBorderColor: 'rgba(0,0,0,0)',
                                    color: 'rgba(0,0,0,0)'
                                },
                                emphasis: {
                                    barBorderColor: 'rgba(0,0,0,0)',
                                    color: 'rgba(0,0,0,0)'
                                }
                            },
                            data: [0,(allMoney - jingliAllMoney),0]
                        },
                        {
                            name: '支出',
                            type: 'bar',
                            stack: '总量',
                            label: {
                                normal: {
                                    show: true,
                                    position: 'inside'
                                }
                            },
                            data:[allMoney,jingliAllMoney,jishiAllMoney]
                        }
                    ]
                };

    tongjiChart.setOption(option, true);
}
function getChartTodayData(){
    api.ajax({
        url: appUrl+'Get/todayZhichuByBoss',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                mission_day:missionDay
            }
        }
    }, function(ret, err) {
        if (ret) {
            if(ret.has == 0){
                $api.html($api.byId('chartBox'), '<li class="aui-list-view-cell aui-text-center">没有找到数据</li>');
            }else{
                if(ret.has_jingli_liushui == 1){
                    jingliLiushuiArr = ret.jingli_liushui_data;
                    jingliLiushuiNum = jingliLiushuiArr.length;
                }
                if(ret.has_jishi_liushui == 1){
                    jishiLiushuiArr = ret.jishi_liushui_data;
                    jishiLiushuiNum = jishiLiushuiArr.length;
                }
                if(ret.has_chongzhi == 1){
                    chongzhiArr = ret.chongzhi_data;
                    chongzhiNum = chongzhiArr.length;
                }
                if(ret.has_shoufei == 1){
                    shoufeiArr = ret.shoufei_data;
                    shoufeiNum = shoufeiArr.length;
                }
                if(ret.has_yuyue == 1){
                    yuyueArr = ret.yuyue_data;
                    yuyueNum = yuyueArr.length;
                }
                reBuildTodayData();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function reBuildTodayData(){
    var canBuildChart = 0;
    if(jingliLiushuiNum != 0){
        for(var i = 0;i < jingliLiushuiNum;i ++){
            var thisJingliLiushui = jingliLiushuiArr[i];
            var thisJingliTicheng = parseFloat(thisJingliLiushui['ticheng']);
            jingliTichengMoney += thisJingliTicheng;
        }
    }
    if(jishiLiushuiNum != 0){
        for(var j = 0;j < jishiLiushuiNum;j ++){
            var thisJishiLiushui = jishiLiushuiArr[j];
            var thisJishiTicheng = parseFloat(thisJishiLiushui['ticheng']);
            var thisJishiJiazhongTicheng = parseFloat(thisJishiLiushui['jiazhong_ticheng']);
            jishiTichengMoney += thisJishiTicheng + thisJishiJiazhongTicheng;
        }
    }
    if(chongzhiNum != 0){
        for(var k = 0;k < chongzhiNum;k++){
            var thisChongzhi = chongzhiArr[k];
            var thisChongzhiTicheng = parseFloat(thisChongzhi['ticheng_money']);
            jingliChongzhiMoney += thisChongzhiTicheng;
        }
    }
    if(shoufeiNum !=0){
        for(var l = 0;l < shoufeiNum;l++){
            var thisShoufei = shoufeiArr[l];
            var thisShoufeiTicheng = parseFloat(thisShoufei['chanpin_ticheng']);
            var thisShoufeiType = thisShoufei['yewu_type'];
            if(thisShoufeiType == "1"){
                jingliShoufeiMoney += parseFloat(thisShoufeiTicheng);
            }else{
                jishiShoufeiMoney += parseFloat(thisShoufeiTicheng);
            }
        }
    }
    if(yuyueNum !=0){
        for(var m = 0;m < yuyueNum;m++){
            var thisYuyue = yuyueArr[m];
            var thisYuyueType = thisYuyue['yuyue_type'];
            var thisYuyueTicheng = thisYuyue['ticheng'];
            if(thisYuyueType == 0){
                jingliYuyueMoney += parseFloat(thisYuyueTicheng);
            }else{
                jishiYuyueMoney += parseFloat(thisYuyueTicheng);
            }
        }
    }
    if(peitaoNum != 0){
        for(var n = 0;n < peitaoNum;m++){
            var thisPeitao = peitaoArr[n];
            var thisPeitaoTicheng = thisPeitao['peitao_ticheng'];
            jishiPeitaoMoney += thisPeitaoTicheng;
        }
    }
    jingliAllMoney = jingliTichengMoney+ jingliYuyueMoney+ jingliShoufeiMoney + jingliChongzhiMoney  ;
    jishiAllMoney = jishiTichengMoney + jishiYuyueMoney + jishiShoufeiMoney + jishiPeitaoMoney;
    allMoney = jishiAllMoney + jingliAllMoney;
    canBuildChart = 1;
    if(canBuildChart == 1){
        setTimeout("buildChart()",50);
    }
}
function getChartSingleData(){
    api.ajax({
        url: appUrl+'Get/singleZhichuByBoss',
        method: 'post',
        data: {
            values: { 
                company_id: companyId,
                mission_day:showDate
            }
        }
    }, function(ret, err) {
        //alert(JSON.stringify(ret))
        if (ret) {
            if(ret.has == 0){
                $api.html($api.byId('chartBox'), '<li class="aui-list-view-cell aui-text-center">没有找到数据</li>');
            }else{
                if(ret.has_jingli_tongji == 1){
                    jingliTongjiArr = ret.jingli_tongji_data;
                    jingliTongjiNum = jingliTongjiArr.length;
                }
                if(ret.has_jishi_tongji == 1){
                    jishiTongjiArr = ret.jishi_tongji_data;
                    jishiTongjiNum = jishiTongjiArr.length;
                }
                reBuildSingleData();
            }
        } else {
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function reBuildSingleData(){
    var canBuildChart = 0;
    if(jingliTongjiNum != 0){
        for(var i = 0;i < jingliTongjiNum;i ++){
            var thisJingliTongji = jingliTongjiArr[i];
            var thisJingliTicheng = parseFloat(thisJingliTongji['shifa_all']);
            jingliTichengMoney += thisJingliTicheng;
        }
    }
    if(jishiTongjiNum != 0){
        for(var j = 0;j < jishiTongjiNum;j ++){
            var thisJishiTongji = jishiTongjiArr[j];
            var thisJishiTicheng = parseFloat(thisJishiTongji['shifa_all']);
            jishiTichengMoney += thisJishiTicheng;
        }
    }
    jingliAllMoney = jingliTichengMoney;
    jishiAllMoney = jishiTichengMoney;
    allMoney = jishiAllMoney + jingliAllMoney;
    canBuildChart = 1;
    if(canBuildChart == 1){
        setTimeout("buildChart()",50);
    }
}
apiready = function(){
    api.parseTapmode();
    isToday = api.pageParam.isToday;
    if(isToday == 0){
        showDate = api.pageParam.showDate;
        getChartSingleData();
    }else{
        showDate = $api.getStorage('missionDay');
        getChartTodayData();
    } 
}
    
</script>
</html>