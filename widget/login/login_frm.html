<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>APP</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style type="text/css">
    .aui-card {
        margin-top: 15px;
    }
    .aui-input-addon.aui-iconfont {
        font-size: 20px !important;
    }
    .aui-input-row {
        width: 100% !important;
    }
    </style>
</head>
<body>
    <div class="aui-content">       
        <div class="aui-form aui-card">
            <div class="aui-input-row">
                <i class="aui-input-addon aui-iconfont aui-icon-people aui-text-info"></i>
                <input type="number" id="user-tel" class="aui-input" placeholder="请输入电话号码"/>
            </div>

            <div class="aui-input-row">
                <i class="aui-input-addon aui-iconfont aui-icon-lock aui-text-warning"></i>
                <input type="password" id="password" class="aui-input" placeholder="请输入密码"/>
                <i class="aui-input-addon aui-iconfont aui-icon-attention aui-text-default" tapmode onclick="showPassword();" id="showpass-btn"></i>
            </div>
            <div class="aui-input-row">
                <i class="aui-input-addon aui-iconfont aui-icon-people aui-text-info"></i>
                <input type="number" id="companyHaoma" class="aui-input" placeholder="请输入7位公司代码"/>
            </div>
            <div class="aui-btn-row">
                <div class="aui-btn aui-btn-block aui-btn-danger" hasClick="0" id="loginBtn" onclick="login()">确认并登陆</div>
            </div>
        </div>
        <div class="aui-card" id="ceshiUser" style="padding:5px;">
            <div class="aui-btn aui-btn-info" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(0)">老板</div>
            <div class="aui-btn aui-btn-success" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(1)">经理1</div>
            <div class="aui-btn aui-btn-success" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(2)">经理2</div>
            <div class="aui-btn aui-btn-danger" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(3)">技师1</div>
            <div class="aui-btn aui-btn-danger" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(4)">技师2</div>
            <div class="aui-btn aui-btn-primary" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(5)">清洁</div>
            <div class="aui-btn aui-btn-primary" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(6)">配送</div>
            <div class="aui-btn aui-btn-warning" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(7)">前台</div>
            <div class="aui-btn aui-btn-warning" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(8)">钟房</div>
            <div class="aui-btn aui-btn-warning" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="userLogin(9)">其他</div>
        </div>
        <div class="aui-card" id="ceshiShebei" style="padding:5px;">
            <div class="aui-btn aui-btn-info" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="shebeiLogin(3)">前台设备</div>
            <div class="aui-btn aui-btn-success" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="shebeiLogin(0)">钟房设备</div>
            <div class="aui-btn aui-btn-primary" style="margin-top:4px;margin-bottom: 4px;" tapmode onclick="shebeiLogin(1)">配送设备</div>
        </div>
        <div class="aui-btn-row">
            <div class="aui-btn aui-btn-block aui-btn-warning" onclick="openTest()">系统测试界面</div>
        </div>
    </div>
    <div class="aui-toast" style="display:none" id="default">
        <i class="aui-iconfont aui-icon-check"></i>
        <div class="aui-toast-content">系统配置中</div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript" src="../script/mis.js"></script>
<script type="text/javascript">
var isinerval,times,shebeiId,userTel,userPassword,companyHaoma,loginType;
var loginCheck = 1;
var loginType = 0;
var shebeiTypeId = 9;
var uiMode;
function showDefault(){
    $api.css($api.byId("default"),"display:block");
    setTimeout(function(){
        $api.css($api.byId("default"),"display:none");
    },2000)
}
function openTestWin(){
    api.openWin({
        name: 'systemTest',
        url: './test_win.html',
        pageParam: {
            name: 'value'
        }
    });
}
function openTest(){
    companyHaoma = $api.val($api.byId('companyHaoma'));
    if(companyHaoma == ''){
        alert('请输入7位公司代码!');
        return false;
    }
    getCompanySystemIp(openTestWin);
}
function shebeiLogin(index){
    if(uiMode == 'phone'){
        alert('此行功能请使用平板演示');
        return false;
    }
    shebeiTypeId = index;
    var typeName;
    if(index == 0){
        typeName = '钟房设备';
    }
    if(index == 1){
        typeName = '配送设备';
    }
    if(index == 3){
        typeName = '前台设备';
    }
    loginType = 1;
    userTel = $api.val($api.byId('user-tel'),'0000000');
    userPassword = $api.val($api.byId('password'),'0000000');
    companyHaoma = $api.val($api.byId('companyHaoma'),companyHaoma);
    $api.html($api.byId('loginBtn'), typeName+'登陆');
}
function userLogin(index){
    if(uiMode != 'phone'){
        alert('此行功能只能在手机上演示');
        return false;
    }
    var testUserArr = [
        {
            tel:'18028681556',
            password:'leowang',
            name:'老板'
        },{
            tel:'18000001001',
            password:'123456',
            name:'经理1'
        },{
            tel:'18000001002',
            password:'123456',
            name:'经理2'
        },{
            tel:'18000000001',
            password:'123456',
            name:'技师1'
        },{
            tel:'18000000002',
            password:'123456',
            name:'技师2'
        },{
            tel:'17037465823',
            password:'123456',
            name:'清洁人员'
        },{
            tel:'18020002002',
            password:'123456',
            name:'配送人员'
        },{
            tel:'18010011004',
            password:'123456',
            name:'前台人员'
        },{
            tel:'18000000002',
            password:'123456',
            name:'钟房人员'
        },{
            tel:'18000100002',
            password:'123456',
            name:'其他人员'
        }
    ]
    var loginTel = testUserArr[index].tel; 
    var loginPassword = testUserArr[index].password;
    companyHaoma = '0200001';
    var typeName = testUserArr[index].name;
    loginType = 1;
    userTel = $api.val($api.byId('user-tel'),loginTel);
    userPassword = $api.val($api.byId('password'),loginPassword);
    companyHaoma = $api.val($api.byId('companyHaoma'),companyHaoma);
    $api.html($api.byId('loginBtn'), typeName+'登陆');
}
function login(){
    userTel = $api.val($api.byId('user-tel'));
    userPassword = $api.val($api.byId('password'));
    companyHaoma = $api.val($api.byId('companyHaoma'));
    if(userTel == '0000000' && userPassword == '0000000'){
        gotoHouqin();
    }else{
        gotoUser();
    }
}
function gotoHouqin(){
    api.ajax({
        url: getKehuUrl,
        method: 'post',
        data: {
            values: {
                kehu_haoma:companyHaoma
            }
        }
    },function(ret, err){
        if(ret){
            if(ret.has == 0){
                $api.attr($api.byId('loginBtn'), 'hasClick', '0');
                $api.html($api.byId('loginBtn'), '确认并登陆');
                $api.removeCls($api.byId('loginBtn'), 'aui-btn-info');
                $api.addCls($api.byId('loginBtn'), 'aui-btn-danger');
                alert('找不到该公司代码，请重新输入');
                return false;
            }else{
                var companyId = ret.data.id;
                $api.setStorage('companyId', companyId);
                var companyName = ret.data.kehu_name;
                ipUrl = 'http://'+ret.data.server_ip+'/';
                serverUrl = 'http://' + ret.data.server_url + '/';
                $api.setStorage('companySystemIp', ipUrl);
                $api.setStorage('companySystemUrl', serverUrl);
                api.openWin({
                    name: 'configHouqin',
                    url: '../houqin/index.html',
                    slidBackEnabled:false,
                    bounces: false,
                    pageParam: {
                        company_haoma: companyHaoma,
                        company_id:companyId,
                        company_name:companyName,
                        loginType:loginType,
                        shebeiTypeId:shebeiTypeId
                    },
                });
            }
        } else {
            api.toast({
                msg: '网络错误',
                duration: 2000,
                location: 'bottom'
            });
        }
    });
}
function gotoUser(){
    var hasClick = parseInt($api.attr($api.byId('loginBtn'), 'hasClick'));
    if(hasClick == 1){
        api.toast({
            msg: '正在登陆，请勿重复操作！'
        });
    }else{
        if(userTel == ''){
            alert('你没有输入用户密码');
            return false;
        }
        if(userTel.length != 11){
            alert('你输入的手机号码不是11位');
            return false
        }
        if(userPassword == ''){
            alert('你还没有输入密码');
            return false;
        }
        $api.attr($api.byId('loginBtn'), 'hasClick', '1');
        $api.html($api.byId('loginBtn'), '登陆中...');
        $api.removeCls($api.byId('loginBtn'), 'aui-btn-danger');
        $api.addCls($api.byId('loginBtn'), 'aui-btn-info');
        getCompanySystemIp(sendAndCheck);
    }
}
function getCompanySystemIp(fn){
    api.ajax({
        url: getKehuUrl,
        method: 'post',
        data: {
            values: {
                kehu_haoma:companyHaoma
            }
        }
    },function(ret, err){
        if (ret){
            if(ret.has == 0){
                $api.attr($api.byId('loginBtn'), 'hasClick', '0');
                $api.html($api.byId('loginBtn'), '确认并登陆');
                $api.removeCls($api.byId('loginBtn'), 'aui-btn-info');
                $api.addCls($api.byId('loginBtn'), 'aui-btn-danger');
                alert('找不到该公司代码，请重新输入');
                return false;
            }else{
                ipUrl = 'http://'+ret.data.server_ip+'/';
                serverUrl = 'http://' + ret.data.server_url + '/';
                $api.setStorage('companySystemIp', ipUrl);
                $api.setStorage('companySystemUrl', serverUrl);
                setTimeout(fn,300)
            }
        }else{
            api.toast({
                msg: '网络错误'
            });
        }
    });
}
function sendAndCheck(){
    api.ajax({
        url: appUrl+'Get/checkUser',
        method: 'post',
        data: {
            values: { 
                user_tel: userTel,
                real_password:userPassword,
                company_haoma:companyHaoma,
                shebei_id:shebeiId,
                login_type:loginType
            }
        }
    },function(ret, err){
        if (ret){
            if(ret.status == '6'){
                var cacheData = ret.cache_data;
                var userTypeId = ret.user_type;
                $api.setStorage('shebeiType', '9');
                $api.setStorage('companyHaoma', companyHaoma);
                $api.setStorage('userTel', userTel);
                $api.setStorage('userTouxiangUrl', ret.user_data.user_img_url);
                $api.setStorage('userPassword', ret.user_data.user_password);
                if(userTypeId == 9){
                    $api.setStorage('userId', ret.user_data.id);
                    $api.setStorage('jishiId', ret.jishi_data.id);
                    $api.setStorage('userName', ret.jishi_data.jishi_name);
                    $api.setStorage('jishiType', ret.jishi_data.jishi_type);
                    $api.setStorage('jishiPaihao', ret.jishi_data.jishi_paihao);
                }else{
                    $api.setStorage('userId', ret.user_data.id);
                    $api.setStorage('userName', ret.user_data.user_name);
                }
                $api.setStorage('shebeiId', shebeiId);
                setCache(userTypeId,cacheData);
            }else{
                $api.attr($api.byId('loginBtn'), 'hasClick', '0');
                $api.html($api.byId('loginBtn'), '确认并登陆');
                $api.removeCls($api.byId('loginBtn'), 'aui-btn-info');
                $api.addCls($api.byId('loginBtn'), 'aui-btn-danger');
                api.toast({
                    msg: ret.msg,
                    duration: 2000,
                    location: 'bottom'
                });
            }
        }else{
            //alert(JSON.stringify(err))
            api.toast({
                msg: '网络错误'
            });
        }

    });
}
function setCache(userTypeId,cacheData){
    //alert(JSON.stringify(userTypeJson));
    
    $api.attr($api.byId('loginBtn'), 'hasClick', '1');
    $api.html($api.byId('loginBtn'), '登陆成功');
    $api.removeCls($api.byId('loginBtn'), 'aui-btn-info');
    $api.addCls($api.byId('loginBtn'), 'aui-btn-success');

    var jumpUrl = userTypeJson[userTypeId].typeUrl;
    var openWinName = jumpUrl + '_win';
    var openUrl = '../' + jumpUrl + '/index.html';
    var cacheJishi = JSON.parse(cacheData.cache_jishi);
    var cacheRoom = JSON.parse(cacheData.cache_room);
    var cacheService = JSON.parse(cacheData.cache_service);
    var cacheBanci = JSON.parse(cacheData.cache_banci);
    var cacheChongzhi = JSON.parse(cacheData.cache_chongzhi);
    var cacheCompany = JSON.parse(cacheData.cache_company);
    var cacheMianfei = JSON.parse(cacheData.cache_mianfei);
    var cacheShoufei = JSON.parse(cacheData.cache_shoufei);
    var cacheCheckStr = cacheData.cache_check_str;
    var cachePeitao = JSON.parse(cacheData.cache_peitao);
    if($api.getStorage('cacheCheckStr') != cacheCheckStr){
        $api.setStorage('cacheCheckStr', cacheCheckStr);
        $api.setStorage('cachePeitao', cachePeitao);
        $api.setStorage('cacheJishi', cacheJishi);
        $api.setStorage('cacheRoom', cacheRoom);
        $api.setStorage('cacheService', cacheService);
        $api.setStorage('cacheBanci', cacheBanci);
        $api.setStorage('cacheCompany', cacheCompany);
        $api.setStorage('cacheChongzhi', cacheChongzhi);
        $api.setStorage('cacheMianfei', cacheMianfei);
        $api.setStorage('cacheShoufei', cacheShoufei);
    }
    $api.setStorage('companyId', cacheCompany.id);
    $api.setStorage('userType', userTypeId);
    $api.setStorage('userTypeName', userTypeJson[userTypeId].typeName);
    $api.setStorage('userTypeUrl', userTypeJson[userTypeId].typeUrl);
    $api.setStorage('hasLogin', '1');
    //alert(JSON.stringify(cacheData));
    alert('登陆成功，系统记录了你的设备并重启配置程序');
    setTimeout("reboot()",1000);
}
function reboot(){
    api.rebootApp();
}
function showPassword(){
    $api.attr($api.byId('password'),'type','text');
    $api.removeCls($api.byId('showpass-btn'),'aui-icon-attention');
    $api.addCls($api.byId('showpass-btn'),'aui-icon-attentionfill');
    $api.attr($api.byId('showpass-btn'),'onclick','hidePassword();');
    api.parseTapmode();
}
function hidePassword(){
    $api.attr($api.byId('password'),'type','password');
    $api.removeCls($api.byId('showpass-btn'),'aui-icon-attentionfill');
    $api.addCls($api.byId('showpass-btn'),'aui-icon-attention');
    $api.attr($api.byId('showpass-btn'),'onclick','showPassword();');
    api.parseTapmode();
}
apiready = function () {
    uiMode = api.uiMode;
    api.parseTapmode();
    shebeiId = api.deviceId;
    // var audio = api.require('audio');
    // audio.play({
    //     path: 'http://7xisq1.com1.z0.glb.clouddn.com/apicloud/0d0b81b8bd5ab81bda9ca54267eb9b98.mp3'
    // }, function(ret, err) {
    //     if (ret) {
    //         //alert(JSON.stringify(ret));
    //     } else {
    //         //alert(JSON.stringify(err));
    //     }
    // });
    // $api.val($api.byId('user-tel'),'18000000001');
    // $api.val($api.byId('password'),'123456');
    // $api.val($api.byId('companyHaoma'),'0200001');
}
</script>
</html>